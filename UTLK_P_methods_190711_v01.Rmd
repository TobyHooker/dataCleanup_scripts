---
title: "UTLK Phosphorus Methods review"
author: "T.Hooker"
date: "11 July, 2019"
output: 
    html_notebook:
      df_print: paged
      theme: flatly
      toc: yes
      toc_depth: 4
      toc_float: no
---
***
<center>
> ![](WaterQuality1_72dpi_2.png)  
</center>


***

**Project Root Path** :: 
`"U:\ENG_WQ\tobyhooker\DATA MANAGEMENT & QA\DATA.Projects\UtahLake_chemMethods\UTLK_DP_meth_r"`

```{r STARTUP}
#options(table_counter=FALSE)
tidy_package <- c("plyr", "dplyr", "tidyr", "magrittr", "htmlTable")
# suppressPackageStartupMessages(library("tidy"))
if(!"tidyr" %in% (.packages())) {invisible(lapply(tidy_package, function(x) suppressMessages(library(x, character.only=T, quietly = T, warn.conflicts = F))))}
##
graph_package <- c("ggplot2", "scales")
if(!"ggplot2" %in% (.packages())) {invisible(lapply(graph_package, library, character.only=T, quietly = T, warn.conflicts = F))}
##
options(scipen = 999, digits = 4, stringsAsFactors = FALSE, keep.source = TRUE)
##
# startwork.date <- format(Sys.Date(), "%y%m%d")
knitr::opts_chunk$set(cache=TRUE)
```


## 0.0 Notes

[190711] :: Utah Lake Science Panel posed question of what happened to DP methods or chemical-analysis approach b/w 1999-2007 vs. 2007-current, where an observed baseline of 10 ppb DP increased toward 30-40 ppb after 2007 (approximately).

Steps:  

1) Extract all P data from AWQMS from UTLK sites
2) Eval Meth-Params over time
3) Eval RLs over time

## 1.0 Data import

1) UTLK Sites

```{r}
## [2; paste vector from ClipBoard to DF / vector]
# readClipboard()-> utlk_sites
```

2) Use these sites to pull full Standard Export from AWQMS for all P-related parameters

Go to :  https://awqms.utah.gov/Homepage.aspx  
Login as: thooker // pw  
Navigate :

+ Metadata  
+ Monitoring Locations  
+ [select] Search  
+ [select] Export to Excel  
+ -complete-  

3) Import AWQMS data

```{r}
# file.01  <- choose.files(caption="Select _working_ DATA file [*.xlsx]", multi = FALSE)
data01 <- openxlsx::read.xlsx(file.01, sheet=1, startRow = 2,
                              rowNames=FALSE, check.names = T)
```

4) Cleanup and Tune

+ Sampling and Analysis Date/Time

```{r}
data01$Activity.Start.Date <- as.Date(data01$Activity.Start.Date, origin="1899-12-30")
data01$Analysis.Start.Date <- as.Date(data01$Analysis.Start.Date, origin="1899-12-30")
data01$Activity.Start.Time <- as.character(chron::times((data01$Activity.Start.Time - as.integer(data01$Activity.Start.Time))))
data01$Analysis.Start.Time <- as.character(chron::times((data01$Analysis.Start.Time - as.integer(data01$Analysis.Start.Time))))
```


+ Filename ::  `r basename(file.01)`
+ Path ::  `r dirname(file.01)`
+ Datafile has :: `r nrow(data01)` records & `r ncol(data01)` fields
+ Record Data Range :: From `r min(data01$Activity.Start.Date)` to `r max(data01$Activity.Start.Date)`
+ Record Sample-Time Range :: From [`r min(data01$Activity.Start.Time, na.rm=T)`] to [`r max(data01$Activity.Start.Time, na.rm=T)`]

### 1.1 Trim datafile

**Fields to Keep from AWQMS Standard Export**

```{r}
awqms_export_fields_tokeep <- c("Organization.ID","Activity.ID","Activity.Type","Activity.Media","Activity.Start.Date", "Activity.Start.Time", "Activity.Relative.Depth","Activity.Depth.Height","Activity.Depth.Height.Unit","Activity.Top.Depth.Height","Activity.Top.Depth.Height.Unit","Activity.Bottom.Depth.Height","Activity.Bottom.Depth.Height.Unit","Project.ID1","Project.ID2","Activity.Conducting.Organization1","Activity.Conducting.Organization2","Monitoring.Location.ID","Monitoring.Location.Name","Monitoring.Location.Type","Activity.Comment","Sample.Collection.Method.ID","Sample.Collection.Method.Context","Sample.Collection.Method.Name","Sample.Collection.Method.Description","Result.UID","Data.Logger.Line","Detection.Condition","Characteristic.Name","Method.Speciation","Sample.Fraction","Result.Value","Result.Unit","Result.Qualifier","Result.Status","Value.Type","Time.Basis","Temperature.Basis","Result.Comment","Result.Depth.Height","Result.Depth.Height.Unit","Analytical.Method.ID","Analytical.Method.Context","Analytical.Method.Name","Analytical.Method.Qualifier","Analytical.Method.Description","Laboratory.Name","Analysis.Start.Date","Analysis.Start.Time","Analysis.Start.Time.Zone","Laboratory.Comment.Code","Detection.Limit.Type1","Detection.Limit.Value1","Detection.Limit.Unit1","Detection.Limit.Type2","Detection.Limit.Value2","Detection.Limit.Unit2","Laboratory.Accreditation.Indicator","Substance.Dilution.Factor1","Lab.Batch.ID","Lab.Sample.ID")
```

```{r}
data01 %>% select(., awqms_export_fields_tokeep) -> data02
# Simplify VarNames
data02 %<>% select(ORG = Activity.Conducting.Organization1,
                   ACTID = Activity.ID, 
                   ACT.type = Activity.Type, 
                   SDate = Activity.Start.Date, STime = Activity.Start.Time, 
                   ACT.depth = Activity.Relative.Depth, 
                   PROJ01 = Project.ID1, 
                   MLID = Monitoring.Location.ID, 
                   MLID.name = Monitoring.Location.Name,
                   MLID.type = Monitoring.Location.Type, 
                   ACT.comment = Activity.Comment,
                   DLL = Data.Logger.Line, 
                   MethodID = Analytical.Method.ID, 
                   PARAM = Characteristic.Name, 
                   SampFrac = Sample.Fraction, 
                   DetCond = Detection.Condition, 
                   ResQual = Result.Qualifier, 
                   Result.Value, Result.Status, Result.Comment, Value.Type,
                   Limit01_nm = Detection.Limit.Type1, 
                   Limit01_val = Detection.Limit.Value1,
                   Limit02_nm = Detection.Limit.Type2, 
                   Limit02_val = Detection.Limit.Value2,
                   DilFact = Substance.Dilution.Factor1, 
                   Method_desc = Analytical.Method.Description,
                   LAB = Laboratory.Name, 
                   AnalysisDate = Analysis.Start.Date,
                   BatchID = Lab.Batch.ID, 
                   PROJ02 = Project.ID2, everything()
				   )
## arrange Var's
data02 %<>% select(-ORG, -ACTID, -PROJ01, everything()) %>%
  select(ACT.type:ResQual, Result.Status,
         Result.Value, Limit01_nm, Limit01_val, Limit02_nm, Limit02_val, DilFact,
         everything())
```

### 1.2 Cleanup Methods and Params

**Parameters**

```{r}
unique(data02$PARAM)
```

```{r}
data02 %<>% mutate(ParamX = PARAM) %>%
  mutate(ParamX = recode(.$PARAM,
                         "Calcium" = "CA",
                         "Phosphate-phosphorus" = "TP", 
                         "Alkalinity, total" = "T.Alk",
                         "Total suspended solids" = "TSS",
                         "Total volatile solids" = "TVS")) %>%
  select(ACT.type:PARAM, ParamX, everything())
```

```{r}
unique(data02$MethodID)
```

```{r}
unique(data02$SampFrac)
table(data02$SampFrac, useNA="ifany")
data02 %>% {addmargins(table(.$PARAM, .$SampFrac, useNA="ifany"))}
```


+ Build Meth_Par.key

```{r}
data02 %<>% mutate(
  MethPar.key = paste(.$MethodID,
                      .$ParamX,
                      sep="_"),
  Par_frac = paste(.$ParamX,
                   recode(.$SampFrac,
                          "Dissolved" = "dis",
                          "Total" = "TOT",
                          .missing="TOT"),
                   sep=".")
  ) %>%
  select(-LAB, -ACT.comment, everything()) %>%
  select(ACT.type:MethodID, MethPar.key, Par_frac,
         PARAM:Result.Value, Result.Unit, Result.Comment, ACT.comment, everything())
```


+ Add YR_qtr to records

```{r}
data02 %<>% mutate(
  samp_YRqtr = paste(lubridate::year(.$SDate),
                     ".q",
                     sprintf("%.2i",lubridate::quarter(.$SDate, with_year=F)),
                     sep="")) %>%
  select(ACT.type:SDate, samp_YRqtr, everything())
```


+ Code Result.Values w/ RLs

```{r}
rlimits = c("Lower Reporting Limit", "Lower Quantitation Limit")
detliits = c("Method Detection Level")


data02 %<>% mutate(
  LRL = case_when(
    Limit01_nm %in% rlimits ~ Limit01_val,
    TRUE ~ as.numeric(NA)),
  MDL = case_when(
    Limit01_nm %in% detliits ~ Limit01_val,
    Limit02_nm %in% detliits ~ Limit02_val,
    TRUE ~ as.numeric(NA))) %>%
  select(ACT.type:Result.Unit, LRL, MDL, everything())
```


```{r}
unique(data02$Limit01_nm)
unique(data02$Limit02_nm)
unique(data02$DetCond)
```



***
***


## 2.0 Data Review

### 2.1 Data Project Goals

1) Identify Method and Parameter Combinations
2) Exmaine MethParms over time...

```{r}
data02 %>% {addmargins(table(.$MethodID, .$ParamX, useNA="ifany", deparse.level = 2))} %>%
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.75em; padding-right: 0.75em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

```{r}
data02 %>% filter(ParamX=="TP") %>%
  {addmargins(table(.$samp_YRqtr, .$MethodID, useNA="ifany", deparse.level = 2))} %>%
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.75em; padding-right: 0.75em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

```{r fig.width=8, fig.height=4}
data02 %>% filter(ParamX=="TP") %>%
  ggplot(.,
         aes(y=SDate,
             x=factor(MethodID),
             col=SampFrac)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.1), size=1) +
  xlab("Method ID") + ylab("Sample Date") +
  scale_y_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date("1989-01-01"), as.Date("2019-01-01"))) +
  coord_flip() +
  ggtitle("Total P [digest]")
#
(
  data02 %>% filter(ParamX=="TP") %>%
  ggplot(.,
         aes(y=SDate,
             x=factor(MethodID),
             col=SampFrac)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.1), size=1) +
  xlab("Method ID") + ylab("Sample Date") +
  scale_y_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date("1989-01-01"), as.Date("2019-01-01"))) +
  coord_flip() +ggtitle("Total P [digest]")
) %>% ggsave("UTLK_DP_methods_date_01.jpg", ., height=4, width=10, dpi=500)
```



### 2.2 Patterns of DP in Utah Lake 

```{r}
data02 %>% filter(ParamX=="TP") %>%
  ggplot(.,
         aes(x=SDate,
             y=as.numeric(Result.Value),
             col=SampFrac)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.1), size=1) +
  xlab("Sample Date") + ylab("Phosphate-Phosphorus concentration (mg/L)") +
  scale_x_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date("1989-01-01"), as.Date("2019-01-01"))) +
  scale_y_continuous(oob=squish,
                     limits=c(0.002, NA), trans = "log10") +
  geom_point(data=data02%>%filter(ParamX=="TP"&is.na(Result.Value)), na.rm=T,
             aes(x=SDate, y=LRL), color="black", shape="J", size=3) +
  geom_point(data=data02%>%filter(ParamX=="TP"&is.na(Result.Value)), na.rm=T,
             aes(x=SDate, y=MDL), color="red", shape="U", size=3) +
  ggtitle("Total P [digest]")
##
(
  data02 %>% filter(ParamX=="TP") %>%
  ggplot(.,
         aes(x=SDate,
             y=as.numeric(Result.Value),
             col=SampFrac)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.1), size=1) +
  xlab("Sample Date") + ylab("Phosphate-Phosphorus concentration (mg/L)") +
  scale_x_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date("1989-01-01"), as.Date("2019-01-01"))) +
  scale_y_continuous(oob=squish,
                     limits=c(0.002, NA), trans = "log10") +
  geom_point(data=data02%>%filter(ParamX=="TP"&is.na(Result.Value)), na.rm=T,
             aes(x=SDate, y=LRL), color="black", shape="J", size=3) +
  geom_point(data=data02%>%filter(ParamX=="TP"&is.na(Result.Value)), na.rm=T,
             aes(x=SDate, y=MDL), color="red", shape="U", size=3) +
  ggtitle("Total P [digest]")
  ) %>% ggsave("UTLK_DP_TP_lowerRnd_date_03.jpg", ., height=6, width=10, dpi=500)
##
(
  data02 %>% filter(ParamX=="TP") %>%
  ggplot(.,
         aes(x=SDate,
             y=as.numeric(Result.Value),
             col=SampFrac)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.1), size=1) +
  xlab("Sample Date") + ylab("Phosphate-Phosphorus concentration (mg/L)") +
  scale_x_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date("1989-01-01"), as.Date("2019-01-01"))) +
  scale_y_continuous(oob=squish,
                     limits=c(NA, 0.1)) +
  geom_point(data=data02%>%filter(ParamX=="TP"&is.na(Result.Value)), na.rm=T,
             aes(x=SDate, y=LRL), color="black", shape="J", size=3) +
  geom_point(data=data02%>%filter(ParamX=="TP"&is.na(Result.Value)), na.rm=T,
             aes(x=SDate, y=MDL), color="red", shape="U", size=3) +
  ggtitle("Total P [digest]")
) %>% ggsave("UTLK_DP_TP_lowerRnd_linscale_date_04.jpg", ., height=4, width=10, dpi=500)
```


```{r}
data02 %>% filter(ParamX=="TP") %>%
  ggplot(.,
         aes(x=SDate,
             y=as.numeric(Result.Value),
             col=SampFrac)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.1), size=1) +
  xlab("Sample Date") + ylab("Phosphate-Phosphorus concentration (mg/L)") +
  scale_x_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date("1989-01-01"), as.Date("2019-01-01"))) +
  scale_y_continuous(oob=squish,
                     limits=c(NA, 0.10)) +
  geom_point(data=data02%>%filter(ParamX=="TP"&is.na(Result.Value)), na.rm=T,
             aes(x=SDate, y=LRL), color="black", shape="J", size=3) +
  geom_point(data=data02%>%filter(ParamX=="TP"&is.na(Result.Value)), na.rm=T,
             aes(x=SDate, y=MDL), color="red", shape="U", size=3) +
  ggtitle("Total P [digest]")
```


+ Dissolved P

```{r}
data02 %>% filter(ParamX=="TP" & SampFrac=="Dissolved") %>%
  ggplot(.,
         aes(x=SDate,
             y=as.numeric(Result.Value))) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.05), size=1, col="blue") +
  xlab("Sample Date") + ylab("Phosphate-Phosphorus concentration (mg/L)") +
  scale_x_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date("1989-01-01"), as.Date("2019-01-01"))) +
  scale_y_continuous(oob=squish,
                     limits=c(NA, 0.050)) +
  geom_point(data=data02%>%filter(ParamX=="TP"&is.na(Result.Value)), na.rm=T,
             aes(x=SDate, y=LRL), color="black", shape="J", size=2.5) +
  geom_point(data=data02%>%filter(ParamX=="TP"&is.na(Result.Value)), na.rm=T,
             aes(x=SDate, y=MDL), color="red", shape="U", size=2.5) +
  ggtitle("Dissolved / Filtered Total P [digest]")
```

+ Dissolved P x Method

```{r}
data02 %>% filter(ParamX=="TP" & SampFrac=="Dissolved") %>%
  ggplot(.,
         aes(x=SDate,
             y=as.numeric(Result.Value),
             col=MethodID)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.05), size=1) +
  xlab("Sample Date") + ylab("Phosphate-Phosphorus concentration (mg/L)") +
  scale_x_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date("1989-01-01"), as.Date("2019-01-01"))) +
  scale_y_continuous(oob=squish,
                     limits=c(NA, 0.050)) +
  geom_point(data=data02%>%filter(ParamX=="TP"&is.na(Result.Value)), na.rm=T,
             aes(x=SDate, y=LRL), color="black", shape="J", size=2.5) +
  geom_point(data=data02%>%filter(ParamX=="TP"&is.na(Result.Value)), na.rm=T,
             aes(x=SDate, y=MDL), color="red", shape="U", size=2.5) +
  ggtitle("Dissolved / Filtered Total P [digest]")
```

+ Dissolved P x Method [2]

```{r}
data02 %>% filter(ParamX=="TP" & SampFrac=="Dissolved") %>%
  ggplot(.,
         aes(x=SDate,
             y=as.numeric(Result.Value),
             col=MethodID)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.05), size=1) +
  xlab("Sample Date") + ylab("Phosphate-Phosphorus concentration (mg/L)") +
  scale_x_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date("1990-07-01"), as.Date("2019-01-01"))) +
  scale_y_continuous(oob=squish,
                     limits=c(NA, 0.050)) +
  geom_point(data=data02%>%filter(ParamX=="TP"), na.rm=T,
             aes(x=SDate, y=LRL), color="black", shape="J", size=2.5) +
  geom_point(data=data02%>%filter(ParamX=="TP"), na.rm=T,
             aes(x=SDate, y=MDL), color="red", shape="U", size=2.5) +
  ggtitle("Dissolved / Filtered Total P [digest]")
#
(
data02 %>% filter(ParamX=="TP" & SampFrac=="Dissolved") %>%
  ggplot(.,
         aes(x=SDate,
             y=as.numeric(Result.Value),
             col=MethodID)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.05), size=1) +
  xlab("Sample Date") + ylab("Phosphate-Phosphorus concentration (mg/L)") +
  scale_x_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date("1990-07-01"), as.Date("2019-01-01"))) +
  scale_y_continuous(oob=squish,
                     limits=c(NA, 0.050)) +
  geom_point(data=data02%>%filter(ParamX=="TP"), na.rm=T,
             aes(x=SDate, y=LRL), color="black", shape="J", size=2.5) +
  geom_point(data=data02%>%filter(ParamX=="TP"), na.rm=T,
             aes(x=SDate, y=MDL), color="red", shape="U", size=2.5) +
    ggtitle("Dissolved / Filtered Total P [digest]")
) %>%
  ggsave("UTLK_DPlower_date_01.jpg", ., height=4, width=10, dpi=500)
```

+ Dissolved P x Method [3]

```{r}
(
data02 %>% filter(ParamX=="TP" & SampFrac=="Dissolved") %>%
  ggplot(.,
         aes(x=SDate,
             y=as.numeric(Result.Value))) + theme_bw() +
  geom_point(data=data02%>%filter(ParamX=="TP"), na.rm=T,
             aes(x=SDate, y=LRL, color=MethodID), shape="J", col="blue", size=2.5) +
  geom_point(data=data02%>%filter(ParamX=="TP"), na.rm=T,
             aes(x=SDate, y=MDL), shape="U", col="red", size=2.5) +
  xlab("Sample Date") + ylab("Phosphate-Phosphorus concentration (mg/L)") +
  scale_x_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date("1990-07-01"), as.Date("2019-01-01"))) +
  scale_y_continuous(oob=squish,
                     limits=c(NA, NA)) + 
  geom_vline(xintercept = as.Date("2000-01-01"), lty=2, col="darkgreen", size=1) +
  annotate("text", x=as.Date("1992-01-01"), y=0.016, vjust=0, hjust=0, label="Generic Methods") +
  annotate("text", x=as.Date("2012-01-01"), y=0.016, vjust=0, hjust=0, label="EPA 365.1") +
  ggtitle("Dissolved / Filtered Total P [digest]")
)  %>% ggsave("UTLK_TP_RLs_date_02.jpg", ., height=4, width=10, dpi=500)
```

***

```{r}
data02 %>% 
  filter(ParamX=="TP" & 
           SampFrac=="Dissolved" & 
           !grepl("STORET ISN", .$Result.Comment) &
           !is.na(Result.Comment)) %>%
  distinct(Result.Comment)
```

```{r}
data02 %>% 
  filter(ParamX=="TP" & 
           SampFrac=="Dissolved" & 
           !grepl("STORET ISN", .$ACT.comment)) %>%
  distinct(ACT.comment)
```

***

### 2.3 Frequency of Data below RL

```{r message=FALSE, warning=FALSE}

data02 %>% filter(ParamX=="TP" & SampFrac=="Dissolved") %>%
  group_by(samp_YRqtr, MethodID) %>%
  summarise(Obs = n(),
            p_NonDet = sum(is.na(Result.Value)),
            min_RL = signif(min(LRL, na.rm=T), digits=3),
            max_RL = signif(max(LRL, na.rm=T), digits=3),
            min_DL = signif(min(MDL, na.rm=T), digits=2),
            max_DL = signif(max(MDL, na.rm=T), digits=2)
            ) -> DP_RL_tab01
#
DP_RL_tab01 %<>% mutate(
  NonDet_total = paste(round(p_NonDet / Obs, digits=2)*100,
                       " %", sep="")
  ) %>% 
  select(samp_YRqtr:p_NonDet, NonDet_total, everything()) %>%
  mutate(
    min_RL = case_when(
      min_RL == "Inf" ~ as.numeric(NA),
      !is.na(min_RL) ~ min_RL),
    max_RL = case_when(
      max_RL == "-Inf" ~ as.numeric(NA),
      !is.na(max_RL) ~ max_RL
    ),
    min_DL = case_when(
      min_DL == "Inf" ~ as.numeric(NA),
      !is.na(min_DL) ~ min_DL
    ),
    max_DL = case_when(
      max_DL == "-Inf" ~ as.numeric(NA),
      !is.na(max_DL) ~ max_DL
    )
  )

# openxlsx::write.xlsx(DP_RL_tab01, file="DP_reportlimits_table1.xlsx")
```

```{r}
# DP_RL_tab01 %>%
#   ggplot()

##

DP_RL_tab01 %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.75em; padding-right: 0.75em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```


***

## 3.0 Other Parameters...

### 3.1 Calcium

```{r}
data02 %>% filter(ParamX=="CA") %>%
  {addmargins(table(.$samp_YRqtr, .$MethodID, useNA="ifany", deparse.level = 2),1)} %>%
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.75em; padding-right: 0.75em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

+ Method x Date

```{r}
data02 %>% filter(ParamX=="CA") %>%
  ggplot(.,
         aes(y=SDate,
             x=factor(MethodID),
             col=SampFrac)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.1), size=1) +
  xlab("Method ID") + ylab("Sample Date") +
  scale_y_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date("1989-01-01"), as.Date("2019-01-01"))) +
  coord_flip() + ggtitle("Dissolved Calcium x Method")
```

+ RLs...

```{r}
(
data02 %>% filter(ParamX=="CA" & SampFrac=="Dissolved") %>%
  ggplot(.,
         aes(x=SDate,
             y=as.numeric(Result.Value))) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.05), size=1) +
  geom_point(data=data02%>%filter(ParamX=="CA"), na.rm=T,
             aes(x=SDate, y=LRL, color=MethodID), shape="J", size=2.5) +
  geom_point(data=data02%>%filter(ParamX=="CA"), na.rm=T,
             aes(x=SDate, y=MDL, color=MethodID), shape="U", size=2.5) +
  xlab("Sample Date") + ylab("Dissolved CALCIUM concentration (mg/L)") +
  scale_x_date(date_labels ="%Y",
               date_breaks="1 year",
               limits=c(as.Date("2016-01-01"), as.Date("2019-01-01"))) +
  scale_y_continuous(oob=squish,
                     limits=c(NA, NA)) +
  ggtitle("Dissolved Calcium x Method")
)
```

+ No CA_dissolved results over the early-2000s time period

### 3.2 TSS

```{r}
data02 %>% filter(ParamX=="TSS") %>%
  {addmargins(table(.$samp_YRqtr, .$MethodID, useNA="ifany", deparse.level = 2),1)} %>%
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.75em; padding-right: 0.75em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

+ Method x Date

```{r}
data02 %>% filter(ParamX=="TSS") %>%
  ggplot(.,
         aes(y=SDate,
             x=factor(MethodID),
             col=SampFrac)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.1), size=1) +
  xlab("Method ID") + ylab("Sample Date") +
  scale_y_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date("1989-01-01"), as.Date("2019-01-01"))) +
  coord_flip() +
  ggtitle("Total Suspended Solids x Method")
```

+ RLs...

```{r}
(
data02 %>% filter(ParamX=="TSS") %>%
  ggplot(.,
         aes(x=SDate,
             y=as.numeric(Result.Value))) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.05), size=1) +
  geom_point(data=data02%>%filter(ParamX=="TSS"), na.rm=T,
             aes(x=SDate, y=LRL, color=MethodID), shape="J", size=2.5) +
  geom_point(data=data02%>%filter(ParamX=="TSS"), na.rm=T,
             aes(x=SDate, y=MDL), shape="U",col="red",  size=2.5) +
  xlab("Sample Date") + ylab("TSS  concentration (mg/L)") +
  scale_x_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date("1989-01-01"), as.Date("2019-01-01"))) +
  scale_y_continuous(oob=squish,
                     limits=c(NA, 300)) +
  ggtitle("Total Suspended Solids x Method")
)
```

### 3.3 Total Alkalinity


```{r}
data02 %>% filter(ParamX=="T.Alk") %>%
  {addmargins(table(.$samp_YRqtr, .$MethodID, useNA="ifany", deparse.level = 2),1)} %>%
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.75em; padding-right: 0.75em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

+ RLs...

```{r}
(
data02 %>% filter(ParamX=="T.Alk") %>%
  ggplot(.,
         aes(x=SDate,
             y=as.numeric(Result.Value))) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.05), size=1) +
  geom_point(data=data02%>%filter(ParamX=="T.Alk"), na.rm=T,
             aes(x=SDate, y=LRL, color=MethodID), shape="J", size=2.5) +
  geom_point(data=data02%>%filter(ParamX=="T.Alk"), na.rm=T,
             aes(x=SDate, y=MDL), shape="U",col="red",  size=2.5) +
  xlab("Sample Date") + ylab("Total Alkalinity (mg CaCO3/L)") +
  scale_x_date(date_labels ="%Y",
               date_breaks="1 year",
               limits=c(as.Date(NA), as.Date("2019-01-01"))) +
  scale_y_continuous(oob=squish,
                     limits=c(NA, NA)) +
  ggtitle("Total Alkalinity (gran titr.) x Method")
)
```


***
***
***

## 4.0 Second retrieval, Nitrogen-species

+ Sites as before (see 1.0)
+ N-species...
  + NH4
  + NO32
  + TKN
  + TN
  + Norg

### 4.1 AWQMS-data cleanup


```{r}
# file.02  <- choose.files(caption="Select _working_ DATA file [*.xlsx]", multi = FALSE)
N_data01 <- openxlsx::read.xlsx(file.02, sheet=1, startRow = 2,
                              rowNames=FALSE, check.names = T)
```


+ Cleanup

```{r}
N_data01$Activity.Start.Date <- as.Date(N_data01$Activity.Start.Date, origin="1899-12-30")
N_data01$Analysis.Start.Date <- as.Date(N_data01$Analysis.Start.Date, origin="1899-12-30")
N_data01$Activity.Start.Time <- as.character(chron::times((N_data01$Activity.Start.Time - as.integer(N_data01$Activity.Start.Time))))
N_data01$Analysis.Start.Time <- as.character(chron::times((N_data01$Analysis.Start.Time - as.integer(N_data01$Analysis.Start.Time))))
```

+ Filename ::  `r basename(file.02)`
+ Path ::  `r dirname(file.02)`
+ Datafile has :: `r nrow(N_data01)` records & `r ncol(N_data01)` fields
+ Record Data Range :: From `r min(N_data01$Activity.Start.Date)` to `r max(N_data01$Activity.Start.Date)`
+ Record Sample-Time Range :: From [`r min(N_data01$Activity.Start.Time, na.rm=T)`] to [`r max(N_data01$Activity.Start.Time, na.rm=T)`]

#### 4.11 Trim datafile

**Fields to Keep from AWQMS Standard Export**

```{r}
awqms_export_fields_tokeep <- c("Organization.ID","Activity.ID","Activity.Type","Activity.Media","Activity.Start.Date", "Activity.Start.Time", "Activity.Relative.Depth","Activity.Depth.Height","Activity.Depth.Height.Unit","Activity.Top.Depth.Height","Activity.Top.Depth.Height.Unit","Activity.Bottom.Depth.Height","Activity.Bottom.Depth.Height.Unit","Project.ID1","Project.ID2","Activity.Conducting.Organization1","Activity.Conducting.Organization2","Monitoring.Location.ID","Monitoring.Location.Name","Monitoring.Location.Type","Activity.Comment","Sample.Collection.Method.ID","Sample.Collection.Method.Context","Sample.Collection.Method.Name","Sample.Collection.Method.Description","Result.UID","Data.Logger.Line","Detection.Condition","Characteristic.Name","Method.Speciation","Sample.Fraction","Result.Value","Result.Unit","Result.Qualifier","Result.Status","Value.Type","Time.Basis","Temperature.Basis","Result.Comment","Result.Depth.Height","Result.Depth.Height.Unit","Analytical.Method.ID","Analytical.Method.Context","Analytical.Method.Name","Analytical.Method.Qualifier","Analytical.Method.Description","Laboratory.Name","Analysis.Start.Date","Analysis.Start.Time","Analysis.Start.Time.Zone","Laboratory.Comment.Code","Detection.Limit.Type1","Detection.Limit.Value1","Detection.Limit.Unit1","Detection.Limit.Type2","Detection.Limit.Value2","Detection.Limit.Unit2","Laboratory.Accreditation.Indicator","Substance.Dilution.Factor1","Lab.Batch.ID","Lab.Sample.ID")
```

```{r}
N_data01 %>% select(., awqms_export_fields_tokeep) -> N_data02
# Simplify VarNames
N_data02 %<>% select(ORG = Activity.Conducting.Organization1,
                   ACTID = Activity.ID, 
                   ACT.type = Activity.Type, 
                   SDate = Activity.Start.Date, STime = Activity.Start.Time, 
                   ACT.depth = Activity.Relative.Depth, 
                   PROJ01 = Project.ID1, 
                   MLID = Monitoring.Location.ID, 
                   MLID.name = Monitoring.Location.Name,
                   MLID.type = Monitoring.Location.Type, 
                   ACT.comment = Activity.Comment,
                   DLL = Data.Logger.Line, 
                   MethodID = Analytical.Method.ID, 
                   PARAM = Characteristic.Name, 
                   SampFrac = Sample.Fraction, 
                   DetCond = Detection.Condition, 
                   ResQual = Result.Qualifier, 
                   Result.Value, Result.Status, Result.Comment, Value.Type,
                   Limit01_nm = Detection.Limit.Type1, 
                   Limit01_val = Detection.Limit.Value1,
                   Limit02_nm = Detection.Limit.Type2, 
                   Limit02_val = Detection.Limit.Value2,
                   DilFact = Substance.Dilution.Factor1, 
                   Method_desc = Analytical.Method.Description,
                   LAB = Laboratory.Name, 
                   AnalysisDate = Analysis.Start.Date,
                   BatchID = Lab.Batch.ID, 
                   PROJ02 = Project.ID2, everything()
				   )
## arrange Var's
N_data02 %<>% select(-ORG, -ACTID, -PROJ01, everything()) %>%
  select(ACT.type:ResQual, Result.Status,
         Result.Value, Limit01_nm, Limit01_val, Limit02_nm, Limit02_val, DilFact,
         everything())
```


#### 4.12 Cleanup Methods and Params

**Parameters**

```{r}
unique(N_data02$PARAM)
```

```{r}
N_data02 %<>% mutate(ParamX = PARAM) %>%
  mutate(ParamX = recode(.$PARAM,
                         "Ammonia-nitrogen" = "NH4",
                         "Kjeldahl nitrogen" = "TKN", 
                         "Inorganic nitrogen (nitrate and nitrite)" = "NO32",
                         "Organic Nitrogen" = "Norg",
                         "Nitrogen" = "TN")) %>%
  select(ACT.type:PARAM, ParamX, everything())
```

```{r}
unique(N_data02$MethodID)
```

```{r}
unique(N_data02$SampFrac)
N_data02 %>% {addmargins(table(.$PARAM, .$SampFrac, useNA="ifany"))}
```


+ Build Meth_Par.key

```{r}
N_data02 %<>% mutate(
  MethPar.key = paste(.$MethodID,
                      .$ParamX,
                      sep="_"),
  Par_frac = paste(.$ParamX,
                   recode(.$SampFrac,
                          "Dissolved" = "dis",
                          "Total" = "TOT",
                          .missing="TOT"),
                   sep=".")
  ) %>%
  select(-LAB, -ACT.comment, everything()) %>%
  select(ACT.type:MethodID, MethPar.key, Par_frac,
         PARAM:Result.Value, Result.Unit, Result.Comment, ACT.comment, everything())
```


+ Add YR_qtr to records

```{r}
N_data02 %<>% mutate(
  samp_YRqtr = paste(lubridate::year(.$SDate),
                     ".q",
                     sprintf("%.2i",lubridate::quarter(.$SDate, with_year=F)),
                     sep="")) %>%
  select(ACT.type:SDate, samp_YRqtr, everything())
```

+ Code Result.Values w/ RLs

```{r}
unique(N_data02$Limit01_nm)
unique(N_data02$Limit02_nm)
```


```{r}
rlimits = c("Lower Reporting Limit", "Lower Quantitation Limit")
detliits = c("Method Detection Level")


N_data02 %<>% mutate(
  LRL = case_when(
    Limit01_nm %in% rlimits ~ Limit01_val,
    TRUE ~ as.numeric(NA)),
  MDL = case_when(
    Limit01_nm %in% detliits ~ Limit01_val,
    Limit02_nm %in% detliits ~ Limit02_val,
    TRUE ~ as.numeric(NA))) %>%
  select(-MLID.name, -DLL, everything()) %>%
  select(ACT.type:Result.Unit, LRL, MDL, 
         Result.Comment:DilFact, MLID.name, everything())
```

***

### 4.2 Param x Methods

```{r}
N_data02 %>% {addmargins(table(.$MethPar.key, !is.na(.$Result.Value),
                               useNA="ifany", deparse.level = 2))}
```

#### 4.21 Ammonium

```{r}
N_data02 %>% filter(ParamX=="NH4") %>%
  ggplot(.,
         aes(y=SDate,
             x=factor(MethodID),
             col=SampFrac)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.1), size=1) +
  xlab("Method ID") + ylab("Sample Date") +
  scale_y_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date(NA), as.Date("2019-01-01"))) +
  coord_flip() +
  ggtitle("Ammonium x Method")
```

+ Reporting Limits

```{r}
(
N_data02 %>% filter(ParamX=="NH4") %>%
  ggplot(.,
         aes(x=SDate,
             y=as.numeric(Result.Value),
             col=SampFrac)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.05), size=1) +
  geom_point(data=N_data02%>%filter(ParamX=="NH4")%>%distinct(samp_YRqtr, .keep_all=T), na.rm=T,
             aes(x=SDate, y=LRL, color=MethodID), shape="J", size=3) +
  geom_point(data=N_data02%>%filter(ParamX=="NH4")%>%distinct(samp_YRqtr, .keep_all=T), na.rm=T,
             aes(x=SDate, y=MDL), color="black", shape="U", size=2) +
  xlab("Sample Date") + ylab("Ammonium concentration (mg NH4-N/L)") +
  scale_x_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date(NA), as.Date("2019-01-01"))) +
  scale_y_continuous(oob=squish,
                     limits=c(0, 0.15)) +
  ggtitle("Ammonium x Method")
)
```

```{r}
(
N_data02 %>% filter(ParamX=="NH4") %>%
  ggplot(.,
         aes(x=SDate,
             y=as.numeric(Result.Value))) + theme_bw() +
  geom_point(data=N_data02%>%filter(ParamX=="NH4")%>%distinct(samp_YRqtr, .keep_all=T), na.rm=T,
             aes(x=SDate, y=LRL, color=MethodID), shape="J", size=3) +
  geom_point(data=N_data02%>%filter(ParamX=="NH4")%>%distinct(samp_YRqtr, .keep_all=T), na.rm=T,
             aes(x=SDate, y=MDL), color="black", shape="U", size=2) +
  xlab("Sample Date") + ylab("Ammonium concentration (mg NH4-N/L)") +
  scale_x_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date(NA), as.Date("2019-01-01"))) +
  scale_y_continuous(oob=squish,
                     limits=c(0, NA)) +
  ggtitle("Ammonium x Method")
)
```

#### 4.22 Nitrates

```{r}
N_data02 %>% filter(ParamX=="NO32") %>%
  ggplot(.,
         aes(y=SDate,
             x=factor(MethodID),
             col=SampFrac)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.1), size=1) +
  xlab("Method ID") + ylab("Sample Date") +
  scale_y_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date(NA), as.Date("2019-01-01"))) +
  coord_flip() +
  ggtitle("Nitrates (Nitrate + Nitrite) x Method")
```

+ Reporting Limits

```{r}
(
N_data02 %>% filter(ParamX=="NO32") %>%
  ggplot(.,
         aes(x=SDate,
             y=as.numeric(Result.Value),
             col=SampFrac)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.05), size=1) +
  geom_point(data=N_data02%>%filter(ParamX=="NO32")%>%distinct(samp_YRqtr, .keep_all=T), na.rm=T,
             aes(x=SDate, y=LRL, color=MethodID), shape="J", size=3) +
  geom_point(data=N_data02%>%filter(ParamX=="NO32")%>%distinct(samp_YRqtr, .keep_all=T), na.rm=T,
             aes(x=SDate, y=MDL), color="black", shape="U", size=2) +
  xlab("Sample Date") + ylab("Nitrates concentration (mg NO3-N/L)") +
  scale_x_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date(NA), as.Date("2019-01-01"))) +
  scale_y_continuous(oob=squish,
                     limits=c(0, 0.25)) +
  ggtitle("Nitrates x Method")
)
```

```{r}
(
N_data02 %>% filter(ParamX=="NO32") %>%
  ggplot(.,
         aes(x=SDate,
             y=as.numeric(Result.Value))) + theme_bw() +
  geom_point(data=N_data02%>%filter(ParamX=="NO32")%>%distinct(samp_YRqtr, .keep_all=T), na.rm=T,
             aes(x=SDate, y=LRL, color=MethodID), shape="J", size=3) +
  geom_point(data=N_data02%>%filter(ParamX=="NO32")%>%distinct(samp_YRqtr, .keep_all=T), na.rm=T,
             aes(x=SDate, y=MDL), color="black", shape="U", size=2) +
  xlab("Sample Date") + ylab("Nitrates concentration (mg NO3-N/L)") +
  scale_x_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date(NA), as.Date("2019-01-01"))) +
  scale_y_continuous(oob=squish,
                     limits=c(0, NA)) +
  ggtitle("Nitrates x Method")
)
```

#### 4.23 Total Nitrogen

```{r}
N_data02 %>% filter(ParamX=="TN") %>%
  ggplot(.,
         aes(y=SDate,
             x=factor(MethodID),
             col=SampFrac)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.1), size=1) +
  xlab("Method ID") + ylab("Sample Date") +
  scale_y_date(date_labels ="%Y",
               date_breaks="1 year",
               limits=c(as.Date(NA), as.Date("2019-01-01"))) +
  coord_flip() +
  ggtitle("Total N (persulfate ox.) x Method")
```

+ Reporting Limits

```{r}
(
N_data02 %>% filter(ParamX=="TN") %>%
  ggplot(.,
         aes(x=SDate,
             y=as.numeric(Result.Value),
             col=SampFrac)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.05), size=1) +
  geom_point(data=N_data02%>%filter(ParamX=="TN")%>%distinct(samp_YRqtr, .keep_all=T), na.rm=T,
             aes(x=SDate, y=LRL, color=MethodID), shape="J", size=3) +
  geom_point(data=N_data02%>%filter(ParamX=="TN")%>%distinct(samp_YRqtr, .keep_all=T), na.rm=T,
             aes(x=SDate, y=MDL), color="black", shape="U", size=2) +
  xlab("Sample Date") + ylab("total Nitrogen concentration (mg N/L)") +
  scale_x_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date(NA), as.Date("2019-01-01"))) +
  scale_y_continuous(oob=squish,
                     limits=c(0, 0.35)) +
  ggtitle("Total N (persulfate ox.) x Method")
)
```

#### 4.24 Kjeldahl N

```{r}
N_data02 %>% filter(ParamX=="TKN") %>%
  ggplot(.,
         aes(y=SDate,
             x=factor(MethodID),
             col=SampFrac)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.1), size=1) +
  xlab("Method ID") + ylab("Sample Date") +
  scale_y_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date(NA), as.Date("2019-01-01"))) +
  coord_flip() +
  ggtitle("Total Kjeldahl N [TKN] x Method")
```

+ Reporting Limits

```{r}
N_data02 %>% filter(ParamX=="TKN") %>% filter(is.na(Result.Value)) %>% nrow()
```

+ No reporting limits given for TKN

```{r}
(
N_data02 %>% filter(ParamX=="TKN") %>%
  ggplot(.,
         aes(x=SDate,
             y=as.numeric(Result.Value),
             col=SampFrac)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.05), size=1) +
  geom_point(data=N_data02%>%filter(ParamX=="TKN")%>%distinct(samp_YRqtr, .keep_all=T), na.rm=T,
             aes(x=SDate, y=LRL, color=MethodID), shape="J", size=3) +
  geom_point(data=N_data02%>%filter(ParamX=="TKN")%>%distinct(samp_YRqtr, .keep_all=T), na.rm=T,
             aes(x=SDate, y=MDL), color="black", shape="U", size=2) +
  xlab("Sample Date") + ylab("total Kjeldahl Nitrogen concentration (mg N/L)") +
  scale_x_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date(NA), as.Date("2019-01-01"))) +
  scale_y_continuous(oob=squish,
                     limits=c(0, NA)) +
  ggtitle("Total Kjeldahl N [TKN] x Method")
)
```

#### 4.25 Organic N

```{r}
N_data02 %>% filter(ParamX=="Norg") %>%
  ggplot(.,
         aes(y=SDate,
             x=factor(MethodID),
             col=SampFrac)) + theme_bw() +
  geom_point(na.rm=T,
             position=position_jitter(width=0.1), size=1) +
  xlab("Method ID") + ylab("Sample Date") +
  scale_y_date(date_labels ="%Y",
               date_breaks="3 year",
               limits=c(as.Date(NA), as.Date("2019-01-01"))) +
  coord_flip() +
  ggtitle("Organic N (calculated?) x Method")
```

+ Few samples, no reporting limits given

***

## 5.0 Additional Param x Methods review

+ [190714] 

### 5.1 Full record sets of N-species in available dataset

Objective: Tabulate all record sets that have a full complement of soluble / suspended N species

+ Rebuild Param x Fraction table...

```{r}
N_data02 %>% {addmargins(table(.$PARAM, .$SampFrac, useNA="ifany"))}
```

+ Ignore "Organic N", too few observations to be useful

+ Full S-sets ::
  + NH4 & NO32 & TN/TKN :: by fraction


```{r}
N_data02 %>% 
  filter(PARAM != "Organic N") %>%
  filter(ACT.depth != "Bottom") %>%
  mutate(
    RVal2 = case_when(
      !is.na(Result.Value) ~ as.character(Result.Value),
      is.na(Result.Value) & !is.na(LRL) ~ "J",
      is.na(Result.Value) & !is.na(MDL) ~ "U",
      TRUE ~ as.character(NA))
    ) %>%
  select(-Method_desc, -AnalysisDate, -BatchID, -PROJ02, -PROJ01,
         -Organization.ID, -Activity.Media, -Activity.Depth.Height,
         -Activity.Depth.Height.Unit, -Activity.Top.Depth.Height,
         -Activity.Top.Depth.Height.Unit, -Activity.Bottom.Depth.Height,
         -Activity.Bottom.Depth.Height.Unit, -Activity.Conducting.Organization2,
         -ORG, -Sample.Collection.Method.ID, -Sample.Collection.Method.Context,
         -Sample.Collection.Method.Name, -Sample.Collection.Method.Description,
         -Result.UID, -Result.Depth.Height, -Result.Depth.Height.Unit,
         -Time.Basis, -Temperature.Basis, -AnalysisDate,
         -Analytical.Method.Context, -Analytical.Method.Name, -Analytical.Method.Qualifier,
         -Analysis.Start.Time, -Analysis.Start.Time.Zone, -LAB, -DLL,
         -MethPar.key, -PARAM, -Method.Speciation, -MethodID, -SampFrac, -ParamX,
         -LRL, -MDL, -DilFact, -DetCond, -Value.Type, -Result.Status, -ResQual,
         -Laboratory.Comment.Code, -Laboratory.Accreditation.Indicator,
         -ACT.depth, -Result.Comment, -ACT.comment, -ACT.type,
         -Lab.Sample.ID, -MLID.type, -contains("Limit", ignore.case = T),
         -Result.Value) %>%
  distinct(SDate, MLID, STime, Par_frac, .keep_all = T) %>%
  spread(., Par_frac, RVal2) %>%
  arrange(MLID, SDate) %>%
  select(-samp_YRqtr,  
         -MLID.name, -ACTID, everything()) %>%
  select(MLID, SDate, STime, NH4.dis:TN.TOT,
         everything()) -> N_data03
#
 # select(-Method_desc, -AnalysisDate, -BatchID, -PROJ02, -PROJ01,
 #         -Organization.ID, -Activity.Media, -Activity.Depth.Height,
 #         -Activity.Depth.Height.Unit, -Activity.Top.Depth.Height,
 #         -Activity.Top.Depth.Height.Unit, -Activity.Bottom.Depth.Height,
 #         -Activity.Bottom.Depth.Height.Unit, -Activity.Conducting.Organization2,
 #         -ORG, -Sample.Collection.Method.ID, -Sample.Collection.Method.Context,
 #         -Sample.Collection.Method.Name, -Sample.Collection.Method.Description, 
 #         -Result.UID, -Result.Depth.Height, -Result.Depth.Height.Unit,
 #         -Time.Basis, -Temperature.Basis, -AnalysisDate,
 #         -Analytical.Method.Context, -Analytical.Method.Name, -Analytical.Method.Qualifier,
 #         -Analysis.Start.Time, -Analysis.Start.Time.Zone, -LAB, -DLL) %>%
```

+ Review spread/cast dataset [`N_data03`]

```{r}
N_data03 %>% nrow()

N_data03 %>% 
  distinct(ACTID) %>%
  nrow()

N_data03 %>% 
  distinct(ACTID, MLID) %>%
  nrow()
```

Looks like we have unique sampling-events for parameter comparisons...

+ Using RVal2 as_char and includes J/U-flags to show when a sample was collected but the analyte was not detected...

+ Sample.Collection intensity by MLID

```{r}
N_data03 %>% {
  addmargins(table(.$MLID, useNA="ifany", deparse.level = 2)) } %>%
  as.data.frame(.) %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.75em; padding-right: 0.75em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="rcc", total=T)
```

#### PLOT: MLID x Sample-Year

```{r}
N_data03 %>%
  ggplot(., 
         aes(x=lubridate::year(SDate),
             y = as.factor(MLID),
             col=as.character(lubridate::year(SDate)))) + theme_bw() +
  geom_point(na.rm=T) + theme(legend.position = "none") +
  xlab("Year Sample Collected") +
  ylab("Monitoring Location ID") +
  scale_x_continuous(limits=c(NA, NA), breaks = seq(1990, 2019, 2)) +
  ggtitle("MLIDs x Sample Collection Year at Utah Lake")
```

+ Key Sampling Locations ::
  + 4917770
  + 4917600
  + 4917520
  + 4917500
  + 4917450
  + 4917390
  + 4917370
  + 4917320
  + 4917310

```{r}
key_sites <- c("4917770", "4917600", "4917520", "4917500",
               "4917450", "4917390", "4917370", "4917320", "4917310")
```

```{r}
N_data03_keysites <- N_data03 %>%
  filter(MLID %in% key_sites)
```

#### PLOT: MLID x Param

```{r}
N_data02 %>%
  filter(MLID %in% key_sites &
           ParamX != "Norg") %>%
  ggplot(., 
         aes(x=lubridate::year(SDate),
             y = as.factor(ParamX),
             col=as.character(lubridate::year(SDate)))) + theme_bw() +
  geom_point(na.rm=T) + theme(legend.position = "none") +
  xlab("Year Sample Collected") +
  ylab("Monitoring Location ID") +
  scale_x_continuous(limits=c(NA, NA), breaks = seq(1990, 2019, 2)) +
  ggtitle("Parameters x Sample Collection Year at Utah Lake")
```




#### tables

+ Use DF: `N_data02`
  + Ignore organic N (_Norg_)

```{r}
N_data02 %>% 
  filter(ParamX != "Norg") %>%
  {
  addmargins(table(.$MLID, 
                   .$ParamX,
                   useNA="ifany", deparse.level = 2)) } %>%
  as.data.frame.matrix(.) %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.75em; padding-right: 0.75em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="rcc", total=T)
```

+ Look at only key sites...


+ Summarize N-species sets for key_sites

```{r}
N_data03_keysites %<>% mutate(
  full_N = case_when(
    (!is.na(NH4.dis) | !is.na(NH4.TOT)) & 
      (!is.na(NO32.dis) | !is.na(NO32.TOT)) &
      (!is.na(TKN.TOT) | !is.na(TN.dis) | !is.na(TN.TOT)) ~ "YES",
    TRUE ~ "no")) %>%
  select(MLID:TN.TOT, full_N, everything())
```

```{r}
N_data03_keysites %>% {addmargins(table(.$MLID, .$full_N,
                                        useNA="ifany", deparse.level = 2))}
#
N_data03_keysites %>%
  filter(full_N == "YES") %>%
  {addmargins(table(.$MLID, lubridate::year(.$SDate),
                                        useNA="ifany", deparse.level = 2))}
```

+ Approximate "_completeness_" of N-species by MLID (key sites only [9]) by Year is higher than expected :: `r round((N_data03_keysites %>% filter(full_N=="YES") %>% nrow(.))/(nrow(N_data03_keysites)),2) * 100`% of sample-collections have full N-species

### 5.2 Sample Fraction Efx on N-species

+ From table in 5.1, not a whole lot of paired inorganic N-species



+ Working DF :: `N_data02`

#### NH4 x Sample Fraction

```{r}
N_data02 %>%
  filter(ParamX=="NH4" & ACT.depth != "Bottom") %>%
  mutate(
    RVal2 = case_when(
      !is.na(Result.Value) ~ as.numeric(Result.Value),
      is.na(Result.Value) & !is.na(MDL) ~ as.numeric(MDL),
      is.na(Result.Value) & !is.na(LRL) ~ as.numeric(LRL),
      TRUE ~ as.numeric(NA)),
    Rflag = case_when(
      is.na(Result.Value) & !is.na(MDL) ~ "U",
      is.na(Result.Value) & !is.na(LRL) ~ "J",
      TRUE ~ as.character(NA))
    ) %>%
  distinct(MLID, ParamX, SDate, SampFrac, RVal2, ACT.depth,
         MethodID) %>%
  spread(., SampFrac, RVal2) %>%
  ggplot(., 
         aes(x=Total, y=Dissolved, 
             col=MLID)) + theme_bw() +
  geom_point(na.rm=T) + theme(legend.position = "none") +
  ggtitle("NH4 Dissolved versus Total (filtered/unfiltered) concentrations [mg N/L]") +
  geom_abline(slope=1, intercept=0, lty=2, col="darkgreen") +
  scale_x_continuous(limits=c(NA, 1), oob=squish) +
  scale_y_continuous(limits=c(NA, NA), oob=squish)

```

#### NO32 x Sample Fraction

```{r}
N_data02 %>%
  filter(ParamX=="NO32" & ACT.depth != "Bottom") %>%
  mutate(
    RVal2 = case_when(
      !is.na(Result.Value) ~ as.numeric(Result.Value),
      is.na(Result.Value) & !is.na(MDL) ~ as.numeric(MDL),
      is.na(Result.Value) & !is.na(LRL) ~ as.numeric(LRL),
      TRUE ~ as.numeric(NA)),
    Rflag = case_when(
      is.na(Result.Value) & !is.na(MDL) ~ "U",
      is.na(Result.Value) & !is.na(LRL) ~ "J",
      TRUE ~ as.character(NA))
    ) %>%
  distinct(MLID, ParamX, SDate, SampFrac, RVal2, ACT.depth,
         MethodID) %>%
  spread(., SampFrac, RVal2) %>%
  ggplot(., 
         aes(x=Total, y=Dissolved, 
             col=MLID)) + theme_bw() +
  geom_point(na.rm=T) + theme(legend.position = "none") +
  ggtitle("NO32 Dissolved versus Total (filtered/unfiltered) concentrations [mg N/L]") +
  geom_abline(slope=1, intercept=0, lty=2, col="darkgreen") +
  scale_x_continuous(limits=c(NA, NA), oob=squish) +
  scale_y_continuous(limits=c(NA, NA), oob=squish)

```

+ Across all available UTLK data, looks like just 1 sample-pair has a _potential outlier_ where the result for dissolved NO32 >> total (unfiltered) NO32.

_Take a closer look_

+ Lower concentration range...

```{r}
# NO32_poly <- data.frame(x=c(0, 0.025, 0.025, 0),
                        # y=c(0,0,0.025, 0.025))
N_data02 %>%
  filter(ParamX=="NO32" & ACT.depth != "Bottom") %>%
  mutate(
    RVal2 = case_when(
      !is.na(Result.Value) ~ as.numeric(Result.Value),
      is.na(Result.Value) & !is.na(MDL) ~ as.numeric(MDL),
      is.na(Result.Value) & !is.na(LRL) ~ as.numeric(LRL),
      TRUE ~ as.numeric(NA)),
    Rflag = case_when(
      is.na(Result.Value) & !is.na(MDL) ~ "U",
      is.na(Result.Value) & !is.na(LRL) ~ "J",
      TRUE ~ as.character(NA))
    ) %>%
  distinct(MLID, ParamX, SDate, SampFrac, RVal2, ACT.depth,
         MethodID) %>%
  spread(., SampFrac, RVal2) %>%
  ggplot(., 
         aes(x=Total, y=Dissolved, 
             col=MLID)) + theme_bw() +
  geom_point(na.rm=T) + theme(legend.position = "none") +
  ggtitle("NO32 Dissolved versus Total (filtered/unfiltered) concentrations [mg N/L]") +
  geom_abline(slope=1, intercept=0, lty=2, col="darkgreen") +
  geom_abline(slope = 1.1, intercept = 0.025, lty=2, col="gray40", alpha=0.8) +
  geom_abline(slope=1.2, intercept=0.025, lty=2, col="blue") +
  geom_abline(slope=0.8, intercept=-0.025, lty=2, col="blue") +
  scale_x_continuous(limits=c(0, 0.5), oob=squish) +
  scale_y_continuous(limits=c(0, 0.5), oob=squish) + 
  geom_hline(yintercept=0.1, lty=2, col="red") + 
  geom_vline(xintercept=0.1, lty=2, col="red") +
  geom_hline(yintercept = 0.025, lty=2, col="gray20") +
  geom_vline(xintercept = 0.025, lty=2, col="gray20") +
  annotate("text", x=0.11, y=0.5, vjust=0, hjust=0, label="LRL", col="red") +
  annotate("text", x=0.5, y=0.11, vjust=0, hjust=0, label="LRL", col="red") +
  annotate("text", x=0.03, y=0.5, vjust=0, hjust=0, label="MDL") +
  annotate("text", x=0.5, y=0.03, vjust=0, hjust=0, label="MDL")
#geom_polygon(data=NO32_poly, aes(x=x, y=y), fill="gray70", alpha=0.5) +
```


+ More dissolved-NO32 reslts are greater than expected, based on unfiltered NO32 concentrations, however:
  + (1) most of these result-pairs are less than the LRL, where precision of quantitation may be scaled b/w the MDL and LRL range
  + (2) only 1 result-pair lies outside the +/- 20% error bound for precision of the method

+ It could be that samples w/ dissolved NO32 > total NO32, where total NO32 < LRL, had contaminated filter units

+ Closer inspection of these particular data-pairs will require obtaining the list of Blanks associated with these monitoring runs to look at levels of background contamination

***

```{r}
N_data02 %>%
  filter(ParamX=="NO32" & ACT.depth != "Bottom") %>%
  mutate(
    RVal2 = case_when(
      !is.na(Result.Value) ~ as.numeric(Result.Value),
      is.na(Result.Value) & !is.na(MDL) ~ as.numeric(MDL),
      is.na(Result.Value) & !is.na(LRL) ~ as.numeric(LRL),
      TRUE ~ as.numeric(NA)),
    Rflag = case_when(
      is.na(Result.Value) & !is.na(MDL) ~ "U",
      is.na(Result.Value) & !is.na(LRL) ~ "J",
      TRUE ~ as.character(NA))
    ) %>%
  filter(!is.na(Rflag)) %>%
  ggplot(., 
         aes(x=RVal2, col=Rflag)) + theme_bw() +
  stat_ecdf(na.rm=T, lty=1, alpha=0.5, size=1.5) +
  ggtitle("Distribution of NO32 concentrations, full range is 0-5 mg N/L") +
  scale_x_continuous(oob=squish, limits=c(NA, NA))
```

+ workable estimates of U-flgs are 0.025 and 

***

#### Total N x Sample Fraction

```{r}
N_data02 %>%
  filter(ParamX=="TN" & ACT.depth != "Bottom") %>%
  mutate(
    RVal2 = case_when(
      !is.na(Result.Value) ~ as.numeric(Result.Value),
      is.na(Result.Value) & !is.na(MDL) ~ as.numeric(MDL),
      is.na(Result.Value) & !is.na(LRL) ~ as.numeric(LRL),
      TRUE ~ as.numeric(NA)),
    Rflag = case_when(
      is.na(Result.Value) & !is.na(MDL) ~ "U",
      is.na(Result.Value) & !is.na(LRL) ~ "J",
      TRUE ~ as.character(NA))
    ) %>%
  distinct(MLID, ParamX, SDate, SampFrac, RVal2, ACT.depth,
         MethodID) %>%
  spread(., SampFrac, RVal2) %>%
  ggplot(., 
         aes(x=Total, y=Dissolved, 
             col=MLID)) + theme_bw() +
  geom_point(na.rm=T) + theme(legend.position = "none") +
  ggtitle("Total N (digest) Dissolved versus Total (filtered/unfiltered) concentrations [mg N/L]") +
  geom_abline(slope=1, intercept=0, lty=2, col="darkgreen") +
  geom_abline(slope=1.2, intercept=0.025, lty=2, col="blue") +
  geom_abline(slope=0.8, intercept=-0.025, lty=2, col="blue") +
  scale_x_continuous(limits=c(NA, NA), oob=squish) +
  scale_y_continuous(limits=c(NA, NA), oob=squish) +
  geom_hline(yintercept=0.2, lty=2, col="red") + 
  geom_vline(xintercept=0.2, lty=2, col="red") +
  annotate("text", x=0.22, y=4.5, vjust=0, hjust=0, label="LRL") +
  annotate("text", x=4.5, y=0.22, vjust=0, hjust=0, label="LRL")

```

_Take another closer look_

```{r}
N_data02 %>%
  filter(ParamX=="TN" & ACT.depth != "Bottom") %>%
  mutate(
    RVal2 = case_when(
      !is.na(Result.Value) ~ as.numeric(Result.Value),
      is.na(Result.Value) & !is.na(MDL) ~ as.numeric(MDL),
      is.na(Result.Value) & !is.na(LRL) ~ as.numeric(LRL),
      TRUE ~ as.numeric(NA)),
    Rflag = case_when(
      is.na(Result.Value) & !is.na(MDL) ~ "U",
      is.na(Result.Value) & !is.na(LRL) ~ "J",
      TRUE ~ as.character(NA))
    ) %>%
  distinct(MLID, ParamX, SDate, SampFrac, RVal2, ACT.depth,
         MethodID) %>%
  spread(., SampFrac, RVal2) %>%
  ggplot(., 
         aes(x=Total, y=Dissolved, 
             col=MLID)) + theme_bw() +
  geom_point(na.rm=T) + theme(legend.position = "none") +
  ggtitle("Total N (digest) Dissolved versus Total (filtered/unfiltered) concentrations [mg N/L]") +
  geom_abline(slope=1, intercept=0, lty=2, col="darkgreen") +
  geom_abline(slope=1.2, intercept=0.025, lty=2, col="blue") +
  geom_abline(slope=0.8, intercept=-0.025, lty=2, col="blue") +
  scale_x_continuous(limits=c(0, 1), oob=squish) +
  scale_y_continuous(limits=c(0, 1), oob=squish) +
  geom_hline(yintercept=0.2, lty=2, col="red") + 
  geom_vline(xintercept=0.2, lty=2, col="red") +
  annotate("text", x=0.22, y=4.5, vjust=0, hjust=0, label="LRL") +
  annotate("text", x=4.5, y=0.22, vjust=0, hjust=0, label="LRL")

```

+ Take a quick look at how the rest of the collected samples vary...

```{r}
N_data02 %>%
  filter(ParamX=="TN" & ACT.depth != "Bottom") %>%
  mutate(
    RVal2 = case_when(
      !is.na(Result.Value) ~ as.numeric(Result.Value),
      is.na(Result.Value) & !is.na(MDL) ~ as.numeric(MDL),
      is.na(Result.Value) & !is.na(LRL) ~ as.numeric(LRL),
      TRUE ~ as.numeric(NA)),
    Rflag = case_when(
      is.na(Result.Value) & !is.na(MDL) ~ "U",
      is.na(Result.Value) & !is.na(LRL) ~ "J",
      TRUE ~ as.character(NA))
    ) %>%
  ggplot(., 
         aes(x=RVal2, fill=SampFrac)) + theme_bw() +
  stat_density(na.rm=T) +
  scale_x_continuous(limits=c(NA, NA), trans = "log10",
                     breaks=c(0.01, 0.025, 0.1, 0.25, 0.5, 1, 3, 5))
```


***
***

## END
### Working pieces
```{r}
# select(EDD2_2, contains("key", ignore.case=T)) %>% names(.)
```


```{r CLOSEOUT, include=FALSE}
lastwork.date <- format(Sys.Date(), "%y%m%d")
```

**Start work date ::**  `r startwork.date`  
**Last work date ::**  `r lastwork.date`  
**Current review date ::**  `r format(Sys.Date(), "%y%m%d")`

eof

***