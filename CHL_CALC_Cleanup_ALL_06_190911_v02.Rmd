---
title: "CHL Calcs & Cleanup: 2010-2018 [V]"
author: "T.Hooker"
date: "29 August, 2019"
output: 
    html_notebook:
      df_print: paged
      theme: flatly
      toc: yes
      toc_depth: 4
      toc_float: no
---
***
<center>
> ![](WaterQuality1_72dpi_2.png)  
</center>

***
```{r STARTUP}
#options(table_counter=FALSE)
tidy_package <- c("plyr", "dplyr", "tidyr", "magrittr", "htmlTable", "tidyverse")
# 
if(!"tidyr" %in% (.packages())) {invisible(lapply(tidy_package, function(x) suppressMessages(library(x, character.only=T, quietly = T, warn.conflicts = F))))}
##
graph_package <- c("ggplot2", "scales")
if(!"ggplot2" %in% (.packages())) {invisible(lapply(graph_package, library, character.only=T, quietly = T, warn.conflicts = F))}
##
options(scipen = 999, digits = 4, stringsAsFactors = FALSE, keep.source = TRUE,
        width=87)
##
#startwork.date <- format(Sys.Date(), "%y%m%d")
knitr::opts_chunk$set(cache=TRUE)
```

## Notes

Prior work compared and compiled data from two (2) active files containing CHL data:  

i) A file for the 2010-2016 CHL data and cleanup procedures, and 
    + File :: "CHdat5_XX_4.0_190215_t1.xlsx"
ii) A file for 2017-2018 CHL data based on the more recent UPHL-LIMS system and incorporating a new HPLC method for CHL analysis
    + File :: "CHL201718_CHL08_03_noDup_dat_190226_t1.xlsx"

Goals were to align dataset-fields, compare calculations, ensure completeness of project datasets, and prepare data for import to AWQMS.  It is anticipated that much of this latter work will be performed on a project-specific basis.

[190310] :: New Notebook / Version to coninue Utah-Lake specific CHL cleanup, matchup and import to AWQMS.

+ Continuing Work Elements

**Working Datasets**

1) UTLK CHL 2010 - 2016
    + Dataframe `utlk_CHL_201016_import01`
        + Note that some updates to XLS-datafile were made to complete import process
    + UTLK-specific Activity.IDs for Lake / Non-Lake records were compiled and cleaned
        + `awqms_ACTID_UTLK_raw_02`
    + Source dataframe for CHL results [2010-2016] :: `UL1016_09`
        + Only 370 records from dataframe were transferred to import file.  Remaining records did not have a match to UTLK-specific ACT.IDs
    + XLS file for import to AWQMS :: `UTLK_CHL_201016_import01_190308_t1.xlsx`

2) UTLK CHL 2017 - 2018
    + `UL18718_05`

**Prior Work**

+ Build from $3.4/ 3.41, but apply cleanup to more recent CHL data (2017-18)
+ Completed CHL 2010-2016 UTAH LAKE import (sect. 3.5.2) from nb: `CHL_Compile_ALL_01_190306_v02.Rmd`
+ Completed CHL 2017/2018 UTAH LAKE import (sect. 6.3) from nb: `CHL_Compile_ALL_02_190310_v01.Rmd`

[190417]  

+ Prior to splitting UTLK datasets, working dataframes were:  
    + `CHL1016_01`
    + `CHL1718_01`
+ These were saved as .rds files and need to be re-imported for this notebook
    + see `DF_recovery_190417.r`


[190715]

+ Getting back to look at CHL data for the remaining records...
+ Will extract WSpur data for Suzan T.
+ **Information on WSpur project can be found in notebook "CHL_Status_ALL_03_190417_v01.Rmd"**

[190813]

+ Re-starting CHL-status review
+ ID cleanup needs
+ fix and import datasets...

[190815]  

+ Moving forward w/ "_final_" calculations of CHL concentrations for both datasets
+ Then, clean up records characterizing COMPLETENESS and Non-Detects
+ Then, prepare files for AWQMS IMPORT...
+ Current Datafiles::
  + `CHL1016_02`
  + `CHL1718_02`
  + `CHL_param.Date` :: summary table of percent of records w/ Non-Detect flags for CHLA/CHLA.total for both datasets combined.

[190829]

+ Have prioritized projects for review of Non-Detect records and possible re-calc of CHL observations from raw absorbance values retrieved from UPHL benchsheets
+ Key dates for Non-Detect review are 2013 to 2014 (possibly after, and starting in November, 2012); these benchsheets are on-order from UPHL



***

## Project Notes
Goal: Review _completeness_-related status of CHL results from both datasets / data-periods and summarize for management review

**Workspace cleanup**
+ tidy things up !
    + Backup workspace :: `190829.1.RData`
    + Cleaned up :: `190829-2.RData`

**Working dataframes [current]**

**2017/2018 Data**
  + `CHL1718_04`

**2010-2016 Data**
  + `CHL1016_04`

***
***

## Current Work

**Remaining Tasks**

1) Cleanup `PROJ_grp` == "unknown"
2) Clarify and cleanup BENTHIC samples
3) Locate last set of volumes...
4) For Non-Detect issues, pay special attention to U-flags from November, 2012 onward.  (_Not sure when this practice was corrected, but sometime around the change ot the new LIMS (2017?)_)
5) Re-examine and cleanup duplicated records...


[180929] ::

Have project prioritization table, see `"chl_project_Priority_table_190829.docx"`, summarizing details about projects (as guidelines)

Also - pay special attention to non-detect records in 2013 and 2014 (starting Nov 2012), where many of these do not seem to be reliable

[190911] ::

+ Versioned Notebook, continuing project-specific review of records for data that is intended to be imported to AWQMS


***

## 8.0 2010-16 Priority Project Data-review

+ Version df:  

```{r}
CHL1016_04 -> CHL1016_05
```

+ Priority Projects are those that will be imported to AWQMS
  + `r proj_import`

### 8.1 Identify records from priority projects

```{r}
CHL1016_05 %<>% mutate(
  import_status = case_when(
    is.na(import_status) & PROJ_grp %in% proj_import ~ "To_import",
    !is.na(import_status) ~ import_status,
    TRUE ~ as.character(NA)))


CHL1016_05 %>% {addmargins(table(.$PROJ_grp, .$import_status,
                                 useNA="ifany", deparse.level = 2))}

```


+ For records where import_status ![NA]...

```{r}
CHL1016_05 %>%
  filter(!is.na(import_status)) %>%
  {addmargins(table(.$PROJ_grp, .$PARAM_status,
                                 useNA="ifany", deparse.level = 2))}

CHL1016_05 %>%
  filter(!is.na(import_status)) %>%
  {addmargins(table(.$PROJ_grp, .$RECORD_STATUS,
                                 useNA="ifany", deparse.level = 2))} %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.5em; padding-right: 0.5em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.5em; padding-right: 0.5em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

+ `PARAM_status` mainly identifies PERI samples
+ `RECORD_STATUS` provides additional review-details for VOLs and RLs...

***
_DF cleanup_

+ Remove values for x_RVal.conc where Non_Detect == "U"

```{r}
CHL1016_05 %<>% select(RECORD_STATUS:import_status, SKey2,
                       QC_type:x_SDate,
                       MethodID2:PARAM.X,
                       Prob.Iden:RL_Units, everything())
# CHL1016_05 -> CHL1016_05.copy
# CHL1016_05 <- CHL1016_05.copy
#
CHL1016_05 %<>% mutate(
  x_RVal.conc = case_when(
    !is.na(Non_Detect) & Non_Detect == "U" &
      !is.na(x_RVal.conc) ~ as.numeric(NA),
    !is.na(x_RVal.conc) ~ x_RVal.conc)) %>%
  mutate(
    x_Units.conc = case_when(
      is.na(x_RVal.conc) ~ as.character(NA),
      !is.na(x_RVal.conc) ~ x_Units.conc,
      TRUE ~ as.character(NA)
    ))
```


***
### 8.2 Project-specific Result and Detection review

## [1] BOR

+ Number of unique sites in set ::  `r CHL1016_05 %>% filter(PROJ_grp == "BOR") %>% distinct(x_MLID) %>% nrow(.)`
+ Record data-range ::  `r CHL1016_05 %>% filter(PROJ_grp == "BOR") %>% {min(.$x_SDate, na.rm=T)}` to `r CHL1016_05 %>% filter(PROJ_grp == "BOR") %>% {max(.$x_SDate, na.rm=T)}` 
+ Unique Sample Events ::  `r CHL1016_05 %>% filter(PROJ_grp == "BOR") %>% distinct(SKey2) %>% nrow()`
+ Methods :: `r CHL1016_05 %>% filter(PROJ_grp == "BOR") %>% distinct(MethodID2) %$% .$MethodID2`

### Filt.Vol completeness

+ Records where `Filt.Vol` is **missing** :: 

```{r}
CHL1016_05 %>%
  filter(!is.na(import_status)) %>%
  filter(PROJ_grp == "BOR") %>%
  {addmargins(table(.$RECORD_STATUS, .$import_status,
                                 useNA="ifany", deparse.level = 2))}
```

+ Levels of SKey2 w/ `REVIEW_VOL` ::

```{r}
CHL1016_05 %>% filter(!is.na(import_status)) %>% filter(PROJ_grp == "BOR") %>% filter(!is.na(RECORD_STATUS)) %>% distinct(SKey2, lubridate::year(.$x_SDate)) %>% setNames(c("SKey2", "Year")) %>% arrange(Year) %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="rlc")
```

  + Records from 2010 do not need volumes (REMOVE status)

```{r}
CHL1016_05 %<>% mutate(
  RECORD_STATUS = case_when(
    PROJ_grp == "BOR" & !is.na(RECORD_STATUS) &
      lubridate::year(.$x_SDate) < 2013 ~ as.character(NA),
    !is.na(RECORD_STATUS) ~ RECORD_STATUS,
    TRUE ~ as.character(NA)  ))
```

+ Only [`r CHL1016_05 %>% filter(!is.na(import_status)) %>% filter(PROJ_grp == "BOR") %>% filter(!is.na(RECORD_STATUS)) %>% distinct(SKey2) %>% nrow()`] sample missing VOL

+ _Asked RP to look into this..._
  + data cannot be located - missing
  + change `RECORD_STATUS` to _Reject_

```{r}
CHL1016_05 %<>% mutate(
  RECORD_STATUS = case_when(
    SKey2 == "4938620.42557.2005353" & 
      is.na(Filt.Vol) &
      RECORD_STATUS == "REVIEW_VOL" ~ "REJECT_noVOL",
    !is.na(RECORD_STATUS) ~ RECORD_STATUS,
    TRUE ~ as.character(NA)))
```


### Project Non-Detects

+ Records w/ Non-Detect flags...Two key CHL-parameters
  + plot unique instances of Non-Detects vs. Results (by SKey2) for all key CHL-parameters

```{r}
CHL1016_05 %>% filter(PROJ_grp == "BOR") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, Non_Detect, .keep_all = T) %>%
  ggplot(., na.rm=T) + theme_bw() +
  facet_grid(PARAM.X ~ .,  scales = "fixed") +
  geom_text(aes(x=x_SDate, y=LRL_c, col=Non_Detect), 
            na.rm=T, size=2.5, fontface="bold", label="J") +
  geom_point(data=.data[[is.na(.data[["Non_Detect"]]),]], aes(y=0.25, x=.data[["x_SDate"]]),
             position = position_jitter(width=10, height=0), col="darkgray", size=1.5,
             alpha=0.75, na.rm=T) + 
  scale_x_date(date_labels="%Y",date_breaks = "1 year",
               limits=c(as.Date("2010-01-01"), NA)) + 
  scale_y_continuous(limits=c(0, NA)) +
  labs(x="Sample Date", y="Lower Reporting Limit (ug/L)", col="Detection \nCode",
       title="BOR: RLs and Quantitated Datapoints")
```

```{r}
CHL1016_05 %>% filter(PROJ_grp == "BOR") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, .keep_all = T) %>%
  ggplot(., na.rm=T) + theme_bw() +
  facet_grid(PARAM.X ~ .,  scales = "fixed") +
  geom_text(aes(x=x_SDate, y=LRL_c, col=Non_Detect), 
            na.rm=T, size=2.5, fontface="bold", label="J") +
  geom_point(aes(y=x_RVal.conc, x=x_SDate),
             position = position_jitter(width=10, height=0), size=1.2,
             alpha=0.75, na.rm=T, shape=1) + 
  scale_x_date(date_labels="%Y",date_breaks = "1 year",
               limits=c(as.Date("2010-01-01"), NA)) + 
  scale_y_continuous(limits=c(NA, NA), breaks=c(0.7, 2, 5, 10,20,30), oob=scales::squish) +
  coord_trans(y="log10", limy=c(0.4, 35)) +
  labs(x="Sample Date", y="Lower Reporting Limit (ug/L)", col="Detection \nCode",
       title="BOR: RLs and Quantitated Datapoints")
```

```{r}
# CHL1016_05 %>% filter(PROJ_grp == "BOR") %>%
#   filter(!is.na(Filt.Vol)) %>% 
#   filter(PARAM.X != "PHEO") %>% distinct() %>% nrow()
```


+ BOR Summary of proportion of Non-Detects in Results
  + _Ignoring records where filtration volume could not be obtained_

```{r}
CHL1016_05 %>% filter(PROJ_grp == "BOR") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  group_by(lubridate::year(x_SDate), PARAM.X) %>%
  summarize(p_ND = sprintf("%.f%%",
                           (sum(!is.na(Non_Detect), na.rm=T) / n())*100)) %>%
  as.data.frame(.) %>%
  setNames(c("Year", "CHL_param", "p_NonDetects")) %>%
  bind_rows(.,
            CHL1016_05 %>% filter(PROJ_grp == "BOR") %>%
              filter(!is.na(Filt.Vol)) %>% 
              filter(PARAM.X != "PHEO") %>%
              group_by(lubridate::year(x_SDate)) %>%
              summarize(obs = n()) %>% data.frame(., CHL_param="Obs") %>%
              setNames(c("Year", "p_NonDetects", "CHL_param")) %>%
              mutate(p_NonDetects=as.character(p_NonDetects))
            ) %>%
  spread(Year, p_NonDetects) %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="r|l|ccccccc|", caption="BOR: Proportion of records (SK2) where result is Non-Detect", total=T)
```

+ Given the sample volumes used by the BOR field team, the % of records where CHL was not-detected should be minimized compared to other projects


```{r}
CHL1016_05 %>% filter(PROJ_grp == "BOR") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  ggplot(.) + theme_bw() +
  geom_point(aes(x=Filt.Vol, y=LRL_c, col=PARAM.X), na.rm=T) +
  # geom_point(aes(x=Filt.Vol, y=x_RVal.conc, col=PARAM.X), na.rm=T,
  #            position=position_jitter(width=10, height=0), shape=5, alpha=0.7) +
  coord_trans(x="log10", y="log10", limy=c(0.25, 35), limx=c(400, 4500)) +
  scale_x_continuous(breaks=c(500, 1000, 2000, 3000, 4000)) +
  scale_y_continuous(breaks=c(0.7, 2, 5, 10, 20, 30))
```

```{r fig.height=5}
CHL1016_05 %>% filter(PROJ_grp == "BOR") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  mutate(Result_val = case_when(
    is.na(Non_Detect) &
      !is.na(x_RVal.conc) ~ x_RVal.conc,
    !is.na(Non_Detect) & Non_Detect == "U" &
      !is.na(LRL_c) ~ LRL_c,
    TRUE ~ as.numeric(NA))) %>%
  ggplot(.) + theme_bw() + facet_grid(. ~ PARAM.X, scales="fixed") +
  stat_ecdf(aes(x=Result_val, col=Non_Detect), na.rm=T, lty=1) +
  labs(x="Lower Reporting Limits (ug/L)", y="% of records below x-Value",
       col="Non-Detect") +
  scale_x_continuous(trans="log10") +
  scale_y_continuous(labels=scales::percent) +
  geom_hline(yintercept = c(0.25,0.5,0.75), lty=2, color="gray40") +
  ggtitle("Project: BOR - Distribution of RLs and RVs for Chlorophyll")
```

```{r fig.height=5}
CHL1016_05 %>% filter(PROJ_grp == "BOR") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  mutate(Result_val = case_when(
    is.na(Non_Detect) &
      !is.na(x_RVal.conc) ~ x_RVal.conc,
    !is.na(Non_Detect) & Non_Detect == "U" &
      !is.na(LRL_c) ~ LRL_c,
    TRUE ~ as.numeric(NA))) %>%
  arrange(PARAM.X, Result_val) %>% group_by(PARAM.X) %>%
  mutate(RValue_rank = percent_rank(Result_val)) %>%
  ggplot(.) + theme_bw() + facet_grid(. ~ PARAM.X, scales="fixed") +
  geom_point(aes(x=Result_val, y=RValue_rank, col=Non_Detect), na.rm=T) +
  # EnvStats::stat_n_text() +
  labs(x="CHL conc. (ug/L)", y="Result_rank") +
  scale_x_continuous(trans="log10") +
  scale_y_continuous(labels = scales::percent) +
  ggtitle("Project: BOR - Distribution of RLs and RVs for Chlorophyll") +
  scale_color_discrete(name="Detection.Condition", labels=c("Not Detected", "Quantitated"))
  #(rank(Result_val,na.last=NA))
```

***

### Bottom Line: OK

1) Single method, full time-series, 13 sites, multi-reps
2) One 1 collection missing Filtration volume (where VOL is required).  **Record Rejected**
3) Two analytes, total and pheo-corrected (lagged start); `RL-corrected > RL-total`
4) _only slight increase in RL over time_
5) TOTAL-CHL :: project-results are sensitive (approach RL); recent samples (2015+) attain lower RLs, **_There appears to be little effect of different RLs on the distribution of results along the lower aggregate deciles_**
6) CORRECTED-CHL :: results start in 2012; Non-detects account for ~ half of records, but because of large filtration volumes, RLs remain on the low end (< 3 ug/L)
7) Strong inverse (log-linear) dependence on of RL on filtration volume; **For values < 1000 mL RLs increase from 4 ug/L by factors of 2.0 vs. volume
8) Non-Detects account for ~ 75% of correted-CHL results (for this project), but < 25% of total-CHL results

> **Non-Detect Samples in 2013-15 range for `corrected_CHLA` could be reviewed for calculation accuracy / precision, but significance is low**

> _Still need to identify a good reliable measure of relative-impact to population estimates_

***
***

## [2] BRI

+ Number of unique sites in set ::  `r CHL1016_05 %>% filter(PROJ_grp == "BRI") %>% distinct(x_MLID) %>% nrow(.)`
+ Record data-range ::  `r CHL1016_05 %>% filter(PROJ_grp == "BRI") %>% {min(.$x_SDate, na.rm=T)}` to `r CHL1016_05 %>% filter(PROJ_grp == "BRI") %>% {max(.$x_SDate, na.rm=T)}` 
+ Unique Sample Events ::  `r CHL1016_05 %>% filter(PROJ_grp == "BRI") %>% distinct(SKey2) %>% nrow()`
+ Methods :: `r CHL1016_05 %>% filter(PROJ_grp == "BRI") %>% distinct(MethodID2) %$% .$MethodID2`

### Filt.Vol completeness

```{r}
CHL1016_05 %>%
  filter(PROJ_grp == "BRI") %>%
  filter(PARAM.X != "PHEO") %>%
  {addmargins(table(.$RECORD_STATUS, .$import_status,
                                 useNA="ifany", deparse.level = 2))}
```

+ Missing Filtration Volumes

`r CHL1016_05 %>% filter(PROJ_grp == "BRI") %>% filter(PARAM.X != "PHEO") %>% {addmargins(table(.$PARAM.X, !is.na(.$Filt.Vol), useNA="ifany", deparse.level=2, dnn=c("CHL_param", "Have_filtration_vol")))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))`

+ Unique levels of SKey2 where Filtration Volumes are missing

`r CHL1016_05 %>% filter(PROJ_grp == "BRI") %>% filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% distinct(SKey2, Year) %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="rl")`

_The above-listed records were investigated by TDH and RP, and no VOLs were found_

  + found file w/ RP edits of Missing Volumes
  + "`CHLA17_BRI_FieldMissing_180124_v02_RP.xlsx`"
  + _Manual corrections_

```{r}
CHL1016_05 %<>% mutate(
  Filt.Vol = case_when(
    is.na(Filt.Vol) & PROJ_grp == "BRI" &
      SKey2 %in% c("4900751.42128.201502354","4900751.42207.201504442",
                   "4901225.42163.201503117","4903030.42262.201505752",
                   "4903950.42269.201505859","4904370.42164.201503215",
                   "4904940.42227.201504874","4905040.42129.201502374",
                   "4905150.42164.201503191","4905630.42227.201504889",
                   "4905640.42130.201502479","4907120.42268.201505823",
                   "4908735.42269.201505881") ~ 500,
    is.na(Filt.Vol) & PROJ_grp == "BRI" &
      SKey2 %in% c("4901100.42205.201504300","4904110.42130.201502472") ~ 150,
    is.na(Filt.Vol) & PROJ_grp == "BRI" &
      SKey2 %in% c("4904240.42207.201504430") ~ 125,
    is.na(Filt.Vol) & PROJ_grp == "BRI" &
      SKey2 %in% c("4901225.42261.201505669") ~ 350,
    is.na(Filt.Vol) & PROJ_grp == "BRI" &
      SKey2 %in% c("4901730.42129.201502427","4903260.42206.201504420",
                   "4903400.42207.201504421","4903400.42263.201505725",
                   "4903820.42263.201505732","4904510.42165.201503269",
                   "4905030.42206.201504330","4905400.42206.201504339",
                   "4905640.42206.201504343","4906100.42206.201504437",
                   "4960740.42128.201502352") ~ 250,
    is.na(Filt.Vol) & PROJ_grp == "BRI" &
      SKey2 %in% c("4901980.42262.201505747") ~ 275,
    !is.na(Filt.Vol) ~ Filt.Vol,
    TRUE ~ as.numeric(NA)),
  RECORD_STATUS = case_when(
    PROJ_grp == "BRI" & !is.na(RECORD_STATUS) &
      !is.na(Filt.Vol) ~ as.character(NA),
    !is.na(RECORD_STATUS) ~ RECORD_STATUS,
    TRUE ~ as.character(NA))
)
```

+ Apply concentration calcs to updated records

```{r}
CHL1016_05 %<>% mutate(
  x_RVal.conc = case_when(
    is.na(x_RVal.conc) & PROJ_grp == "BRI" &
      !is.na(Filt.Vol) & is.na(Non_Detect) &
      !is.na(x_RVal) & x_Units == "mg" ~ ((x_RVal*1000) / (Filt.Vol/1000)),
    !is.na(x_RVal.conc) ~ x_RVal.conc,
    TRUE ~ as.numeric(NA)),
  LRL_c = case_when(
    PROJ_grp == "BRI" & !is.na(Filt.Vol) &
      is.na(LRL_c) & x_Units == "mg" & !is.na(Non_Detect) &
      !is.na(LRL) ~  ((LRL*1000) / (Filt.Vol/1000)),
    !is.na(LRL_c) ~ LRL_c,
    TRUE ~ as.numeric(NA)),
  MDL_c = case_when(
    PROJ_grp == "BRI" & !is.na(Filt.Vol) &
      is.na(MDL_c) & x_Units == "mg" & !is.na(Non_Detect) &
      !is.na(MDL) ~  ((MDL*1000) / (Filt.Vol/1000)),
    !is.na(MDL_c) ~ MDL_c,
    TRUE ~ as.numeric(NA))) %>% 
  mutate(
    RL_Units = case_when(
      (!is.na(LRL_c) | !is.na(MDL_c)) &
        is.na(RL_Units) ~ "ug/L",
      !is.na(RL_Units) ~ RL_Units,
      TRUE ~ as.character(NA)
      )) %>%
  select(RECORD_STATUS:import_status, x_SNum, x_MLID, x_STime, SKey2, everything())
```


```{r}
CHL1016_05 %>% filter(PROJ_grp == "BRI") %>%
  filter(PARAM.X != "PHEO") %>% distinct(PARAM.X, SKey2, .keep_all=T) %>%
  group_by(PARAM.X) %>%
  summarize(p_CHL.calc = sprintf("%.f%%",
                                 (sum(!is.na(Filt.Vol), na.rm=T) / n())*100)) %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

+ Remaining filtration volume records are not available [190904; tdh]
  + code incomplete records as REJECT

```{r}
CHL1016_05 %<>% mutate(
  RECORD_STATUS = case_when(
    PROJ_grp == "BRI" & is.na(Filt.Vol) &
      RECORD_STATUS == "REVIEW_VOL" ~ "REJECT_noVOL",
    !is.na(RECORD_STATUS) ~ RECORD_STATUS,
    TRUE ~ as.character(NA)))
```

### Project Non-Detects

+ Proportion of Records w/ Non-Detect flags

```{r}
CHL1016_05 %>% filter(PROJ_grp == "BRI") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, Non_Detect, .keep_all = T) %>%
  ggplot(., na.rm=T) + theme_bw() +
  facet_grid(PARAM.X ~ .,  scales = "fixed") +
  geom_text(aes(x=x_SDate, y=LRL_c, col=Non_Detect), 
            na.rm=T, size=2.5, fontface="bold", label="J") +
  geom_point(data=.data[[is.na(.data[["Non_Detect"]]),]], aes(y=0.25, x=.data[["x_SDate"]]),
             position = position_jitter(width=10, height=0), col="darkgray", size=1.5,
             alpha=0.75, na.rm=T) +
  scale_x_date(date_labels="%Y",date_breaks = "1 year",
               limits=c(as.Date("2014-01-01"), NA)) + 
  scale_y_continuous(limits=c(0.2, NA), trans="log10") +
  labs(x="Sample Date", y="Lower Reporting Limit (ug/L)", col="Detection \nCode",
       title="BRI: RLs and occurrence of quantitated Datapoints")
```

+ Due to small sample filtration volumes, some RLs are obscenely high

```{r}
CHL1016_05 %>% filter(PROJ_grp == "BRI") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, .keep_all = T) %>%
  ggplot(., na.rm=T) + theme_bw() +
  geom_text(aes(x=x_SDate, y=LRL_c, col=Non_Detect), 
            na.rm=T, size=2.5, fontface="bold", label="J") +
  facet_grid(PARAM.X ~ .,  scales = "fixed") +
  geom_point(aes(y=x_RVal.conc, x=x_SDate),
             position = position_jitter(width=10, height=0), size=1.2,
             alpha=0.75, na.rm=T, shape=1) + 
  scale_x_date(date_labels="%Y",date_breaks = "1 year",
               limits=c(as.Date("2014-01-01"), NA)) + 
  scale_y_continuous(limits=c(NA, NA), breaks=c(5, 20, 50, 200)) +
  coord_trans(y="log10", limy=c(2.5, 250)) +
  labs(x="Sample Date", y="Lower Reporting Limit (ug/L)", col="Detection \nCode",
       title="BRI: RLs and Quantitated Datapoints")
```

**Nearly complete overlap of quantitated results and RLs**  
  

+ Proportion of Records w/ Non-Detect flags
  + _Ignoring records where filtration volume is unavailable_

```{r}
CHL1016_05 %>% filter(PROJ_grp == "BRI") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  group_by(lubridate::year(x_SDate), PARAM.X) %>%
  summarize(p_ND = sprintf("%.f%%",
                           (sum(!is.na(Non_Detect), na.rm=T) / n())*100)) %>%
  as.data.frame(.) %>%
  setNames(c("Year", "CHL_param", "p_NonDetects")) %>%
  bind_rows(.,
            CHL1016_05 %>% filter(PROJ_grp == "BRI") %>%
              filter(!is.na(Filt.Vol)) %>% 
              filter(PARAM.X != "PHEO") %>%
              group_by(lubridate::year(x_SDate)) %>%
              summarize(obs = n()) %>% data.frame(., CHL_param="Obs") %>%
              setNames(c("Year", "p_NonDetects", "CHL_param")) %>%
              mutate(p_NonDetects=as.character(p_NonDetects))
            ) %>%
  spread(Year, p_NonDetects) %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="r|l|cc|", caption="BRI: Proportion of records (SK2) where result is Non-Detect", total=T)
```

```{r}
CHL1016_05 %>% filter(PROJ_grp == "BRI") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  ggplot(.) + theme_bw() +
  geom_point(aes(x=Filt.Vol, y=LRL_c, col=PARAM.X), na.rm=T) +
  # geom_point(aes(x=Filt.Vol, y=x_RVal.conc, col=PARAM.X), na.rm=T,
  #            position=position_jitter(width=10, height=0), shape=5, alpha=0.7) +
  coord_trans(x="log10", y="log10", limy=c(0.25, 1200), limx=c(10, 1500)) +
  scale_x_continuous(breaks=c(25, 100, 550, 1000)) +
  scale_y_continuous(breaks=c(0.7, 2, 5, 10, 50, 100, 500))
```

+ Strong negative inverse (log-log) dependebnce of RL on filtration volume

```{r}
CHL1016_05 %>% filter(PROJ_grp == "BRI") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  mutate(Result_val = case_when(
    is.na(Non_Detect) &
      !is.na(x_RVal.conc) ~ x_RVal.conc,
    !is.na(Non_Detect) & Non_Detect == "U" &
      !is.na(LRL_c) ~ LRL_c,
    TRUE ~ as.numeric(NA))) %>%
  ggplot(.) + theme_bw() + facet_grid(. ~ PARAM.X, scales="fixed") +
  stat_ecdf(aes(x=Result_val, col=Non_Detect), na.rm=T, lty=1) +
  labs(x="Lower Reporting Limits (ug/L)", y="% of records below x-Value",
       col="Non-Detect") +
  scale_x_continuous(trans="log10") +
  scale_y_continuous(labels=scales::percent) +
  geom_hline(yintercept = c(0.25,0.5,0.75), lty=2, color="gray40") +
  ggtitle("Project: BRI - Distribution of RLs and RVs for Chlorophyll")
```

```{r}
CHL1016_05 %>% filter(PROJ_grp == "BRI") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  mutate(Result_val = case_when(
    is.na(Non_Detect) &
      !is.na(x_RVal.conc) ~ x_RVal.conc,
    !is.na(Non_Detect) & Non_Detect == "U" &
      !is.na(LRL_c) ~ LRL_c,
    TRUE ~ as.numeric(NA))) %>%
  arrange(PARAM.X, Result_val) %>% group_by(PARAM.X) %>%
  mutate(RValue_rank = percent_rank(Result_val)) %>%
  ggplot(.) + theme_bw() + facet_grid(. ~ PARAM.X, scales="fixed") +
  geom_point(aes(x=Result_val, y=RValue_rank, col=Non_Detect), na.rm=T) +
  # EnvStats::stat_n_text() +
  labs(x="CHL conc. (ug/L)", y="Result_rank") +
  scale_x_continuous(trans="log10") +
  scale_y_continuous(labels = scales::percent) +
  ggtitle("Project: BRI - Distribution of RLs and RVs for Chlorophyll") +
  scale_color_discrete(name="Detection.Condition", labels=c("Not Detected", "Quantitated"))
```

### Bottom Line: REVW-Non-Detects (-blanks)

1) Single method, many sites, multiple reps
2) Some collections have **no sample volume** and are **rejected** :: `r CHL1016_05 %>% filter(PROJ_grp == "BRI") %>% filter(is.na(Filt.Vol)) %>% distinct(SKey2) %>% nrow(.)`
3) total completeness ~ 99%
4) Corrected and Uncorrected CHL recorded over entire set
5) No apparent change in RLs over 1-year period
6) Non-detects account for well over 80% of records for CHL-corrected, as censored data

> **Project was sampled during period of time where confidence is low re: accuracy / precision of Non-Detect flagged records, particularly for the corrected-CHL measures.  Samples that are _not Blanks_ should be prioritized for lab-benchsheet-review**

***

## [3] CUWJ

+ Number of unique sites in set ::  `r CHL1016_05 %>% filter(PROJ_grp == "CUWJ") %>% distinct(x_MLID) %>% nrow(.)`
+ Record data-range ::  `r CHL1016_05 %>% filter(PROJ_grp == "CUWJ") %>% {min(.$x_SDate, na.rm=T)}` to `r CHL1016_05 %>% filter(PROJ_grp == "CUWJ") %>% {max(.$x_SDate, na.rm=T)}` 
+ Unique Sample Events ::  `r CHL1016_05 %>% filter(PROJ_grp == "CUWJ") %>% distinct(SKey2) %>% nrow()`
+ Methods :: `r CHL1016_05 %>% filter(PROJ_grp == "CUWJ") %>% distinct(MethodID2) %$% .$MethodID2`
+ Params :: `r CHL1016_05 %>% filter(PROJ_grp == "CUWJ") %>% distinct(PARAM.X) %$% .$PARAM.X`

`r CHL1016_05 %>% filter(PROJ_grp == "CUWJ") %>% {addmargins(table(.$MethodID2, .$PARAM.X, useNA="ifany", deparse.level=2))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))`

### Filt.Vol completeness

```{r}
CHL1016_05 %>%
  filter(PROJ_grp == "CUWJ") %>%
  filter(!PARAM.X %in% c("PHEO", "CHLB")) %>%
  {addmargins(table(.$RECORD_STATUS, .$import_status,
                                 useNA="ifany", deparse.level = 2))}
```

+ Missing Filtration Volumes

`r CHL1016_05 %>% filter(PROJ_grp == "CUWJ") %>% filter(!PARAM.X %in% c("PHEO", "CHLB")) %>% distinct(SKey2,PARAM.X, lubridate::year(.$x_SDate), .keep_all=T) %>% {addmargins(table(.$PARAM.X, !is.na(.$Filt.Vol), useNA="ifany", deparse.level=2, dnn=c("CHL_param", "Have_filtration_vol")))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))`

```{r}
CHL1016_05 %>% filter(PROJ_grp == "CUWJ") %>%
  filter(!PARAM.X %in% c("PHEO", "CHLB")) %>% distinct(PARAM.X, SKey2, .keep_all=T) %>%
  group_by(PARAM.X) %>%
  summarize(p_CHL.calc = sprintf("%.f%%",
                                 (sum(!is.na(x_Units.conc), na.rm=T) / n())*100)) %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

+ Time-periods where volumes missing

```{r}
CHL1016_05 %>% filter(PROJ_grp == "CUWJ") %>%
  filter(!PARAM.X %in% c("PHEO", "CHLB")) %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, Filt.Vol, .keep_all = T) %>%
  group_by(lubridate::year(x_SDate), PARAM.X) %>%
  summarize(p_NoVol = sprintf("%.f%%",
                           (sum(!is.na(Filt.Vol), na.rm=T) / n())*100)) %>%
  as.data.frame(.) %>%
  setNames(c("Year", "CHL_param", "p_NoFiltVOL")) %>%
  spread(Year, p_NoFiltVOL) %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), caption="Percent of records where filtration volume was not reported", tfoot="Filt. volumes required for records after 2013, optional before then")
```

> **No additional filtration-volumes needed**

### Project Non-detects

+ Proportion of Records w/ Non-Detect flags
  + Can ignore the filtration-volume field for this project-group

```{r}
CHL1016_05 %>% filter(PROJ_grp == "CUWJ") %>%
  filter(!PARAM.X %in% c("PHEO", "CHLB")) %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, .keep_all = T) %>%
  ggplot(., na.rm=T) + theme_bw() +
  facet_grid(MethodID2 ~ .,  scales = "fixed") +
  geom_text(aes(x=x_SDate, y=LRL_c, col=Non_Detect), 
            na.rm=T, size=2.5, fontface="bold", label="J") +
  geom_point(data=.data[[is.na(.data[["Non_Detect"]]),]], aes(y=0.25, x=.data[["x_SDate"]]),
             position = position_jitter(width=10, height=0), col="darkgray", size=1.5,
             alpha=0.75, na.rm=T) +
  scale_x_date(date_labels="%Y",date_breaks = "1 year",
               limits=c(as.Date("2010-01-01"), NA)) + 
  scale_y_continuous(limits=c(0, NA)) +
  labs(x="Sample Date", y="Lower Reporting Limit (ug/L)", col="Detection \nCode",
       title="CUWJ: RLs and Quantitated Datapoints")
```

+ Very few records meeting the RL

```{r}
CHL1016_05 %>% filter(PROJ_grp == "CUWJ") %>%
  filter(!PARAM.X %in% c("PHEO", "CHLB")) %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, .keep_all = T) %>%
  group_by(lubridate::year(x_SDate), PARAM.X) %>%
  summarize(p_ND = sprintf("%.f%%",
                           (sum(!is.na(Non_Detect), na.rm=T) / n())*100)) %>%
  as.data.frame(.) %>%
  setNames(c("Year", "CHL_param", "p_NonDetects")) %>%
  spread(Year, p_NonDetects) %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

+ Table, CHLA only, uniq(SKey2) :: Non-Detects vs. Vols

```{r}
CHL1016_05 %>% filter(PROJ_grp == "CUWJ") %>%
  filter(!PARAM.X %in% c("PHEO", "CHLB")) %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, .keep_all = T) %>%
  {(table(is.na(.$Non_Detect), is.na(.$Filt.Vol),
                    useNA="ifany", deparse.level = 2, dnn=c("Non-Detect", "No Filt-Vols")))}
```

### Bottom Line: OK

> This project `CUWJ` is suffiently complete.  No additional volumes required, and no questionable RLs

## [4] JRULI

+ Number of unique sites in set ::  `r CHL1016_05 %>% filter(PROJ_grp == "JRULI") %>% distinct(x_MLID) %>% nrow(.)`
+ Record data-range ::  `r CHL1016_05 %>% filter(PROJ_grp == "JRULI") %>% {min(.$x_SDate, na.rm=T)}` to `r CHL1016_05 %>% filter(PROJ_grp == "JRULI") %>% {max(.$x_SDate, na.rm=T)}` 
+ Unique Sample Events ::  `r CHL1016_05 %>% filter(PROJ_grp == "JRULI") %>% distinct(SKey2) %>% nrow()`
+ Methods :: `r CHL1016_05 %>% filter(PROJ_grp == "JRULI") %>% distinct(MethodID2) %$% .$MethodID2`
+ Params :: `r CHL1016_05 %>% filter(PROJ_grp == "JRULI") %>% distinct(PARAM.X) %$% .$PARAM.X`
  + _These parameter names are equivalent_

### Filt.Vol completeness

```{r}
CHL1016_05 %>%
  filter(PROJ_grp == "JRULI") %>%
  filter(PARAM.X != "PHEO") %>%
  {addmargins(table(.$RECORD_STATUS, .$import_status,
                                 useNA="ifany", deparse.level = 2))}
```

+ Some records _may_ have been imported w/ the UTLK chl group, but continue all work and evaluate this at the end, prior to import to awqms

+ Missing Filtration Volumes

`r CHL1016_05 %>% filter(PROJ_grp == "JRULI") %>% filter(PARAM.X != "PHEO") %>% {addmargins(table(.$PARAM.X, !is.na(.$Filt.Vol), useNA="ifany", deparse.level=2, dnn=c("CHL_param", "Have_filtration_vol")))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))`

+ Unique levels of SKey2 where Filtration Volumes are missing
  + See table above, `r CHL1016_05 %>% filter(PROJ_grp == "JRULI") %>% filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% distinct(SKey2, Year) %>% nrow(.)` records

+ Unique MLIDs where Filtration Volumes are missing

`r CHL1016_05 %>% filter(PROJ_grp == "JRULI") %>% filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% {addmargins(table(.$x_MLID, .$Year, useNA="ifany"))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="r|ccc|c")`

> **None of these sample dates are during the time-period when filtration-volume is required**
> **No action required**

### Project Non-Detects

+ Proportion of Records w/ Non-Detect flags
  + Can ignore the filtration-volume field for this project-group

```{r}
CHL1016_05 %>% filter(PROJ_grp == "JRULI") %>%
  filter(!PARAM.X %in% c("PHEO", "CHLB")) %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, .keep_all = T) %>%
  ggplot(., na.rm=T) + theme_bw() +
  facet_grid(MethodID2 ~ .,  scales = "fixed") +
  geom_text(aes(x=x_SDate, y=LRL_c, col=Non_Detect), 
            na.rm=T, size=2.5, fontface="bold", label="J") +
  geom_point(data=.data[[is.na(.data[["Non_Detect"]]),]], aes(y=0.25, x=.data[["x_SDate"]]),
             position = position_jitter(width=10, height=0), col="darkgray", size=1.5,
             alpha=0.75, na.rm=T) +
  scale_x_date(date_labels="%Y",date_breaks = "1 year",
               limits=c(as.Date("2010-01-01"), NA)) + 
  scale_y_continuous(limits=c(0, NA)) +
  labs(x="Sample Date", y="Lower Reporting Limit (ug/L)", col="Detection \nCode",
       title="JRULI: RLs and Quantitated Datapoints")
```

+ Up to 1/3 of records are non-detects; _most of these sites are streams_

```{r}
CHL1016_05 %>% filter(PROJ_grp == "JRULI") %>%
  filter(!PARAM.X %in% c("PHEO", "CHLB")) %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, .keep_all = T) %>%
  group_by(lubridate::year(x_SDate), PARAM.X) %>%
  summarize(p_ND = sprintf("%.f%%",
                           (sum(!is.na(Non_Detect), na.rm=T) / n())*100)) %>%
  as.data.frame(.) %>%
  setNames(c("Year", "CHL_param", "p_NonDetects")) %>%
  spread(Year, p_NonDetects) %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

### Bottom Line: OK

> JRULI project is sufficiently complete (volumes) and sensitive (%RLs); on additional action needed

***

## [5] LAKES

+ Number of unique sites in set ::  `r CHL1016_05 %>% filter(PROJ_grp == "LAKES") %>% distinct(x_MLID) %>% nrow(.)`
+ Record data-range ::  `r CHL1016_05 %>% filter(PROJ_grp == "LAKES") %>% {min(.$x_SDate, na.rm=T)}` to `r CHL1016_05 %>% filter(PROJ_grp == "LAKES") %>% {max(.$x_SDate, na.rm=T)}` 
+ Unique Sample Events ::  `r CHL1016_05 %>% filter(PROJ_grp == "LAKES") %>% distinct(SKey2) %>% nrow()`
+ Methods :: `r CHL1016_05 %>% filter(PROJ_grp == "LAKES") %>% distinct(MethodID2) %$% .$MethodID2`
+ Params :: `r CHL1016_05 %>% filter(PROJ_grp == "LAKES") %>% distinct(PARAM.X) %$% .$PARAM.X`
  

### Filt.Vol completeness

```{r}
CHL1016_05 %>%
  filter(PROJ_grp == "LAKES") %>%
  filter(PARAM.X != "PHEO") %>%
  {addmargins(table(.$RECORD_STATUS, .$import_status,
                                 useNA="ifany", deparse.level = 2))}
```

+ Some records _may_ have been imported w/ the UTLK chl group, but continue all work and evaluate this at the end, prior to import to awqms

+ Missing Filtration Volumes

`r CHL1016_05 %>% filter(PROJ_grp == "LAKES") %>% filter(PARAM.X != "PHEO") %>% {addmargins(table(.$PARAM.X, !is.na(.$Filt.Vol), useNA="ifany", deparse.level=2, dnn=c("CHL_param", "Have_filtration_vol")))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))`

+ Unique levels of SKey2 where Filtration Volumes are missing

`r CHL1016_05 %>% filter(PROJ_grp == "LAKES") %>% filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% distinct(SKey2, Year) %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="rlc")`

+ Unique MLIDs where Filtration Volumes are missing

`r CHL1016_05 %>% filter(PROJ_grp == "LAKES") %>% filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% {addmargins(table(.$x_MLID, .$Year, useNA="ifany"))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="r|ccc|c")`

+ Records after late-September (2012) need filtration volumes to support CHL-concentration calculations
  + RE-code `RECORD_STATUS`, omit "REVIEW_VOL" elements if sample date < sep 2012

```{r}
# CHL1016_05 -> CHL1016_05.copy
# CHL1016_05 <- CHL1016_05.copy
```

```{r}
CHL1016_05 %>% filter(PROJ_grp == "LAKES" & !is.na(RECORD_STATUS)) %>% distinct(RECORD_STATUS) %$% .$RECORD_STATUS
```

```{r}
CHL1016_05 %<>% mutate(
  RECORD_STATUS = case_when(
    PROJ_grp == "LAKES" & 
      RECORD_STATUS == "REVIEW_VOL" & 
      is.na(Filt.Vol) & 
      x_SDate < as.Date("2012-09-20") ~ as.character(NA),
    !is.na(RECORD_STATUS) ~ RECORD_STATUS,
    TRUE ~ as.character(NA)))
```

+ Re-run table using `RECORD_STATUS` category (_sites w/ missing filt. volume_)

`r CHL1016_05 %>% filter(PROJ_grp == "LAKES" & RECORD_STATUS == "REVIEW_VOL") %>% filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% {addmargins(table(.$x_MLID, .$Year, useNA="ifany"))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="r|ccc|c")`

+ Unique SKey2 levels ::

`r CHL1016_05 %>% filter(PROJ_grp == "LAKES" & RECORD_STATUS == "REVIEW_VOL") %>% filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% {addmargins(table(.$SKey2, .$Year, useNA="ifany"))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="r|cccc|c")`

#### Filt. Vol research & corrections

+ **2013**

```{r}
CHL1016_05 %>% 
  filter(PROJ_grp == "LAKES" & RECORD_STATUS == "REVIEW_VOL") %>% 
  filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>%
  filter(is.na(Filt.Vol) & Year == 2013) %>% distinct(SKey2) %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

> 2013: Confirmed, no volumes available for two records

+ **2014**

```{r}
CHL1016_05 %>% 
  filter(PROJ_grp == "LAKES" & RECORD_STATUS == "REVIEW_VOL") %>% 
  filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>%
  filter(is.na(Filt.Vol) & Year == 2014) %>% distinct(SKey2) %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

> 2014: Confirmed, no volumes available for two records

+ group volumes range from 100 to 500; 250 and 500 mL most common

+ **2015**

```{r}
CHL1016_05 %>% 
  filter(PROJ_grp == "LAKES" & RECORD_STATUS == "REVIEW_VOL") %>% 
  filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>%
  filter(is.na(Filt.Vol) & Year == 2015) %>% distinct(SKey2, x_SDate) %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

+ 250 mL common for trip...

> 2015: confirmed, no vols available

+ **2016**

```{r}
CHL1016_05 %>% 
  filter(PROJ_grp == "LAKES" & RECORD_STATUS == "REVIEW_VOL") %>% 
  filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>%
  filter(is.na(Filt.Vol) & Year == 2016) %>% distinct(SKey2, x_SDate) %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

+ Found volume edits for these sets (file:: `"W:\2016_Data\2016_Hydrodata\2016_Hydro_AWQMS_Import\Imported\2016_DWQ_Lakes_Q3_Field_Combined.xlsx"`)
  + 250 mL (from trip sheets, etc.; RB comments)

+ **Add vols for LAKES 2016 samples (above)**

```{r}
CHL1016_05 %<>% mutate(
  Filt.Vol = case_when(
    RECORD_STATUS == "REVIEW_VOL" &
      PROJ_grp == "LAKES" &
      lubridate::year(.$x_SDate) == 2016 &
      is.na(Filt.Vol) & 
      SKey2 %in% c("4900460.42585.2011077", "4940610.42578.2010710",
                   "4940720.42578.2010720", "5941450.42579.2010727",
                   "5941451.42579.2010736") ~ 250,
    !is.na(Filt.Vol) ~ Filt.Vol,
    TRUE ~ as.numeric(NA)),
  RECORD_STATUS = case_when(
    RECORD_STATUS == "REVIEW_VOL" &
      PROJ_grp == "LAKES" &
      lubridate::year(.$x_SDate) == 2016 &
      SKey2 %in% c("4900460.42585.2011077", "4940610.42578.2010710",
                   "4940720.42578.2010720", "5941450.42579.2010727",
                   "5941451.42579.2010736") ~ as.character(NA),
    !is.na(RECORD_STATUS) ~ RECORD_STATUS,
    TRUE ~ as.character(NA))
)
# CHL1016_05 %>%
#   filter(RECORD_STATUS == "REVIEW_VOL" &
#       PROJ_grp == "LAKES" &
#       lubridate::year(.$x_SDate) == 2016 &
#       is.na(Filt.Vol)) %>% distinct(SKey2, x_SDate)
```

### Project Non-Detects

+ Proportion of Records w/ Non-Detect flags
  + Can ignore the filtration-volume field for this project-group

```{r}
CHL1016_05 %>% filter(PROJ_grp == "LAKES") %>%
  filter(!PARAM.X %in% c("PHEO", "CHLB")) %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, .keep_all = T) %>%
  ggplot(., na.rm=T) + theme_bw() +
  facet_grid(MethodID2 ~ .,  scales = "fixed") +
  geom_text(aes(x=x_SDate, y=LRL_c, col=Non_Detect), 
            na.rm=T, size=2.5, fontface="bold", label="J") +
  geom_point(data=.data[[is.na(.data[["Non_Detect"]]),]], aes(y=0.25, x=.data[["x_SDate"]]),
             position = position_jitter(width=10, height=0), col="darkgray", size=1.5,
             alpha=0.75, na.rm=T) +
  scale_x_date(date_labels="%Y",date_breaks = "1 year",
               limits=c(as.Date("2010-01-01"), NA)) + 
  scale_y_continuous(limits=c(0, NA)) +
  labs(x="Sample Date", y="Lower Reporting Limit (ug/L)", col="Detection \nCode",
       title="LAKES: RLs and Quantitated Datapoints")
```

+ Few records meeting the RL

```{r}
CHL1016_05 %>% filter(PROJ_grp == "LAKES") %>%
  filter(!PARAM.X %in% c("PHEO", "CHLB")) %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, .keep_all = T) %>%
  group_by(lubridate::year(x_SDate), PARAM.X) %>%
  summarize(p_ND = sprintf("%.f%%",
                           (sum(!is.na(Non_Detect), na.rm=T) / n())*100)) %>%
  as.data.frame(.) %>%
  setNames(c("Year", "CHL_param", "p_NonDetects")) %>%
  spread(Year, p_NonDetects) %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

+ Table, CHLA only, uniq(SKey2) :: Non-Detects vs. Vols

```{r}
CHL1016_05 %>% filter(PROJ_grp == "LAKES") %>%
  filter(!PARAM.X %in% c("PHEO", "CHLB")) %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, .keep_all = T) %>%
  {(table(is.na(.$Non_Detect), is.na(.$Filt.Vol),
                    useNA="ifany", deparse.level = 2, dnn=c("Non-Detect", "No Filt-Vols")))}
```

### Bottom Line: REVW-Non-Detects (-blanks)

> LAKES project has sufficient Filtration-Volume completion, but the RLs may need to be examined, particularly in 2013-15

***

## [6] NPS

+ Number of unique sites in set ::  `r CHL1016_05 %>% filter(PROJ_grp == "NPS") %>% distinct(x_MLID) %>% nrow(.)`
+ Record data-range ::  `r CHL1016_05 %>% filter(PROJ_grp == "NPS") %>% {min(.$x_SDate, na.rm=T)}` to `r CHL1016_05 %>% filter(PROJ_grp == "NPS") %>% {max(.$x_SDate, na.rm=T)}` 
+ Unique Sample Events ::  `r CHL1016_05 %>% filter(PROJ_grp == "NPS") %>% distinct(SKey2) %>% nrow()`
+ Methods :: `r CHL1016_05 %>% filter(PROJ_grp == "NPS") %>% distinct(MethodID2) %$% .$MethodID2`
+ Params :: `r CHL1016_05 %>% filter(PROJ_grp == "NPS") %>% distinct(PARAM.X) %$% .$PARAM.X`
  

### Filt.Vol completeness

```{r}
CHL1016_05 %>%
  filter(PROJ_grp == "NPS") %>%
  filter(PARAM.X != "PHEO") %>%
  {addmargins(table(.$RECORD_STATUS, .$import_status,
                                 useNA="ifany", deparse.level = 2))}
```

+ Some records _may_ have been imported w/ the UTLK chl group, but continue all work and evaluate this at the end, prior to import to awqms

+ Missing Filtration Volumes

`r CHL1016_05 %>% filter(PROJ_grp == "NPS") %>% filter(PARAM.X != "PHEO") %>% {addmargins(table(.$PARAM.X, !is.na(.$Filt.Vol), useNA="ifany", deparse.level=2, dnn=c("CHL_param", "Have_filtration_vol")))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))`

+ Unique levels of SKey2 where Filtration Volumes are missing

`r CHL1016_05 %>% filter(PROJ_grp == "NPS") %>% filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% distinct(SKey2, Year) %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="rlc")`

### Bottom Line: Ignore/Skip

> Only 1 sample, no volumes found in e-records; No Action - skip

***

## [7] SBCI

+ Number of unique sites in set ::  `r CHL1016_05 %>% filter(PROJ_grp == "SBCI") %>% distinct(x_MLID) %>% nrow(.)`
+ Record data-range ::  `r CHL1016_05 %>% filter(PROJ_grp == "SBCI") %>% {min(.$x_SDate, na.rm=T)}` to `r CHL1016_05 %>% filter(PROJ_grp == "SBCI") %>% {max(.$x_SDate, na.rm=T)}` 
+ Unique Sample Events ::  `r CHL1016_05 %>% filter(PROJ_grp == "SBCI") %>% distinct(SKey2) %>% nrow()`
+ Methods :: `r CHL1016_05 %>% filter(PROJ_grp == "SBCI") %>% distinct(MethodID2) %$% .$MethodID2`
+ Params :: `r CHL1016_05 %>% filter(PROJ_grp == "SBCI") %>% distinct(PARAM.X) %$% .$PARAM.X`
  

### Filt.Vol completeness

```{r}
CHL1016_05 %>%
  filter(PROJ_grp == "SBCI") %>%
  filter(PARAM.X != "PHEO") %>%
  {addmargins(table(.$RECORD_STATUS, .$import_status,
                                 useNA="ifany", deparse.level = 2))}
```

+ Missing Filtration Volumes

`r CHL1016_05 %>% filter(PROJ_grp == "SBCI") %>% filter(PARAM.X != "PHEO") %>% {addmargins(table(.$PARAM.X, !is.na(.$Filt.Vol), useNA="ifany", deparse.level=2, dnn=c("CHL_param", "Have_filtration_vol")))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))`


+ No volume information found for sample missing Filt.Vol; comment says no CHL sample was collected; 
+ **IGNORE Volume issue**

### Project Non-Detects

+ Proportion of Records w/ Non-Detect flags
  + Can ignore the filtration-volume field for this project-group

```{r}
CHL1016_05 %>% filter(PROJ_grp == "SBCI") %>%
  filter(!PARAM.X %in% c("PHEO", "CHLB")) %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, .keep_all = T) %>%
  ggplot(., na.rm=T) + theme_bw() +
  facet_grid(MethodID2 ~ .,  scales = "fixed") +
  geom_text(aes(x=x_SDate, y=LRL_c, col=Non_Detect), 
            na.rm=T, size=2.5, fontface="bold", label="J") +
  geom_point(data=.data[[is.na(.data[["Non_Detect"]]),]], aes(y=0.25, x=.data[["x_SDate"]]),
             position = position_jitter(width=10, height=0), col="darkgray", size=1.5,
             alpha=0.75, na.rm=T) +
  scale_x_date(date_labels="%Y",date_breaks = "1 year",
               limits=c(as.Date("2013-10-01"), NA)) + 
  scale_y_continuous(limits=c(0, NA)) +
  labs(x="Sample Date", y="Lower Reporting Limit (ug/L)", col="Detection \nCode",
       title="SBCI: RLs and Quantitated Datapoints")
```

+ Few records meeting the RL

```{r}
CHL1016_05 %>% filter(PROJ_grp == "SBCI") %>%
  filter(!PARAM.X %in% c("PHEO", "CHLB")) %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, .keep_all = T) %>%
  group_by(lubridate::year(x_SDate), PARAM.X) %>%
  summarize(p_ND = sprintf("%.f%%",
                           (sum(!is.na(Non_Detect), na.rm=T) / n())*100)) %>%
  as.data.frame(.) %>%
  setNames(c("Year", "CHL_param", "p_NonDetects")) %>%
  spread(Year, p_NonDetects) %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

+ Table, CHLA only, uniq(SKey2) :: Non-Detects vs. Vols

```{r}
CHL1016_05 %>% filter(PROJ_grp == "SBCI") %>%
  filter(!PARAM.X %in% c("PHEO", "CHLB")) %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, .keep_all = T) %>%
  {(table(is.na(.$Non_Detect), is.na(.$Filt.Vol),
                    useNA="ifany", deparse.level = 2, dnn=c("Non-Detect", "No Filt-Vols")))}
```

### Bottom Line: REVW-Non-Detects (-blanks)

> These Non-Detects should be reviewed...

***

## [8] TMDLLAKES

+ Number of unique sites in set ::  `r CHL1016_05 %>% filter(PROJ_grp == "TMDLLAKES") %>% distinct(x_MLID) %>% nrow(.)`
+ Record data-range ::  `r CHL1016_05 %>% filter(PROJ_grp == "TMDLLAKES") %>% {min(.$x_SDate, na.rm=T)}` to `r CHL1016_05 %>% filter(PROJ_grp == "TMDLLAKES") %>% {max(.$x_SDate, na.rm=T)}` 
+ Unique Sample Events ::  `r CHL1016_05 %>% filter(PROJ_grp == "TMDLLAKES") %>% distinct(SKey2) %>% nrow()`
+ Methods :: `r CHL1016_05 %>% filter(PROJ_grp == "TMDLLAKES") %>% distinct(MethodID2) %$% .$MethodID2`
+ Params :: `r CHL1016_05 %>% filter(PROJ_grp == "TMDLLAKES") %>% distinct(PARAM.X) %$% .$PARAM.X`
  

### Filt.Vol completeness

```{r}
CHL1016_05 %>%
  filter(PROJ_grp == "TMDLLAKES") %>%
  filter(PARAM.X != "PHEO") %>%
  {addmargins(table(.$RECORD_STATUS, .$import_status,
                                 useNA="ifany", deparse.level = 2))}
```

+ Missing Filtration Volumes

`r CHL1016_05 %>% filter(PROJ_grp == "TMDLLAKES") %>% filter(PARAM.X != "PHEO") %>% {addmargins(table(.$PARAM.X, !is.na(.$Filt.Vol), useNA="ifany", deparse.level=2, dnn=c("CHL_param", "Have_filtration_vol")))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))`

+ Unique MLIDs where Filtration Volumes are missing

`r CHL1016_05 %>% filter(PROJ_grp == "TMDLLAKES") %>% filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% distinct(SKey2, .keep_all=T) %>% {addmargins(table(.$x_MLID, .$Year, useNA="ifany"))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="r|ccccc|c")`

```{r}
CHL1016_05 %>% filter(PROJ_grp == "TMDLLAKES" & !is.na(RECORD_STATUS)) %>% distinct(RECORD_STATUS) %$% .$RECORD_STATUS
```

```{r}
CHL1016_05 %<>% mutate(
  RECORD_STATUS = case_when(
    PROJ_grp == "TMDLLAKES" & 
      RECORD_STATUS == "REVIEW_VOL" & 
      is.na(Filt.Vol) & 
      x_SDate < as.Date("2012-09-20") ~ as.character(NA),
    !is.na(RECORD_STATUS) ~ RECORD_STATUS,
    TRUE ~ as.character(NA)))
```

+ Re-run table using `RECORD_STATUS` category (_sites w/ missing filt. volume_)

`r CHL1016_05 %>% filter(PROJ_grp == "TMDLLAKES" & RECORD_STATUS == "REVIEW_VOL") %>% filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% {addmargins(table(.$x_MLID, .$Year, useNA="ifany"))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="r|ccc|c")`

+ Unique SKey2 levels ::

`r CHL1016_05 %>% filter(PROJ_grp == "TMDLLAKES" & RECORD_STATUS == "REVIEW_VOL") %>% filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% {addmargins(table(.$SKey2, .$Year, useNA="ifany"))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="r|cccc|c")`

```{r}
CHL1016_05 %>% 
  filter(PROJ_grp == "TMDLLAKES" & RECORD_STATUS == "REVIEW_VOL") %>% 
  filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>%
  filter(is.na(Filt.Vol) & Year > 2013) %>% distinct(SKey2, x_SDate) %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

+ Found vols for 2 records in 2015 (May):
  + 4937201.42144.201502807	
  + 4937202.42144.201502806
  + 250 mL filtered

+ **Add vols for TMDLLAKES 2015 samples (above)**

```{r}
CHL1016_05 %<>% mutate(
  Filt.Vol = case_when(
    RECORD_STATUS == "REVIEW_VOL" &
      PROJ_grp == "TMDLLAKES" &
      is.na(Filt.Vol) & 
      SKey2 %in% c("4937201.42144.201502807", "4937202.42144.201502806") ~ 250,
    !is.na(Filt.Vol) ~ Filt.Vol,
    TRUE ~ as.numeric(NA)),
  RECORD_STATUS = case_when(
    RECORD_STATUS == "REVIEW_VOL" &
      PROJ_grp == "TMDLLAKES" &
      SKey2 %in% c("4937201.42144.201502807", "4937202.42144.201502806") ~ as.character(NA),
    !is.na(RECORD_STATUS) ~ RECORD_STATUS,
    TRUE ~ as.character(NA))
)
```

### Project Non-Detects

+ Proportion of Records w/ Non-Detect flags
  + Can ignore the filtration-volume field for this project-group

```{r}
CHL1016_05 %>% filter(PROJ_grp == "TMDLLAKES") %>%
  filter(!PARAM.X %in% c("PHEO", "CHLB")) %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, .keep_all = T) %>%
  ggplot(., na.rm=T) + theme_bw() +
  facet_grid(MethodID2 ~ .,  scales = "fixed") +
  geom_text(aes(x=x_SDate, y=LRL_c, col=Non_Detect), 
            na.rm=T, size=2.5, fontface="bold", label="J") +
  geom_point(data=.data[[is.na(.data[["Non_Detect"]]),]], aes(y=0.25, x=.data[["x_SDate"]]),
             position = position_jitter(width=10, height=0), col="darkgray", size=1.5,
             alpha=0.75, na.rm=T) +
  scale_x_date(date_labels="%Y",date_breaks = "1 year",
               limits=c(as.Date("2010-01-01"), NA)) + 
  scale_y_continuous(limits=c(0, NA)) +
  labs(x="Sample Date", y="Lower Reporting Limit (ug/L)", col="Detection \nCode",
       title="TMDLLAKES: RLs and Quantitated Datapoints")
```

+ Few records meeting the RL

```{r}
CHL1016_05 %>% filter(PROJ_grp == "TMDLLAKES") %>%
  filter(!PARAM.X %in% c("PHEO", "CHLB")) %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, .keep_all = T) %>%
  group_by(lubridate::year(x_SDate), PARAM.X) %>%
  summarize(p_ND = sprintf("%.f%%",
                           (sum(!is.na(Non_Detect), na.rm=T) / n())*100)) %>%
  as.data.frame(.) %>%
  setNames(c("Year", "CHL_param", "p_NonDetects")) %>%
  spread(Year, p_NonDetects) %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

+ Table, CHLA only, uniq(SKey2) :: Non-Detects vs. Vols

```{r}
CHL1016_05 %>% filter(PROJ_grp == "TMDLLAKES") %>%
  filter(!PARAM.X %in% c("PHEO", "CHLB")) %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, .keep_all = T) %>%
  {(table(is.na(.$Non_Detect), is.na(.$Filt.Vol),
                    useNA="ifany", deparse.level = 2, dnn=c("Non-Detect", "No Filt-Vols")))}
```

### Bottom Line: REVW-Non-Detects (-blanks)

> Volumes are sufficiently complete, however, the Non-Detects in 2014 + need further review

***

## [9] UBI

+ Number of unique sites in set ::  `r CHL1016_05 %>% filter(PROJ_grp == "UBI") %>% distinct(x_MLID) %>% nrow(.)`
+ Record data-range ::  `r CHL1016_05 %>% filter(PROJ_grp == "UBI") %>% {min(.$x_SDate, na.rm=T)}` to `r CHL1016_05 %>% filter(PROJ_grp == "UBI") %>% {max(.$x_SDate, na.rm=T)}` 
+ Unique Sample Events ::  `r CHL1016_05 %>% filter(PROJ_grp == "UBI") %>% distinct(SKey2) %>% nrow()`
+ Methods :: `r CHL1016_05 %>% filter(PROJ_grp == "UBI") %>% distinct(MethodID2) %$% .$MethodID2`
+ Params :: `r CHL1016_05 %>% filter(PROJ_grp == "UBI") %>% distinct(PARAM.X) %$% .$PARAM.X`

### Bottom Line: IGNORE

> These samples are from 2010; no vol needed, and the units suggest that the samples are BENTHIC, and the project-ID is wrong, looks like "SRW..."

**_Ignore_**

***

## [10] UCASE

+ Number of unique sites in set ::  `r CHL1016_05 %>% filter(PROJ_grp == "UCASE") %>% distinct(x_MLID) %>% nrow(.)`
+ Record data-range ::  `r CHL1016_05 %>% filter(PROJ_grp == "UCASE") %>% {min(.$x_SDate, na.rm=T)}` to `r CHL1016_05 %>% filter(PROJ_grp == "UCASE") %>% {max(.$x_SDate, na.rm=T)}` 
+ Unique Sample Events ::  `r CHL1016_05 %>% filter(PROJ_grp == "UCASE") %>% distinct(SKey2) %>% nrow()`
+ Methods :: `r CHL1016_05 %>% filter(PROJ_grp == "UCASE") %>% distinct(MethodID2) %$% .$MethodID2`
+ Params :: `r CHL1016_05 %>% filter(PROJ_grp == "UCASE") %>% distinct(PARAM.X) %$% .$PARAM.X`
  

### Filt.Vol completeness

```{r}
CHL1016_05 %>%
  filter(PROJ_grp == "UCASE") %>%
  filter(PARAM.X %in% c("CHLA.tot", "CHLA.aa", "CHLA.X")) %>%
  {addmargins(table(.$RECORD_STATUS, .$import_status,
                                 useNA="ifany", deparse.level = 2))}
```

+ Missing Filtration Volumes

`r CHL1016_05 %>% filter(PROJ_grp == "UCASE") %>% filter(PARAM.X %in% c("CHLA.tot", "CHLA.aa", "CHLA.X")) %>% {addmargins(table(.$PARAM.X, !is.na(.$Filt.Vol), useNA="ifany", deparse.level=2, dnn=c("CHL_param", "Have_filtration_vol")))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))`

+ Unique MLIDs where Filtration Volumes are missing

`r CHL1016_05 %>% filter(PROJ_grp == "UCASE") %>% filter(PARAM.X %in% c("CHLA.tot", "CHLA.aa", "CHLA.X")) %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% distinct(SKey2, .keep_all=T) %>% {addmargins(table(.$x_MLID, .$Year, useNA="ifany"))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="r|ccccc|c")`

```{r}
CHL1016_05 %>% filter(PROJ_grp == "UCASE" & !is.na(RECORD_STATUS)) %>% distinct(RECORD_STATUS) %$% .$RECORD_STATUS
```

```{r}
CHL1016_05 %<>% mutate(
  RECORD_STATUS = case_when(
    PROJ_grp == "UCASE" & 
      RECORD_STATUS == "REVIEW_VOL" & 
      is.na(PARAM_status) &
      is.na(Filt.Vol) & 
      x_SDate < as.Date("2012-09-20") ~ as.character(NA),
    !is.na(RECORD_STATUS) ~ RECORD_STATUS,
    TRUE ~ as.character(NA)))
```

+ Re-run table using `RECORD_STATUS` category (_sites w/ missing filt. volume_)

`r CHL1016_05 %>% filter(PROJ_grp == "UCASE" & RECORD_STATUS == "REVIEW_VOL") %>% filter(PARAM.X %in% c("CHLA.tot", "CHLA.aa", "CHLA.X")) %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% {addmargins(table(.$x_MLID, .$Year, useNA="ifany"))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="r|ccc|c")`

+ Unique SKey2 levels ::

`r CHL1016_05 %>% filter(PROJ_grp == "UCASE" & RECORD_STATUS == "REVIEW_VOL") %>% filter(PARAM.X %in% c("CHLA.tot", "CHLA.aa", "CHLA.X")) %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% {addmargins(table(.$SKey2, .$Year, useNA="ifany"))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="r|cccc|c")`

```{r}
CHL1016_05 %>% 
  filter(PROJ_grp == "UCASE" & RECORD_STATUS == "REVIEW_VOL") %>% 
  filter(PARAM.X %in% c("CHLA.tot", "CHLA.aa", "CHLA.X")) %>% mutate(Year = lubridate::year(.$x_SDate)) %>%
  filter(is.na(Filt.Vol) & Year > 2013) %>% distinct(SKey2, x_SDate) %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="rlc")
```

### Filtered Vol Updates

+ see RP file :: "CHLA_UCASE_dat1_180117_v02_RP.xlsx"  

Found file w/ RP updates on filtration volume and sample-matrix (WC vs. MATRIX)

**This needs to be sorted out...now**

```{r}
# file.ucaseVOL  <- choose.files(caption="Select _working_ DATA file [*.xlsx]", multi = FALSE)
# ucase_vols <- openxlsx::read.xlsx(file.ucaseVOL, sheet=1, startRow = 1,
#                               rowNames=FALSE, check.names = T)
```

+ Filename ::  `r basename(file.ucaseVOL)`
+ Path ::  `r dirname(file.ucaseVOL)`
+ Last Accessed :: [`r file.mtime(file.ucaseVOL)`]
+ DF [`ucase_vols`] :: `r nrow(ucase_vols)` records and `r ncol(ucase_vols)` fields

_Review data-file_

```{r}
ucase_vols %>% names(.)
```

_Key fields_  

SK2_fix2, PROJECT2, Sample.Num, MLID, Sample.Date, Sample.Type, Site.Type, Method.ID, Param.Name, Matrix, Det.Cond, Prob.Iden, Result.Code, Reult.Value, Result.Unit, MLID2, MethodID2, PARAM, Matrix2, dup_status, dupe.rec_status, Samp.m2, FiltVol_1, MATRIX.X, PARAM.X, MLID3, Proj.Grp, VOL_found_mL, Sample.Type, Composite_VOL_mL, Area_Found_cm2, V.source.Lab.Sheets, V.source.Field.Forms, V.source.Hydrofile, Notes

```{r}
rpUcase_flds <- c("SK2_fix2", "PROJECT2", "Sample.Num", "MLID", "Sample.Date", "Sample.Type", "Site.Type", "Method.ID", "Param.Name", "Matrix", "Det.Cond", "Prob.Iden", "Result.Code", "Result.Value", "Result.Unit", "MLID2", "MethodID2", "PARAM", "Matrix2", "dup_status", "dup.rec_status", "Samp.m2", "FiltVol_1", "MATRIX.X", "PARAM.X", "MLID3", "Proj.Grp", "VOL_found_mL", "Sample.Type.1", "Composite_VOL_mL", "Area_Found_cm2", "V.source.Lab.Sheets", "V.source.Field.Forms", "V.source.Hydrofile", "Notes")
```

```{r}
ucase_vols_02 <- ucase_vols %>% select(sort(rpUcase_flds)) %>%
  select(-Method.ID) %>%
  select(SK2_fix2, 
         Proj.Grp,
         MLID3, Sample.Date, Sample.Num,
         Sample.Type, Sample.Type.1, 
         Matrix, Matrix2, MATRIX.X, MethodID2, 
         PARAM.X, FiltVol_1,
         VOL_found_mL,  Notes,
         Area_Found_cm2, Samp.m2,
         Composite_VOL_mL,Result.Unit, 
         dup_status, dup.rec_status,
         Det.Cond, Prob.Iden, Result.Code, Result.Value, everything()) %>%
  mutate(Sample.Date = as.Date(.$Sample.Date, origin="1899-12-30"))
#
# sum(ucase_vols_02$PROJECT2 != ucase_vols_02$Proj.Grp, na.rm=T)
# sum(ucase_vols_02$MLID != ucase_vols_02$MLID2, na.rm=T)
# sum(ucase_vols_02$MLID != ucase_vols_02$MLID3, na.rm=T)
# sum(ucase_vols_02$MLID2 != ucase_vols_02$MLID3, na.rm=T)
# sum(ucase_vols_02$PARAM != ucase_vols_02$PARAM.X, na.rm=T)
# ucase_vols_02 %>% filter(PARAM != PARAM.X)
```

+ [??] _Now reduce down tro SKey2 x MATRIX.X, MethodID2, PARAM.X, VOL_found_mL_ [??]

```{r}
# ucase_vols_02 %>% 
#   distinct(SK2_fix2, MATRIX.X, MethodID2, PARAM.X, VOL_found_mL, .keep_all=T) -> 
#   ucase_vols_03 
```

+ Review and gather found_missing volumes...

+ Records where Filt.VOL is needed ::

```{r}
CHL1016_05 %>% 
  filter(PROJ_grp == "UCASE" & grepl("_VOL", .$RECORD_STATUS, ignore.case = T)) %>%
  distinct(SKey2, MethodID2, Filt.Vol) -> ucase_noVol_set
```

+ Join to ucase_vols_02

```{r}
ucase_fndVols <- left_join(ucase_noVol_set,
                             select(ucase_vols_02,
                                    SK2_fix2, MethodID2, VOL_found_mL, Notes),
                             by = c("SKey2" = "SK2_fix2",
                                    "MethodID2" = "MethodID2")) %>% distinct()
```

+ If `MethodID2` is 10300 -> sample volume is 25 mL from 500 mL composite of 132 cm2 area
+ Blank MLIDs :: 4939100, 4999500, 5989995


```{r}
ucase_fndVols %>% filter(grepl("Equipment Blank", .$Notes)) %>% distinct(SKey2) %>% 
  mutate(MLIDx = stringr::str_split(.$SKey2, "[.]",3,simplify=T)[,1]) %>%
  distinct(MLIDx)
```

+ Simplified table of found volumes for UCASE results in `r nrow(ucase_fndVols)` records

```{r}
ucase_fndVols %>% distinct(Notes) %$% Notes
```

+ Apply found VOLs to CHL1016 dataset...
  + **Versioned Dataframe**

```{r}
CHL1016_06 <- left_join(CHL1016_05,
                        select(ucase_fndVols,
                               SKey2, MethodID2, VOL_found_mL),
                        by = c("SKey2" = "SKey2",
                               "MethodID2" = "MethodID2")) %>%
  select(RECORD_STATUS:Filt.Vol, VOL_found_mL, MATRIX.X,
         PARAM.X, Comment_X, everything())
```


```{r}
CHL1016_06 %>% filter(PROJ_grp == "UCASE" & grepl("_VOL", .$RECORD_STATUS)) %>%
  {addmargins(table(.$VOL_found_mL, .$MethodID2, useNA = "ifany", deparse.level = 2))}
```

+ Some records missing a 'found volume'

```{r}
CHL1016_06 %>% filter(PROJ_grp == "UCASE" & 
                        grepl("_VOL", .$RECORD_STATUS) &
                        is.na(VOL_found_mL)) %>%
  select(x_SNum, x_MLID,  x_SDate, SKey2,MethodID2, Filt.Vol, VOL_found_mL) %>%
  arrange(x_SDate) %>% distinct()
```

_Record notes_

+ `4995530.42583.2011534` :: No VOL found
  + MLID = 4995530 :: **`r CHL1016_06 %>% filter(MLID == "4995530") %>% distinct(x_SNum) %>% nrow(.)`** Sample Numbers :: `r CHL1016_06 %>% filter(MLID == "4995530") %>% distinct(x_SNum) %$% x_SNum`
  + 2011537 :: PERI : matrix = BENTH
  + 2011536 :: CHL : matrix = WC (vol=1250)
  + `2011534` :: CHL : matrix _is probably Benthic CHL_
    + _Filt.Vol = 25mL, Comp.Col = 500 mL, Area=132cm2_  

+ `4995925.42584.2011556` :: No VOL found  
  + MLID = 4995925 :: **`r CHL1016_06 %>% filter(MLID == "4995925") %>% distinct(x_SNum) %>% nrow(.)`** Sample Numbers :: `r CHL1016_06 %>% filter(MLID == "4995925") %>% distinct(x_SNum) %$% x_SNum`
  + `2011556` :: CHL : _BENTH_ (probable)
    + _Filt.Vol = 25mL, Comp.Col = 500 mL, Area=132cm2_
  + 2011557 :: CHL : WC (vol=1000)
  + 2011558 :: PERI : BENTH  

+ `4995680.42585.2011554` :: No VOL found
  + MLID = 4995680 (160803 samples) :: **`r CHL1016_06 %>% filter(MLID == "4995680" & x_SDate > as.Date("2016-01-01")) %>% distinct(x_SNum) %>% nrow(.)`** Sample Numbers :: `r CHL1016_06 %>% filter(MLID == "4995680" & x_SDate > as.Date("2016-01-01")) %>% distinct(x_SNum) %$% x_SNum`
  + `2011554` :: CHL : BENTH ?
    + _Filt.Vol = 25mL, Comp.Col = 500 mL, Area=132cm2_
  + 2011555 :: CHL : WC (vol=750)
  + 2011540 :: PERI : BENTH  

+ `4996135.42586.2011563` :: No VOL found
  + MLID = 4996135 :: **`r CHL1016_06 %>% filter(MLID == "4996135" & x_SDate > as.Date("2016-01-01")) %>% distinct(x_SNum) %>% nrow(.)`** Sample Numbers :: `r CHL1016_06 %>% filter(MLID == "4996135" & x_SDate > as.Date("2016-01-01")) %>% distinct(x_SNum) %$% x_SNum`
  + `2011563` :: CHL : BENTH ?
    + _Filt.Vol = 15mL, Comp.Col = 500 mL, Area=132cm2_ **follows PERI measurements**
  + 2011564 :: CHL : WC (vol=750)
  + 2011565 :: PERI : BENTH

**Apply corrections**

```{r}
CHL1016_06 %<>% mutate(
  VOL_found_mL = case_when(
    is.na(VOL_found_mL) & is.na(Filt.Vol) &
      grepl("_VOL", .$RECORD_STATUS) &
      SKey2 %in% c("4995530.42583.2011534", "4995925.42584.2011556",
                   "4995680.42585.2011554") ~ "25",
  is.na(VOL_found_mL) & is.na(Filt.Vol) &
      grepl("_VOL", .$RECORD_STATUS) &
      SKey2 == "4996135.42586.2011563" ~ "15",
  !is.na(VOL_found_mL) ~ VOL_found_mL),
  MATRIX.X = case_when(
    is.na(Filt.Vol) & grepl("_VOL", .$RECORD_STATUS) &
      SKey2 %in% c("4995530.42583.2011534", "4995925.42584.2011556",
                   "4995680.42585.2011554", "4996135.42586.2011563") &
      is.na(MATRIX.X) ~ "BENTH",
    !is.na(MATRIX.X) ~ MATRIX.X,
    TRUE ~ as.character(NA)))
# CHL1016_06 %>% filter(
#   is.na(Filt.Vol) & grepl("_VOL", .$RECORD_STATUS) &
#       SKey2 %in% c("4995530.42583.2011534", "4995925.42584.2011556",
#                    "4995680.42585.2011554", "4996135.42586.2011563")
# )
```

+ Remove `RECORD_STATUS` elements for updated records...

```{r}
CHL1016_06 %<>% mutate(
  RECORD_STATUS = case_when(
    RECORD_STATUS == "REVIEW_VOL" &
      (!is.na(Filt.Vol) | !is.na(VOL_found_mL)) ~ as.character(NA),
    RECORD_STATUS == "REVIEW_mdl;REVIEW_VOL" &
      (!is.na(Filt.Vol) | !is.na(VOL_found_mL)) ~ "REVIEW_mdl",
    !is.na(RECORD_STATUS) ~ RECORD_STATUS,
    TRUE ~ as.character(NA)
  )
)
```

+ **Correct Non-Numeric elements in `VOL_found_mL`**

```{r}
CHL1016_06$VOL_found_mL <- as.numeric(CHL1016_06$VOL_found_mL)
# sum(!is.na(CHL1016_06$VOL_found_mL))
```


+ Review Matrix x MethodID || PARAM

```{r}
CHL1016_06 %>% filter(PROJ_grp == "UCASE") %>%
  {addmargins(table(.$MethodID2, .$MATRIX.X,
                    useNA="ifany", deparse.level = 2))}

CHL1016_06 %>% filter(PROJ_grp == "UCASE") %>%
  {addmargins(table(.$PARAM.X, .$MATRIX.X,
                    useNA="ifany", deparse.level = 2))}

CHL1016_06 %>% filter(PROJ_grp == "UCASE" & MATRIX.X == "UNK") %>%
  {addmargins(table(.$PARAM.X, .$MethodID2,
                    useNA="ifany", deparse.level = 2))}

CHL1016_06 %>% filter(PROJ_grp == "UCASE") %>% 
  mutate(Vols = case_when(
    !is.na(Filt.Vol) ~ Filt.Vol,
    !is.na(VOL_found_mL) ~ VOL_found_mL,
    TRUE ~ as.numeric(NA))) %>%
  {addmargins(table(.$Vols, .$MethodID2,
                        useNA="ifany", deparse.level = 2))}
```

+ Correct UCASE Sample-Matrices...
  + UNK & `NA`s

```{r}
CHL1016_06 %<>% mutate(
  MATRIX.X = case_when(
    PROJ_grp == "UCASE" & MethodID2 == "10300" &
      PARAM.X == "PERI" ~ "BENTH",
    !is.na(MATRIX.X) ~ MATRIX.X,
    TRUE ~ as.character(NA))
)
```


```{r}
CHL1016_06 %>% filter(PROJ_grp == "UCASE" & MethodID2 != "10300") %>% 
  mutate(Vols = case_when(
    !is.na(Filt.Vol) ~ Filt.Vol,
    !is.na(VOL_found_mL) ~ VOL_found_mL,
    TRUE ~ as.numeric(NA))) %>%
  {addmargins(table(.$Vols, .$MATRIX.X,
                        useNA="ifany", deparse.level = 2))}

CHL1016_06 %>% filter(PROJ_grp == "UCASE" & MethodID2 != "10300") %>% 
  {addmargins(table(lubridate::year(.$x_SDate), .$MATRIX.X,
                        useNA="ifany", deparse.level = 2))}
```

#### UCASE manual MATRIX-cleanup

**For this project only, dump data to XLS, manually make correction, then re-import**...

```{r}
# openxlsx::write.xlsx(CHL1016_06,
#                      file="CHL1016_06_ucase_190910.xlsx")
```

**Note**

+ 2011 UCASE samples appear to have been reviewed by TJ, and [_all_] these records are listed as BENTHIC samples
+ 2012 - No WC CHL appear to be present [?]
+ 2013 - have WC-CHL in datasheets at 2x SampNums
+ [190910] : `MATRIX.X` fully populated for UCASE in this dataset...

```{r}
# file.ucaseDAT  <- choose.files(caption="Select _working_ DATA file [*.xlsx]", multi = FALSE)
# CHL1016_06_x <- openxlsx::read.xlsx(file.ucaseDAT, sheet=1, startRow = 1,
#                               rowNames=FALSE, check.names = T)
```

+ Filename ::  `r basename(file.ucaseDAT)`
+ Path ::  `r dirname(file.ucaseDAT)`
+ Last Accessed :: [`r file.mtime(file.ucaseDAT)`]
+ DF [`CHL1016_06_x`] :: `r nrow(CHL1016_06_x)` records and `r ncol(CHL1016_06_x)` fields

[**Still need to fix Sample.Date in this recently imported file**]

+ **Version DF and correct Date-format**

```{r}
CHL1016_07 <- CHL1016_06_x %>% 
  mutate_at(vars(contains("date", ignore.case = T)),
                           funs(as.Date(., origin="1899-12-30")) )
```

#### Working DF :: CHL1016_07

+ Review matchups

```{r}
CHL1016_07 %>% filter(PROJ_grp == "UCASE") %>%
  {addmargins(table(.$MethodID2, .$MATRIX.X,
                    useNA="ifany", deparse.level = 2))}

CHL1016_07 %>% filter(PROJ_grp == "UCASE") %>%
  {addmargins(table(.$PARAM.X, .$MATRIX.X,
                    useNA="ifany", deparse.level = 2))}
# [below] CHL-method records only
CHL1016_07 %>% filter(PROJ_grp == "UCASE" & MethodID2 != "10300") %>% 
  {addmargins(table(lubridate::year(.$x_SDate), .$MATRIX.X,
                        useNA="ifany", deparse.level = 2))}
```

+ Still have 1 record "error" and 5 remaining UNKs...
  + One more attempt to resolve

+ MATRIX.X == "error" ::
  + `4990765.41086.201203472` :: BLank from 2012 (june 26); proabbly a BENTHIC sample, where the result needs to be re-scaled from per-VOL to per-Area  

+ MATRIX.X == "UNK" ::
  + `4940001.40815.201105589`
  + `4940001.40821.201105694`
  + `4940001.40835.201106266`
  + `4940001.40843.201106415`
  + `4940001.40856.201106661`
  + _These are all blanks from 2011; all results given as conc per-VOL; 3 are non-detects_  
  
  **These 6 records are a low priority for correction, at present**

+ For the above-6 records, update RECORD_STATUS to "REJECT_matrix"

```{r}
CHL1016_07 %<>% mutate(
  RECORD_STATUS = case_when(
    is.na(RECORD_STATUS) &
      SKey2 %in% c("4990765.41086.201203472", "4940001.40815.201105589",
                   "4940001.40821.201105694", "4940001.40835.201106266",
                   "4940001.40843.201106415", "4940001.40856.201106661") &
      (MATRIX.X == "UNK" | MATRIX.X == "error") ~ "REJECT_matrix",
    !is.na(RECORD_STATUS) ~ RECORD_STATUS,
    TRUE ~ as.character(NA))
)
```

#### STATUS: Vols & Matrix COMPLETE

+ Combine filtration-volume fields

```{r}
CHL1016_07 %<>% mutate(
  Comment_X = case_when(
    is.na(Filt.Vol) & !is.na(VOL_found_mL) & is.na(Comment_X) ~ "FiltVol added",
    is.na(Filt.Vol) & !is.na(VOL_found_mL) & 
      !is.na(Comment_X) ~ paste(.$Comment_X,
                                "FiltVol added", sep=";"),
    !is.na(Comment_X) ~ Comment_X,
    TRUE ~ as.character(NA)),
  Filt.Vol = case_when(
    is.na(Filt.Vol) & !is.na(VOL_found_mL) ~ VOL_found_mL,
    !is.na(Filt.Vol) ~ Filt.Vol,
    TRUE ~ as.numeric(NA))) %>%
  select(-VOL_found_mL, -Matrix, -ACT.ID, -Proj.nm, -Test.Num, -ACT.Type,
         -Result.Unit_2, -Lab.filename, -TripID2, -Param.Name, -src, 
         -SK2_PARAM,
         everything())
```


### Re-calc Results for records w/ found Volumes

+ Check units and values by MATRIX

```{r}
CHL1016_07 %>% filter(PROJ_grp == "UCASE") %>%
  {addmargins(table(.$MATRIX.X, !is.na(.$x_RVal),
                    useNA="ifany", deparse.level = 2,
                    dnn=c("Matrix", "Result_in_RVal?")))}
```

+ [above] For `BENTH` records w/o result in `x_RVal`, all but 1 record are Non-Detects and have LRL values
  + For `WC` records w/o result in `x_RVal`, all records are NON-Detect (U)

_Check units and completeness by PARAM x MATRIX for Result.Values_

1) UCASE, where x_RVal !~ _NA_

```{r}
CHL1016_07 %>% filter(PROJ_grp == "UCASE" & !is.na(x_RVal) & MATRIX.X %in% c("WC", "BENTH")) %>%
  {addmargins(table(.$x_Units, .$PARAM.X, .$MATRIX.X,
                    useNA="ifany", deparse.level = 2,
                    dnn=c("Units", "PARAM", "MATRIX")))}
```

< above >  
**Benthic**  [result units should be mg / m2]
+ PERI : some need re-calc (units == mg)
  + all records have VOL
+ CHL_tot (CHLA.tot & CHLA.X)
  + some records have conc-per-VOL - review and re-calc as needed
  + some records as mg/m2 (good!)
  + rest have units = mg

**WC** [result units should be ug/L]
+ PERI - 0 records (good !)
+ CHLA ~ mg : re-calc


**Look at conc. calcs...`x_RVal.conc`**

```{r}
CHL1016_07 %>% filter(PROJ_grp == "UCASE") %>%
  {addmargins(table(.$MATRIX.X, !is.na(.$x_RVal.conc),
                    useNA="ifany", deparse.level = 2,
                    dnn=c("Matrix", "Result_in_RVal.conc?")))}
```

+ BENTH should not have _conc_values as ug/L (_see BENTH & s_RVal.con = TRUE_)
+ For WC, no conc. values present (for CHLA, n=572) and 409/572 records have Non-Detect (yr 3013 +)
+ **These need to be re-calcualted**


2) UCASE, where x_RVal.conc !~ _NA_

```{r}
CHL1016_07 %>% filter(PROJ_grp == "UCASE" & !is.na(x_RVal.conc) & MATRIX.X %in% c("WC", "BENTH")) %>%
  {addmargins(table(.$x_Units, .$PARAM.X, .$MATRIX.X,
                    useNA="ifany", deparse.level = 2,
                    dnn=c("Units", "PARAM", "MATRIX")))}
```

***

**Work through re-calcs by PARAM, Ignore PERI and other BENTHIC for now** 

+ **Be sure to review records w/ "PARAM_status" ~ "review_PERI" at a later date**

+ Current calcs on PARAM ~ CHLA & MethodID2 == "10200"

```{r}
CHL1016_07 %<>% mutate(
  x_RVal.conc = case_when(
    is.na(x_RVal.conc) & PROJ_grp == "UCASE" & MethodID2 == "10200" & MATRIX.X == "WC" &
      !is.na(Filt.Vol) & is.na(Non_Detect) &
      !is.na(x_RVal) & x_Units == "mg" ~ ((x_RVal*1000) / (Filt.Vol/1000)),
    !is.na(x_RVal.conc) ~ x_RVal.conc,
    TRUE ~ as.numeric(NA)),
  LRL_c = case_when(
    PROJ_grp == "UCASE" & !is.na(Filt.Vol) & MethodID2 == "10200" & MATRIX.X == "WC" &
      is.na(LRL_c) & x_Units == "mg" & !is.na(Non_Detect) &
      !is.na(LRL) ~  ((LRL*1000) / (Filt.Vol/1000)),
    !is.na(LRL_c) ~ LRL_c,
    TRUE ~ as.numeric(NA)),
  MDL_c = case_when(
    PROJ_grp == "UCASE" & !is.na(Filt.Vol) & MethodID2 == "10200" & MATRIX.X == "WC" &
      is.na(MDL_c) & x_Units == "mg" & !is.na(Non_Detect) &
      !is.na(MDL) ~  ((MDL*1000) / (Filt.Vol/1000)),
    !is.na(MDL_c) ~ MDL_c,
    TRUE ~ as.numeric(NA))) %>% 
  mutate(
    RL_Units = case_when(
      (!is.na(LRL_c) | !is.na(MDL_c)) &
        is.na(RL_Units) ~ "ug/L",
      !is.na(RL_Units) ~ RL_Units,
      TRUE ~ as.character(NA)
      ),
    x_Units.conc = case_when(
      !is.na(x_RVal.conc) & MATRIX.X == "WC" ~ "ug/L",
      !is.na(x_Units.conc) ~ x_Units.conc,
      TRUE ~ as.character(NA))
    ) 
```


### Project Non-Detects

+ Records w/ Non-Detect flags...Two key CHL-parameters
  + plot unique instances of Non-Detects vs. Results (by SKey2) for all key CHL-parameters
  + Ignore PERIPHYTON (AFDM)

```{r}
CHL1016_07 %>% filter(PROJ_grp == "UCASE" & MATRIX.X == "WC") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO" & MethodID2 != "10300") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, Non_Detect, .keep_all = T) %>%
  ggplot(., na.rm=T) + theme_bw() +
  facet_grid(PARAM.X ~ .,  scales = "fixed") +
  geom_text(aes(x=x_SDate, y=LRL_c, col=Non_Detect), 
            na.rm=T, size=2.5, fontface="bold", label="J") +
  geom_point(data=.data[[is.na(.data[["Non_Detect"]]),]], aes(y=0.25, x=.data[["x_SDate"]]),
             position = position_jitter(width=10, height=0), col="darkgray", size=1.5,
             alpha=0.75, na.rm=T) + 
  scale_x_date(date_labels="%Y",date_breaks = "1 year",
               limits=c(as.Date("2010-01-01"), NA)) + 
  scale_y_continuous(limits=c(0, NA)) +
  labs(x="Sample Date", y="Lower Reporting Limit (ug/L)", col="Detection \nCode",
       title="UCASE: RLs and Quantitated Datapoints")
```
+ Water-Column sampling for UCASE appears to have started in 2013

+ Many, if not most of the Non-Detects after 2012 should be reviewed

+ UCASE Summary of proportion of Non-Detects in Results
  + _Ignoring records where filtration volume could not be obtained_

```{r}
CHL1016_07 %>% filter(PROJ_grp == "UCASE" & MATRIX.X == "WC") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  group_by(lubridate::year(x_SDate), PARAM.X) %>%
  summarize(p_ND = sprintf("%.f%%",
                           (sum(!is.na(Non_Detect), na.rm=T) / n())*100)) %>%
  as.data.frame(.) %>%
  setNames(c("Year", "CHL_param", "p_NonDetects")) %>%
  bind_rows(.,
            CHL1016_07 %>% filter(PROJ_grp == "UCASE" & MATRIX.X == "WC") %>%
              filter(!is.na(Filt.Vol)) %>% 
              filter(PARAM.X != "PHEO") %>%
              group_by(lubridate::year(x_SDate)) %>%
              summarize(obs = n()) %>% data.frame(., CHL_param="Obs") %>%
              setNames(c("Year", "p_NonDetects", "CHL_param")) %>%
              mutate(p_NonDetects=as.character(p_NonDetects))
            ) %>%
  spread(Year, p_NonDetects) %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="r|l|ccccccc|", caption="UCASE: Proportion of records (SK2) where result is Non-Detect", total=T)
```


```{r}
CHL1016_07 %>% filter(PROJ_grp == "UCASE" & MATRIX.X == "WC") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  ggplot(.) + theme_bw() +
  geom_point(aes(x=Filt.Vol, y=LRL_c, col=PARAM.X), na.rm=T) +
  # geom_point(aes(x=Filt.Vol, y=x_RVal.conc, col=PARAM.X), na.rm=T,
  #            position=position_jitter(width=10, height=0), shape=5, alpha=0.7) +
  coord_trans(x="log10", y="log10", limy=c(0.25, 35), limx=c(400, 2000)) +
  scale_x_continuous(breaks=c(500, 1000, 2000, 3000, 4000)) +
  scale_y_continuous(breaks=c(0.7, 2, 5, 10, 20, 30))
```

```{r fig.height=5}
CHL1016_07 %>% filter(PROJ_grp == "UCASE" & MATRIX.X == "WC") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  mutate(Result_val = case_when(
    is.na(Non_Detect) &
      !is.na(x_RVal.conc) ~ x_RVal.conc,
    !is.na(Non_Detect) & Non_Detect == "U" &
      !is.na(LRL_c) ~ LRL_c,
    TRUE ~ as.numeric(NA))) %>%
  ggplot(.) + theme_bw() + facet_grid(. ~ PARAM.X, scales="fixed") +
  stat_ecdf(aes(x=Result_val, col=Non_Detect), na.rm=T, lty=1) +
  labs(x="Lower Reporting Limits (ug/L)", y="% of records below x-Value",
       col="Non-Detect") +
  scale_x_continuous(trans="log10") +
  scale_y_continuous(labels=scales::percent) +
  geom_hline(yintercept = c(0.25,0.5,0.75), lty=2, color="gray40") +
  ggtitle("Project: UCASE - Distribution of RLs and RVs for Chlorophyll")
```

```{r fig.height=5}
CHL1016_07 %>% filter(PROJ_grp == "UCASE" & MATRIX.X == "WC") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  mutate(Result_val = case_when(
    is.na(Non_Detect) &
      !is.na(x_RVal.conc) ~ x_RVal.conc,
    !is.na(Non_Detect) & Non_Detect == "U" &
      !is.na(LRL_c) ~ LRL_c,
    TRUE ~ as.numeric(NA))) %>%
  arrange(PARAM.X, Result_val) %>% group_by(PARAM.X) %>%
  mutate(RValue_rank = percent_rank(Result_val)) %>%
  ggplot(.) + theme_bw() + facet_grid(. ~ PARAM.X, scales="fixed") +
  geom_point(aes(x=Result_val, y=RValue_rank, col=Non_Detect), na.rm=T) +
  # EnvStats::stat_n_text() +
  labs(x="CHL conc. (ug/L)", y="Result_rank") +
  scale_x_continuous(trans="log10") +
  scale_y_continuous(labels = scales::percent) +
  ggtitle("Project: UCASE - Distribution of RLs and RVs for Chlorophyll") +
  scale_color_discrete(name="Detection.Condition", labels=c("Not Detected", "Quantitated"))
  #(rank(Result_val,na.last=NA))
```

### Bottom Line: REVW-Non-Detects (-blanks)
### Also: REVW-PERI-calcs

***

## [11] USFS (_aka NFS_)

+ Number of unique sites in set ::  `r CHL1016_07 %>% filter(PROJ_grp == "USFS") %>% distinct(x_MLID) %>% nrow(.)`
+ Record data-range ::  `r CHL1016_07 %>% filter(PROJ_grp == "USFS") %>% {min(.$x_SDate, na.rm=T)}` to `r CHL1016_07 %>% filter(PROJ_grp == "USFS") %>% {max(.$x_SDate, na.rm=T)}` 
+ Unique Sample Events ::  `r CHL1016_07 %>% filter(PROJ_grp == "USFS") %>% distinct(SKey2) %>% nrow()`
+ Methods :: `r CHL1016_07 %>% filter(PROJ_grp == "USFS") %>% distinct(MethodID2) %$% .$MethodID2`
+ Params :: `r CHL1016_07 %>% filter(PROJ_grp == "USFS") %>% distinct(PARAM.X) %$% .$PARAM.X`

### Filt.Vol completeness

```{r}
CHL1016_07 %>%
  filter(PROJ_grp == "USFS") %>%
  filter(PARAM.X != "PHEO") %>%
  {addmargins(table(.$RECORD_STATUS, .$import_status,
                                 useNA="ifany", deparse.level = 2))}
```

+ Missing Filtration Volumes

`r CHL1016_07 %>% filter(PROJ_grp == "USFS") %>% filter(PARAM.X != "PHEO") %>% {addmargins(table(.$PARAM.X, !is.na(.$Filt.Vol), useNA="ifany", deparse.level=2, dnn=c("CHL_param", "Have_filtration_vol")))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))`

+ Unique levels of SKey2 where Filtration Volumes are missing
  + See table above, `r CHL1016_07 %>% filter(PROJ_grp == "USFS") %>% filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% distinct(SKey2, Year) %>% nrow(.)` records

+ Unique MLIDs where Filtration Volumes are missing

`r CHL1016_07 %>% filter(PROJ_grp == "USFS") %>% filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% {addmargins(table(.$x_MLID, .$Year, useNA="ifany"))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="r|ccc|c")`

> All samples from 2010 - No vols needed

+ Correct RECORD_STATUS for `USFS`

```{r}
CHL1016_07 %<>% mutate(
  RECORD_STATUS =case_when(
    PROJ_grp == "USFS" &
      RECORD_STATUS == "REVIEW_VOL" &
      x_SDate < as.Date("2013-01-01") ~ as.character(NA),
    !is.na(RECORD_STATUS) ~ RECORD_STATUS,
    TRUE ~ as.character(NA))
)
```

### Project Non-Detects

+ Proportion of Records w/ Non-Detect flags
  + Can ignore the filtration-volume field for this project-group

```{r}
CHL1016_07 %>% filter(PROJ_grp == "USFS") %>%
  filter(!PARAM.X %in% c("PHEO", "CHLB")) %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, .keep_all = T) %>%
  ggplot(., na.rm=T) + theme_bw() +
  facet_grid(MethodID2 ~ .,  scales = "fixed") +
  geom_text(aes(x=x_SDate, y=LRL_c, col=Non_Detect), 
            na.rm=T, size=2.5, fontface="bold", label="J") +
  geom_point(data=.data[[is.na(.data[["Non_Detect"]]),]], aes(y=0.25, x=.data[["x_SDate"]]),
             position = position_jitter(width=10, height=0), col="darkgray", size=1.5,
             alpha=0.75, na.rm=T) +
  scale_x_date(date_labels="%Y",date_breaks = "1 year",
               limits=c(as.Date("2010-01-01"), NA)) + 
  scale_y_continuous(limits=c(0, NA)) +
  labs(x="Sample Date", y="Lower Reporting Limit (ug/L)", col="Detection \nCode",
       title="USFS: RLs and Quantitated Datapoints")
```

+ Records are older, v. few Non-Detects

```{r}
CHL1016_07 %>% filter(PROJ_grp == "USFS") %>%
  filter(!PARAM.X %in% c("PHEO", "CHLB")) %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, .keep_all = T) %>%
  group_by(lubridate::year(x_SDate), PARAM.X) %>%
  summarize(p_ND = sprintf("%.f%%",
                           (sum(!is.na(Non_Detect), na.rm=T) / n())*100)) %>%
  as.data.frame(.) %>%
  setNames(c("Year", "CHL_param", "p_NonDetects")) %>%
  spread(Year, p_NonDetects) %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

### Bottom Line: OK

> USFS project is sufficiently complete (volumes) and sensitive (%RLs); on additional action needed. All Records from 2010

***

## [12] Utah Lake

+ Number of unique sites in set ::  `r CHL1016_07 %>% filter(PROJ_grp == "UtahLK") %>% distinct(x_MLID) %>% nrow(.)`
+ Record data-range ::  `r CHL1016_07 %>% filter(PROJ_grp == "UtahLK") %>% {min(.$x_SDate, na.rm=T)}` to `r CHL1016_07 %>% filter(PROJ_grp == "UtahLK") %>% {max(.$x_SDate, na.rm=T)}` 
+ Unique Sample Events ::  `r CHL1016_07 %>% filter(PROJ_grp == "UtahLK") %>% distinct(SKey2) %>% nrow()`
+ Methods :: `r CHL1016_07 %>% filter(PROJ_grp == "UtahLK") %>% distinct(MethodID2) %$% .$MethodID2`
+ Params :: `r CHL1016_07 %>% filter(PROJ_grp == "UtahLK") %>% distinct(PARAM.X) %$% .$PARAM.X`

### Filt.Vol completeness

```{r}
CHL1016_07 %>%
  filter(PROJ_grp == "UtahLK") %>%
  filter(PARAM.X != "PHEO") %>%
  {addmargins(table(.$RECORD_STATUS, .$import_status,
                                 useNA="ifany", deparse.level = 2))}
```

+ Missing Filtration Volumes

`r CHL1016_07 %>% filter(PROJ_grp == "UtahLK") %>% filter(PARAM.X != "PHEO") %>% {addmargins(table(.$PARAM.X, !is.na(.$Filt.Vol), useNA="ifany", deparse.level=2, dnn=c("CHL_param", "Have_filtration_vol")))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))`

+ Unique levels of SKey2 where Filtration Volumes are missing
  + See table above, `r CHL1016_07 %>% filter(PROJ_grp == "UtahLK") %>% filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% distinct(SKey2, Year) %>% nrow(.)` records

+ Unique MLIDs where Filtration Volumes are missing

`r CHL1016_07 %>% filter(PROJ_grp == "UtahLK") %>% filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% {addmargins(table(.$x_MLID, .$Year, useNA="ifany"))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="r|ccc|c")`

**Look for UTLK filtration volumes from 2016** [_2012 vols not needed_]

+ Found 3 sets for 2016 :: 9/13/16
  + 4907365 = 110 mL
  + 4917390 = 150
  + 4917715 = 125 mL

+ Update Volumes

```{r}
CHL1016_07 %<>% mutate(
  Comment_X = case_when(
    PROJ_grp == "UtahLK" & RECORD_STATUS == "REVIEW_VOL" &
      is.na(Filt.Vol) & SKey2 %in% c("4907365.42626.2020494",
                                     "4917390.42626.2020495",
                                     "4917715.42626.2020496") &
      is.na(Comment_X) ~ "FiltVol added",
    PROJ_grp == "UtahLK" & RECORD_STATUS == "REVIEW_VOL" &
      is.na(Filt.Vol) & SKey2 %in% c("4907365.42626.2020494",
                                     "4917390.42626.2020495",
                                     "4917715.42626.2020496") &
      !is.na(Comment_X) ~ paste(.$Comment_X,
                                "FiltVol added", sep=";"),
    !is.na(Comment_X) ~ Comment_X,
    TRUE ~ as.character(NA)),
  Filt.Vol = case_when(
    PROJ_grp == "UtahLK" & RECORD_STATUS == "REVIEW_VOL" &
      is.na(Filt.Vol) &
      SKey2 == "4907365.42626.2020494" ~ 110,
    PROJ_grp == "UtahLK" & RECORD_STATUS == "REVIEW_VOL" &
      is.na(Filt.Vol) &
      SKey2 == "4917390.42626.2020495" ~ 150,
    PROJ_grp == "UtahLK" & RECORD_STATUS == "REVIEW_VOL" &
      is.na(Filt.Vol) &
      SKey2 == "4917715.42626.2020496" ~ 125,
    !is.na(Filt.Vol) ~ Filt.Vol,
    TRUE ~ as.numeric(NA))) %>% 
  mutate(
    RECORD_STATUS = case_when(
      PROJ_grp == "UtahLK" & RECORD_STATUS == "REVIEW_VOL" &
        !is.na(Filt.Vol) ~ as.character(NA),
      !is.na(RECORD_STATUS) ~ RECORD_STATUS,
      TRUE ~ as.character(NA))
  )
```

### Project Non-Detects

+ Proportion of Records w/ Non-Detect flags

```{r}
CHL1016_07 %>% filter(PROJ_grp == "UtahLK") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, Non_Detect, .keep_all = T) %>%
  ggplot(., na.rm=T) + theme_bw() +
  facet_grid(PARAM.X ~ .,  scales = "fixed") +
  geom_text(aes(x=x_SDate, y=LRL_c, col=Non_Detect), 
            na.rm=T, size=2.5, fontface="bold", label="J") +
  geom_point(data=.data[[is.na(.data[["Non_Detect"]]),]], aes(y=0.25, x=.data[["x_SDate"]]),
             position = position_jitter(width=10, height=0), col="darkgray", size=1.5,
             alpha=0.75, na.rm=T) +
  scale_x_date(date_labels="%Y",date_breaks = "1 year",
               limits=c(as.Date("2010-01-01"), NA)) + 
  scale_y_continuous(limits=c(0.2, NA), trans="log10") +
  labs(x="Sample Date", y="Lower Reporting Limit (ug/L)", col="Detection \nCode",
       title="UtahLK: RLs and occurrence of quantitated Datapoints")
```

+ Due to small sample filtration volumes, some RLs are high

**Nearly complete overlap of quantitated results and RLs**  
  

+ Proportion of Records w/ Non-Detect flags
  + _Ignoring records where filtration volume is unavailable_

```{r}
CHL1016_07 %>% filter(PROJ_grp == "UtahLK") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  group_by(lubridate::year(x_SDate), PARAM.X) %>%
  summarize(p_ND = sprintf("%.f%%",
                           (sum(!is.na(Non_Detect), na.rm=T) / n())*100)) %>%
  as.data.frame(.) %>%
  setNames(c("Year", "CHL_param", "p_NonDetects")) %>%
  bind_rows(.,
            CHL1016_07 %>% filter(PROJ_grp == "UtahLK") %>%
              filter(!is.na(Filt.Vol)) %>% 
              filter(PARAM.X != "PHEO") %>%
              group_by(lubridate::year(x_SDate)) %>%
              summarize(obs = n()) %>% data.frame(., CHL_param="Obs") %>%
              setNames(c("Year", "p_NonDetects", "CHL_param")) %>%
              mutate(p_NonDetects=as.character(p_NonDetects))
            ) %>%
  spread(Year, p_NonDetects) %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="r|l|cc|", caption="UtahLK: Proportion of records (SK2) where result is Non-Detect", total=T)
```

No obvious isses w/ Non-detects here

### Bottom Line: OK

***

## [13] WINTERLAKES

+ Number of unique sites in set ::  `r CHL1016_07 %>% filter(PROJ_grp == "WINTERLAKES") %>% distinct(x_MLID) %>% nrow(.)`
+ Record data-range ::  `r CHL1016_07 %>% filter(PROJ_grp == "WINTERLAKES") %>% {min(.$x_SDate, na.rm=T)}` to `r CHL1016_07 %>% filter(PROJ_grp == "WINTERLAKES") %>% {max(.$x_SDate, na.rm=T)}` 
+ Unique Sample Events ::  `r CHL1016_07 %>% filter(PROJ_grp == "WINTERLAKES") %>% distinct(SKey2) %>% nrow()`
+ Methods :: `r CHL1016_07 %>% filter(PROJ_grp == "WINTERLAKES") %>% distinct(MethodID2) %$% .$MethodID2`
+ Params :: `r CHL1016_07 %>% filter(PROJ_grp == "WINTERLAKES") %>% distinct(PARAM.X) %$% .$PARAM.X`

### Filt.Vol completeness

```{r}
CHL1016_07 %>%
  filter(PROJ_grp == "WINTERLAKES") %>%
  filter(PARAM.X != "PHEO") %>%
  {addmargins(table(.$RECORD_STATUS, .$import_status,
                                 useNA="ifany", deparse.level = 2))}
```

+ Missing Filtration Volumes

`r CHL1016_07 %>% filter(PROJ_grp == "WINTERLAKES") %>% filter(PARAM.X != "PHEO") %>% {addmargins(table(.$PARAM.X, !is.na(.$Filt.Vol), useNA="ifany", deparse.level=2, dnn=c("CHL_param", "Have_filtration_vol")))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))`

+ Unique levels of SKey2 where Filtration Volumes are missing
  + See table above, `r CHL1016_07 %>% filter(PROJ_grp == "WINTERLAKES") %>% filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% distinct(SKey2, Year) %>% nrow(.)` records

+ Unique MLIDs where Filtration Volumes are missing

`r CHL1016_07 %>% filter(PROJ_grp == "WINTERLAKES") %>% filter(PARAM.X != "PHEO") %>% mutate(Year = lubridate::year(.$x_SDate)) %>% filter(is.na(Filt.Vol)) %>% {addmargins(table(.$x_MLID, .$Year, useNA="ifany"))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="r|ccc|c")`

> Older records, prior to 2012; No Volumes needed

### Project Non-Detects

+ Proportion of Records w/ Non-Detect flags

```{r}
CHL1016_07 %>% filter(PROJ_grp == "WINTERLAKES") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, Non_Detect, .keep_all = T) %>%
  ggplot(., na.rm=T) + theme_bw() +
  facet_grid(PARAM.X ~ .,  scales = "fixed") +
  geom_text(aes(x=x_SDate, y=LRL_c, col=Non_Detect), 
            na.rm=T, size=2.5, fontface="bold", label="J") +
  geom_point(data=.data[[is.na(.data[["Non_Detect"]]),]], aes(y=0.25, x=.data[["x_SDate"]]),
             position = position_jitter(width=10, height=0), col="darkgray", size=1.5,
             alpha=0.75, na.rm=T) +
  scale_x_date(date_labels="%Y",date_breaks = "1 year",
               limits=c(as.Date("2010-01-01"), NA)) + 
  scale_y_continuous(limits=c(0.2, NA), trans="log10") +
  labs(x="Sample Date", y="Lower Reporting Limit (ug/L)", col="Detection \nCode",
       title="WINTERLAKES: RLs and occurrence of quantitated Datapoints")
```

Only 1 ND value, in 2010

### Bottom Line: OK

***

## [14] WRI

+ Number of unique sites in set ::  `r CHL1016_07 %>% filter(PROJ_grp == "WRI") %>% distinct(x_MLID) %>% nrow(.)`
+ Record data-range ::  `r CHL1016_07 %>% filter(PROJ_grp == "WRI") %>% {min(.$x_SDate, na.rm=T)}` to `r CHL1016_07 %>% filter(PROJ_grp == "WRI") %>% {max(.$x_SDate, na.rm=T)}` 
+ Unique Sample Events ::  `r CHL1016_07 %>% filter(PROJ_grp == "WRI") %>% distinct(SKey2) %>% nrow()`
+ Methods :: `r CHL1016_07 %>% filter(PROJ_grp == "WRI") %>% distinct(MethodID2) %$% .$MethodID2`

### Filt.Vol completeness

```{r}
CHL1016_07 %>%
  filter(PROJ_grp == "WRI") %>%
  filter(PARAM.X != "PHEO") %>% distinct(SKey2, .keep_all=T) %>%
  {addmargins(table(.$RECORD_STATUS, .$import_status,
                                 useNA="ifany", deparse.level = 2))}
```

+ Missing Filtration Volumes

`r CHL1016_07 %>% filter(PROJ_grp == "WRI") %>% filter(PARAM.X != "PHEO") %>% {addmargins(table(.$PARAM.X, !is.na(.$Filt.Vol), useNA="ifany", deparse.level=2, dnn=c("CHL_param", "Have_filtration_vol")))} %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))`

+ All records need Volumes...
  + review RPs chl-vol work

### Import available CHL-vols

```{r}
# file.wriVOL  <- choose.files(caption="Select _working_ DATA file [*.xlsx]", multi = FALSE)
# wri_vols <- openxlsx::read.xlsx(file.wriVOL, sheet="CHL_vols", startRow = 1,
#                               rowNames=FALSE, check.names = T)
# rm(wri_vols)
```

+ Filename ::  `r basename(file.wriVOL)`
+ Path ::  `r dirname(file.wriVOL)`
+ Last Accessed :: [`r file.mtime(file.wriVOL)`]
+ DF [`wri_vols`] :: `r nrow(wri_vols)` records and `r ncol(wri_vols)` fields

```{r}
wri_vols_01 <- wri_vols %>% filter(!is.na(VOL)) %>%
  setNames(c("TripID", "MLID", "Date", "SType", "CHL_type", "VOL")) %>%
  mutate(Date = as.Date(.$Date, origin="1899-12-30"))
```

+ Join found vols to DF
  + also remove prior found_Vols field, then re-add it in...

```{r}
# CHL1016_07 -> CHL1016_07_copy
CHL1016_07 <- CHL1016_07 %>% 
  select(-VOL_found_mL) %>%
  left_join(.,
            wri_vols_01 %>% 
              select(.,
                     MLID, Date, VOL) %>% mutate(MLID = as.character(MLID)),
            by = c("x_MLID" = "MLID",
                   "x_SDate" = "Date")) %>%
  select(RECORD_STATUS:Filt.Vol, VOL_found_mL = VOL, everything())  %>%
  mutate_if(is.factor, as.character)
```

+ check VOL completeness

```{r}
CHL1016_07 %>%
  filter(PROJ_grp == "WRI") %>%
  filter(PARAM.X != "PHEO") %>% distinct(SKey2, .keep_all=T) %>%
  {addmargins(table(.$RECORD_STATUS, is.na(.$VOL_found_mL),
                                 useNA="ifany", deparse.level = 2,
                    dnn=c("RECORD_status", "VOL_missing?")))}
```

+ Translate found_VOLs to `Filt.Vol` for WRI records and recode `RECORD_STATUS`

```{r}
CHL1016_07 %<>% mutate(
  Filt.Vol = case_when(
    PROJ_grp == "WRI" & grepl("REVIEW_VOL", .$RECORD_STATUS, ignore.case = T) &
      is.na(Filt.Vol) & !is.na(VOL_found_mL) ~ VOL_found_mL,
    !is.na(Filt.Vol) ~ Filt.Vol,
    TRUE ~ as.numeric(NA))) %>% 
  mutate(
    RECORD_STATUS = case_when(
      PROJ_grp == "WRI" & !is.na(Filt.Vol) &
        RECORD_STATUS == "REVIEW_VOL" ~ as.character(NA),
      PROJ_grp == "WRI" & !is.na(Filt.Vol) & 
        grepl("REVIEW_VOL", .$RECORD_STATUS, ignore.case = T) ~ 
        gsub(";REVIEW_VOL", "", .$RECORD_STATUS, ignore.case = T),
      !is.na(RECORD_STATUS) ~ RECORD_STATUS,
      TRUE ~ as.character(NA))) %>%
  select(RECORD_STATUS:x_SDate, Sample.Type, everything())
```

+ Take a look at VOL completeness for WRI by month (year == 2016)
  + Unique levels of SKey2 for WRI :: `r CHL1016_07 %>% filter(PROJ_grp == "WRI") %>% distinct(SKey2) %>% nrow()`

```{r}
CHL1016_07 %>% filter(PROJ_grp == "WRI") %>%
  distinct(SKey2, .keep_all=T) %>%
  {addmargins(table(lubridate::month(.$x_SDate), is.na(.$Filt.Vol),
                    useNA="ifany", deparse.level = 2,
                    dnn=c("Sample_month", "Filt.Vol_missing?")))}
```

[above]  

+ Some vols may be missing in May, June and Sept ??

```{r}
CHL1016_07 %>% filter(PROJ_grp == "WRI" & is.na(Filt.Vol)) %>%
  distinct(Sample.Type) %$% Sample.Type
```

Sample types are okay, will need further review, since I have CHL results but no VOLs

+ [190911] **Found some records where VOL is missing from CHL-DF, but a value is present in `wri_vols_01`, so something w/ the JOIN is hinkey...**

**Summarise status of found WRI vols**

```{r}
wri_vols_01 %<>% mutate(
  Found = case_when(
    paste(.$MLID, .$Date, sep="_") %in%
      paste(CHL1016_07$x_MLID,
            CHL1016_07$x_SDate, sep="_") ~ "Y",
    TRUE ~ "n"
  ))
#
wri_vols_01 %>% filter(Found == "n") %>% {addmargins(table(paste(.$MLID, .$Date, sep="_"),
                                  .$Found, useNA = "ifany", deparse.level = 2,
                                  dnn=c("MLID_date", "Site_Date_matchup?")),1)} %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

+ ID WRI records (SKey2) where Filt.Vol is _still missing_

```{r}
CHL1016_07 %>% filter(PROJ_grp == "WRI" & 
                        (is.na(Filt.Vol) | is.na(VOL_found_mL))) %>%
  distinct(SKey2, .keep_all=T) %>%
  {addmargins(table(paste(.$x_MLID, .$x_SDate, sep="_"),
                    .$QC_type,
                    useNA = "ifany",
                    deparse.level = 2, dnn=c("mlid_date", "QC_type")))} %>%
  as.data.frame(.) %>% spread(QC_type, Freq) %>%
  select(-Sum) %>% mutate_if(is.factor, as.character) %>%
  filter(mlid_date != "Sum") -> wri_noVOL
```

**Looks like there may be date / MLID mis-matches  b/w field and CHL datasets for WRI**

+ add YR_month to these tables as a sloppy-match

```{r}
wri_vols_01 %<>% mutate(
  yr_mon = paste(lubridate::year(.$Date),
                 sprintf("%.2d", lubridate::month(.$Date)), sep="_")
)
```

```{r}
wri_noVOL %<>% mutate(
  yr_mon = paste(
    lubridate::year(stringr::str_extract(.$mlid_date,
                                         pattern = "[0-9]{4}-[0-9]{2}-[0-9]{2}")),
    sprintf("%.2d", lubridate::month(stringr::str_extract(.$mlid_date,
                                         pattern = "[0-9]{4}-[0-9]{2}-[0-9]{2}"))),
    sep="_"),
  MLID = stringr::str_extract(.$mlid_date,
                              pattern = "[0-9]{7}")) %>% arrange(yr_mon, MLID)

# grep("[0-9]{4}-[0-9]{2}-[0-9]{2}", wri_noVOL$mlid_date,value = T)
# strsplit(wri_noVOL$mlid_date,"_",fixed=T)[1]
# stringr::str_split(wri_noVOL$mlid_date[1], "_")[[1]][2]
# stringr::str_extract(wri_noVOL$mlid_date,pattern = "[0-9]{4}-[0-9]{2}-[0-9]{2}")
# stringr::str_extract(wri_noVOL$mlid_date,pattern = "[0-9]{7}")
# strsplit(wri_noVOL$mlid_date,"_")[[1]][1]
```

+ matchup again, using only _noVOL table...

```{r}
wri_noVOL %<>% mutate(
  fnd_vols = case_when(
    paste(.$MLID, .$yr_mon, sep=".") %in%
      paste(wri_vols_01$MLID,
            wri_vols_01$yr_mon, sep=".") ~ "Y",
    TRUE ~ "n"
  )
)
```

+ add found vols to wri_noVOL

```{r}
wri_noVOL_2 <- left_join(wri_noVOL %>% 
                           mutate(sk1 = paste(.$MLID, .$yr_mon, sep=".")),
                         wri_vols_01 %>% 
                           mutate(sk1 = paste(.$MLID, .$yr_mon, sep=".")) %>%
                           select(sk1, VOL),
                         by = c("sk1" = "sk1"))
```

+ Noqw use `mlid_date` from `wri_noVOL` to join to dataset for found VOLs
  + **These have a slight date mismatch**

```{r}
CHL1016_08 <- left_join(
  CHL1016_07 %>% mutate(mlid_date = paste(.$x_MLID, .$x_SDate, sep="_")),
  wri_noVOL_2 %>% select(mlid_date, VOL),
  by = c("mlid_date" = "mlid_date")) %>%
  select(-VOL_found_mL) %>%
  select(RECORD_STATUS:Filt.Vol, VOL_found_mL = VOL,
         everything())
```

+ Now combine Vol-fields again...

```{r}
CHL1016_08 %<>% mutate(
  Filt.Vol = case_when(
    PROJ_grp == "WRI" & grepl("REVIEW_VOL", .$RECORD_STATUS, ignore.case = T) &
      is.na(Filt.Vol) & !is.na(VOL_found_mL) ~ VOL_found_mL,
    !is.na(Filt.Vol) ~ Filt.Vol,
    TRUE ~ as.numeric(NA))) %>% 
  mutate(
    RECORD_STATUS = case_when(
      PROJ_grp == "WRI" & !is.na(Filt.Vol) &
        RECORD_STATUS == "REVIEW_VOL" ~ as.character(NA),
      PROJ_grp == "WRI" & !is.na(Filt.Vol) & 
        grepl("REVIEW_VOL", .$RECORD_STATUS, ignore.case = T) ~ 
        gsub(";REVIEW_VOL", "", .$RECORD_STATUS, ignore.case = T),
      !is.na(RECORD_STATUS) ~ RECORD_STATUS,
      TRUE ~ as.character(NA))) %>%
  select(-VOL_found_mL)
```

+ Counds look okay for now...

+ Take another look at records missing VOLs (after 2 tries...)

```{r}
CHL1016_08 %>% filter(PROJ_grp == "WRI" & is.na(Filt.Vol)) %>%
  distinct(SKey2, .keep_all=T) %>%
  {addmargins(table(paste(.$x_MLID, .$x_SDate, sep="_"),
                    .$QC_type,
                    useNA = "ifany",
                    deparse.level = 2, dnn=c("mlid_date", "QC_type")))} %>%
  as.data.frame(.) %>% spread(QC_type, Freq) %>%
  select(-Sum) %>% mutate_if(is.factor, as.character) %>%
  filter(mlid_date != "Sum") -> wri_noVOL_3
```

```{r}
wri_noVOL_3 %<>% mutate(
  yr_mon = paste(
    lubridate::year(stringr::str_extract(.$mlid_date,
                                         pattern = "[0-9]{4}-[0-9]{2}-[0-9]{2}")),
    sprintf("%.2d", lubridate::month(stringr::str_extract(.$mlid_date,
                                         pattern = "[0-9]{4}-[0-9]{2}-[0-9]{2}"))),
    sep="_"),
  MLID = stringr::str_extract(.$mlid_date,
                              pattern = "[0-9]{7}")) %>% arrange(yr_mon, MLID)
```

+ Check for MLID in wri-vols

```{r}
wri_noVOL_3 %<>% mutate(
  f_mlid = case_when(
    MLID %in% wri_vols_01$MLID ~ "Y",
    TRUE ~ "n"))
```

```{r}
wri_noVOL_3 %>% {addmargins(table(.$MLID, .$f_mlid=="Y", useNA="ifany",
                                  deparse.level = 2, dnn=c("MLID", "MLID_in_vols?")))} %>%
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

+ `r wri_noVOL_3 %>% filter(f_mlid != "Y") %>% distinct(MLID) %>% nrow()` Sites do not seem to be included in the field-CHL-vol-data, while `r wri_noVOL_3 %>% filter(f_mlid == "Y") %>% distinct(MLID) %>% nrow()` MLIDs are...

+ For records in `wri_noVOL_3` where f_mlid == "Y", are there similar `yr_mon` sets in `wri_vols_01` ??

```{r}
wri_noVOL_3 %<>% mutate(
  note = case_when(
    f_mlid == "Y" & MLID %in% c("4927010") ~ "No Vol for June.16",
    f_mlid == "Y" & MLID %in% c("4924760","4925350","4925360","4925440",
                                "4926800","4990280") ~ "No Vol for Sept.16"))
```

**The following records are missing a CHL record for a particular site x date**

```{r}
wri_noVOL_3 %>% filter(f_mlid == "Y") %>% distinct(mlid_date, MLID, note) %>%
arrange(MLID) %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

+ What about the two MLIDs that fail to match ?
+ `r wri_noVOL_3 %>% filter(f_mlid != "Y") %>% distinct(MLID) %$% MLID `

```{r}
MonLoc %>% filter(MLID %in% c("4920097", "4920098")) %>% select(MLID:MLID.type) %>% htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))))
```

### Third attempt at WRI volumes...

+ Need volumes for the 36 sets in table `wri_noVOL_3`

+ Searched through:
  + LAb Sheets
  + Trip Sheets
  + Hydrofiles (completed and compiled)

Some EQBKs were not recorded, but all available volumes for this project have 500 mL filtration volumes for equip blanks...  
> **I assume that any "missing" filtration volumes for EQBKs (4920097 / 4920098) are 500 mL for WRI**

Remaining records w/ volumes found:  

+ 4927010 - June :: 500
+ 4924760 - Sept :: 500
+ 4925350 - Sept :: No volume found
+ 4925360 - Sept :: 500
+ 4925440 - Sept :: 500
+ 4926800 - Sept :: 500
+ 4990280 - Sept :: 500

_Apply filtration volumes (last set for WRI)_

```{r}
CHL1016_08 %<>% mutate(
  Filt.Vol = case_when(
    PROJ_grp == "WRI" & 
      grepl("REVIEW_VOL", .$RECORD_STATUS, ignore.case = T) &
      is.na(Filt.Vol) &
      SKey2 %in% c("4990280.42632.2022431",
                   "4926800.42625.2020473",
                   "4925440.42625.2020471",
                   "4925360.42625.2020435",
                   "4924760.42633.2022414",
                   "4927010.42535.201602369") ~ 500,
    PROJ_grp == "WRI" & 
      grepl("REVIEW_VOL", .$RECORD_STATUS, ignore.case = T) &
      is.na(Filt.Vol) & x_MLID %in% c("4920097", "4920098") ~ 500,
    !is.na(Filt.Vol) ~ Filt.Vol,
    TRUE ~ as.numeric(NA))) %>% 
  mutate(
    RECORD_STATUS = case_when(
    PROJ_grp == "WRI" & !is.na(Filt.Vol) &
        RECORD_STATUS == "REVIEW_VOL" ~ as.character(NA),
      PROJ_grp == "WRI" & !is.na(Filt.Vol) & 
        grepl("REVIEW_VOL", .$RECORD_STATUS, ignore.case = T) ~ 
        gsub(";REVIEW_VOL", "", .$RECORD_STATUS, ignore.case = T),
      !is.na(RECORD_STATUS) ~ RECORD_STATUS,
      TRUE ~ as.character(NA)
  ))
```

+ `4925350.42625.2020430` has no filtration volume available...

+ Status update

```{r}
CHL1016_08 %>% filter(PROJ_grp == "WRI") %>%
  distinct(SKey2, .keep_all=T) %>%
  {addmargins(table(lubridate::month(.$x_SDate), is.na(.$Filt.Vol),
                    useNA="ifany", deparse.level = 2,
                    dnn=c("Sample_month", "Filt.Vol_missing?")))}
```

+ Only 1 record for WRI is missing filtration volume

***

+ tidy up field names...

```{r}
CHL1016_08 %<>% select(RECORD_STATUS:PARAM.X,
                       Prob.Iden:RL_Units, Comment_X,
                       everything()) %>%
  select(-param_comnt, -rec_status, -n_recs, -FiltVol_1, -Area_1, ANY_1,
         -SK2_fix2_copy, -Vol.FILT.x, -xid, -MLID, -Cost.Code,
         everything())
```

### Review project-classes

```{r}
CHL1016_08 %>% filter(PROJ_grp == "WRI") %>%
  {addmargins(table(.$PARAM.X, .$MATRIX.X, useNA = "ifany",
                    deparse.level = 2))}
```

+ Only 1 matrix :: WC

```{r}
CHL1016_08 %>% filter(PROJ_grp == "WRI") %>%
  {addmargins(table(.$PARAM.X, .$MethodID2, useNA = "ifany",
                    deparse.level = 2))}
```

+ Only 1 method

```{r}
CHL1016_08 %>% filter(PROJ_grp == "WRI") %>%
  {addmargins(table(.$PARAM.X, .$x_Units, useNA = "ifany",
                    deparse.level = 2))}
```

+ Consistent units (weight; mg) for Results

```{r}
CHL1016_08 %>% filter(PROJ_grp == "WRI") %>%
  {addmargins(table(.$PARAM.X, .$x_Units.conc, useNA = "ifany",
                    deparse.level = 2))}
```

+ No concentration calculations (yet)

```{r}
CHL1016_08 %>% filter(PROJ_grp == "WRI") %>%
  {addmargins(table(.$PARAM.X, .$Result.Code, useNA = "ifany",
                    deparse.level = 2))}
```

+ Veriety of result.codes, primarily U, J, H (holding time) and Q (apparent precision issue w/ RPDs)

```{r}
CHL1016_08 %>% filter(PROJ_grp == "WRI") %>%
  {addmargins(table(.$PARAM.X, .$Non_Detect, useNA = "ifany",
                    deparse.level = 2))}
```

+ About 2/3 of records are non-Detect
  + _Will need to re-evaluate these records for NDs_

***


### Re-calc Results

```{r}
# CHL1016_08 -> CHL1016_08_cpy
# CHL1016_08 <- CHL1016_08_cpy
```


```{r}
CHL1016_08 %<>% mutate(
    x_RVal.conc = case_when(
        is.na(x_RVal.conc) & PROJ_grp == "WRI" & MethodID2 == "10200" & MATRIX.X == "WC" &
            !is.na(Filt.Vol) & is.na(Non_Detect) &
            !is.na(x_RVal) & x_Units == "mg" ~ ((x_RVal*1000) / (Filt.Vol/1000)),
        !is.na(x_RVal.conc) ~ x_RVal.conc,
        TRUE ~ as.numeric(NA)),
    LRL_c = case_when(
        PROJ_grp == "WRI" & !is.na(Filt.Vol) & MethodID2 == "10200" & MATRIX.X == "WC" &
            is.na(LRL_c) & x_Units == "mg" & 
            !is.na(LRL) & LRL != 0 ~  ((LRL*1000) / (Filt.Vol/1000)),
        !is.na(LRL_c) ~ LRL_c,
        TRUE ~ as.numeric(NA)),
    MDL_c = case_when(
        PROJ_grp == "WRI" & !is.na(Filt.Vol) & MethodID2 == "10200" & MATRIX.X == "WC" &
            x_Units == "mg" & !is.na(Non_Detect) &
            !is.na(MDL) & MDL != 0 ~  ((MDL*1000) / (Filt.Vol/1000)),
        PROJ_grp == "WRI" & !is.na(Filt.Vol) & MethodID2 == "10200" & MATRIX.X == "WC" &
          is.na(MDL) ~ as.numeric(NA),
        !is.na(MDL_c) ~ MDL_c,
        TRUE ~ as.numeric(NA))) %>% 
    mutate(
        RL_Units = case_when(
            (!is.na(LRL_c) | !is.na(MDL_c)) &
                is.na(RL_Units) ~ "ug/L",
            !is.na(RL_Units) ~ RL_Units,
            TRUE ~ as.character(NA)
        ),
        x_Units.conc = case_when(
            !is.na(x_RVal.conc) & MATRIX.X == "WC" ~ "ug/L",
            !is.na(x_Units.conc) ~ x_Units.conc,
            TRUE ~ as.character(NA))
    ) 
```

+ Correct some MDL == 0 issues and re-calc

```{r}
CHL1016_08 %>% filter(PROJ_grp == "WRI") %>% 
  {addmargins(table(.$PARAM.X, (.$MDL == 0), useNA="ifany",
                    deparse.level = 2, dnn=c("PARAM", "MDL_is_0?")))}

CHL1016_08 %>% filter(PROJ_grp == "WRI") %>% 
  {addmargins(table(.$PARAM.X, (.$LRL == 0), useNA="ifany",
                    deparse.level = 2, dnn=c("PARAM", "LRL_is_0?")))}
```

```{r}
CHL1016_08 %<>% mutate(
  RECORD_STATUS = case_when(
    PROJ_grp == "WRI" & grepl("REVIEW_lrl", .$RECORD_STATUS, ignore.case = T) &
      (!is.na(LRL) & LRL == 0) ~ as.character(NA),
    !is.na(RECORD_STATUS) ~ RECORD_STATUS,
    TRUE ~ as.character(NA)),
  RECORD_STATUS = case_when(
    PROJ_grp == "WRI" & grepl("REVIEW_mdl", .$RECORD_STATUS, ignore.case = T) &
      (!is.na(MDL) & MDL == 0) ~ as.character(NA),
    !is.na(RECORD_STATUS) ~ RECORD_STATUS,
    TRUE ~ as.character(NA))) %>%
  mutate(
    MDL = case_when(
      PROJ_grp == "WRI" & MDL == 0 ~ as.numeric(NA),
      !is.na(MDL) ~ MDL,
      TRUE ~ as.numeric(NA)),
    LRL = case_when(
      PROJ_grp == "WRI" & LRL == 0 ~ as.numeric(NA),
      !is.na(LRL) ~ LRL,
      TRUE ~ as.numeric(NA)))
```

***

### Project Non-Detects

+ Proportion of Records w/ Non-Detect flags

```{r}
CHL1016_08 %>% filter(PROJ_grp == "WRI") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, Non_Detect, .keep_all = T) %>%
  ggplot(., na.rm=T) + theme_bw() +
  facet_grid(PARAM.X ~ .,  scales = "fixed") +
  geom_text(aes(x=x_SDate, y=LRL_c, col=Non_Detect), 
            na.rm=T, size=2.5, fontface="bold", label="J") +
  geom_point(data=.data[[is.na(.data[["Non_Detect"]]),]], aes(y=0.25, x=.data[["x_SDate"]]),
             position = position_jitter(width=10, height=0), col="darkgray", size=1.5,
             alpha=0.75, na.rm=T) +
  scale_x_date(date_labels="%Y",date_breaks = "1 year",
               limits=c(as.Date("2015-10-01"), NA)) + 
  scale_y_continuous(limits=c(0.2, NA), trans="log10") +
  labs(x="Sample Date", y="Lower Reporting Limit (ug/L)", col="Detection \nCode",
       title="WRI: RLs and occurrence of quantitated Datapoints")
```

+ Due to small sample filtration volumes, some RLs are rather high

```{r}
CHL1016_08 %>% filter(PROJ_grp == "WRI") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, .keep_all = T) %>%
  ggplot(., na.rm=T) + theme_bw() +
  geom_text(aes(x=x_SDate, y=LRL_c, col=Non_Detect), 
            na.rm=T, size=2.5, fontface="bold", label="J") +
  facet_grid(PARAM.X ~ .,  scales = "fixed") +
  geom_point(aes(y=x_RVal.conc, x=x_SDate),
             position = position_jitter(width=10, height=0), size=1.2,
             alpha=0.75, na.rm=T, shape=1) + 
  scale_x_date(date_labels="%y, %b",date_breaks = "2 month",
               limits=c(as.Date("2016-01-01"), NA)) + 
  scale_y_continuous(limits=c(NA, NA), breaks=c(5, 20, 50, 200)) +
  coord_trans(y="log10", limy=c(2.5, 250)) +
  labs(x="Sample Date", y="Lower Reporting Limit (ug/L)", col="Detection \nCode",
       title="WRI: RLs and Quantitated Datapoints")
```

**Considerable amount of overlap of quantitated results and RLs**  
  

+ Proportion of Records w/ Non-Detect flags
  + _Ignoring records where filtration volume is unavailable_

```{r}
CHL1016_08 %>% filter(PROJ_grp == "WRI") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  group_by(lubridate::year(x_SDate), PARAM.X) %>%
  summarize(p_ND = sprintf("%.f%%",
                           (sum(!is.na(Non_Detect), na.rm=T) / n())*100)) %>%
  as.data.frame(.) %>%
  setNames(c("Year", "CHL_param", "p_NonDetects")) %>%
  bind_rows(.,
            CHL1016_08 %>% filter(PROJ_grp == "WRI") %>%
              filter(!is.na(Filt.Vol)) %>% 
              filter(PARAM.X != "PHEO") %>%
              group_by(lubridate::year(x_SDate)) %>%
              summarize(obs = n()) %>% data.frame(., CHL_param="Obs") %>%
              setNames(c("Year", "p_NonDetects", "CHL_param")) %>%
              mutate(p_NonDetects=as.character(p_NonDetects))
            ) %>%
  spread(Year, p_NonDetects) %>% 
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="r|l|cc|", caption="WRI: Proportion of records (SK2) where result is Non-Detect", total=T)
```

```{r}
CHL1016_08 %>% filter(PROJ_grp == "WRI") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  ggplot(.) + theme_bw() +
  geom_point(aes(x=Filt.Vol, y=LRL_c, col=PARAM.X), na.rm=T) +
  # geom_point(aes(x=Filt.Vol, y=x_RVal.conc, col=PARAM.X), na.rm=T,
  #            position=position_jitter(width=10, height=0), shape=5, alpha=0.7) +
  coord_trans(x="log10", y="log10", limy=c(0.25, 1200), limx=c(50, 1500)) +
  scale_x_continuous(breaks=c(25, 100, 550, 1000, 2500)) +
  scale_y_continuous(breaks=c(0.7, 2, 5, 10, 50, 100, 500))
```

+ Strong negative inverse (log-log) dependebnce of RL on filtration volume

```{r}
CHL1016_08 %>% filter(PROJ_grp == "WRI") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  mutate(Result_val = case_when(
    is.na(Non_Detect) &
      !is.na(x_RVal.conc) ~ x_RVal.conc,
    !is.na(Non_Detect) & Non_Detect == "U" &
      !is.na(LRL_c) ~ LRL_c,
    TRUE ~ as.numeric(NA))) %>%
  ggplot(.) + theme_bw() + facet_grid(. ~ PARAM.X, scales="fixed") +
  stat_ecdf(aes(x=Result_val, col=Non_Detect), na.rm=T, lty=1) +
  labs(x="Lower Reporting Limits (ug/L)", y="% of records below x-Value",
       col="Non-Detect") +
  scale_x_continuous(trans="log10") +
  scale_y_continuous(labels=scales::percent) +
  geom_hline(yintercept = c(0.25,0.5,0.75), lty=2, color="gray40") +
  ggtitle("Project: WRI - Distribution of RLs and RVs for Chlorophyll")
```

```{r}
CHL1016_08 %>% filter(PROJ_grp == "WRI") %>%
  filter(!is.na(Filt.Vol)) %>% 
  filter(PARAM.X != "PHEO") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  mutate(Result_val = case_when(
    is.na(Non_Detect) &
      !is.na(x_RVal.conc) ~ x_RVal.conc,
    !is.na(Non_Detect) & Non_Detect == "U" &
      !is.na(LRL_c) ~ LRL_c,
    TRUE ~ as.numeric(NA))) %>%
  arrange(PARAM.X, Result_val) %>% group_by(PARAM.X) %>%
  mutate(RValue_rank = percent_rank(Result_val)) %>%
  ggplot(.) + theme_bw() + facet_grid(. ~ PARAM.X, scales="fixed") +
  geom_point(aes(x=Result_val, y=RValue_rank, col=Non_Detect), na.rm=T) +
  # EnvStats::stat_n_text() +
  labs(x="CHL conc. (ug/L)", y="Result_rank") +
  scale_x_continuous(trans="log10") +
  scale_y_continuous(labels = scales::percent) +
  ggtitle("Project: WRI - Distribution of RLs and RVs for Chlorophyll") +
  scale_color_discrete(name="Detection.Condition", labels=c("Not Detected", "Quantitated"))
```

***

### Bottom Line: REVW-Non-Detects (-blanks)

> Project `WRI` is sufficiently complete, no additional sample volumes are available or required.  However, up to 70% of CHLA_corrected records are as Non-Detects and results should be re-examined


***
***

## 9.0 2020-16 Chl data revw summary

+ ? Projects w/ `import_status` is "To_import"

```{r}
CHL1016_08 %>% {addmargins(table(.$PROJ_grp, .$import_status, useNA="ifany",
                                 deparse.level = 2))}
```

```{r}
CHL1016_08 %>% {addmargins(table(.$PROJ_grp, .$PARAM_status, useNA="ifany",
                                 deparse.level = 2))}
```

+ `PERI` parameters still need to be reviewed...

```{r}
CHL1016_08 %>% {addmargins(table(.$PROJ_grp, .$RECORD_STATUS, useNA="ifany",
                                 deparse.level = 2))} %>% 
  as.data.frame.table(.) %>% setNames(c("PROJ_grp", "RECORD_STATUS", "Freq")) %>%
  filter(Freq > 0) %>%
  spread(RECORD_STATUS, Freq) %>% 
  setNames(c("PROJ_grp", "REJ:Matrix", "REJ:NoVOL", "REVW_lrl", "REVW_mdl",
             "REVW_mdl+VOL","REVW_VOL",
             "Sum", "NA")) %>%
  select(-Sum, everything()) %>%
  htmlTable::htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.8em; padding-right: 0.8em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), align="rl|cc|cccc|c|r", total=T)
```

+ Some records still have problematic values in LRL/MDL (== 0)
  + If LRL or MDL == 0 : ==> change to `NA`
  + If LRL/MDL is `NA`, no LRL_c / MDL_c calculation allowed
  + If LRL_c / MDL_c are `NA`, RL_Units == `NA`

```{r}
CHL1016_08 %<>% mutate(
  MDL = case_when(
    MDL == 0 ~ as.numeric(NA),
    !is.na(MDL) ~ MDL,
    TRUE ~ as.numeric(NA)),
  MDL_c = case_when(
    MDL == 0 ~ as.numeric(NA),
    is.na(MDL) ~ as.numeric(NA),
    !is.na(MDL) & !is.na(Filt.Vol) & MDL != 0 ~ ((MDL*1000) / (Filt.Vol/1000)),
    !is.na(MDL_c) ~ MDL_c,
    TRUE ~ as.numeric(NA)),
  LRL = case_when(
    LRL == 0 ~ as.numeric(NA),
    !is.na(LRL) ~ LRL,
    TRUE ~ as.numeric(NA)),
  LRL_c = case_when(
    LRL == 0 ~ as.numeric(NA),
    !is.na(LRL) & !is.na(Filt.Vol) & LRL != 0 ~ ((LRL*1000) / (Filt.Vol/1000)),
    !is.na(LRL_c) ~ LRL_c,
    TRUE ~ as.numeric(NA))) %>%
  mutate(
  RL_Units = case_when(
    MethodID2 == "10200" & PARAM.X != "PERI" &
      (!is.na(LRL_c) | !is.na(MDL_c)) ~ "ug/L",
    !is.na(RL_Units) ~ RL_Units,
    TRUE ~ as.character(NA)),
  RECORD_STATUS = case_when(
    is.na(LRL_c) & 
      grepl("_lrl", .$RECORD_STATUS, ignore.case = T) &
      !grepl("_VOL", .$RECORD_STATUS, ignore.case = T) ~ as.character(NA),
    is.na(LRL_c) & 
      grepl("_lrl", .$RECORD_STATUS, ignore.case = T) &
      !grepl("_VOL", .$RECORD_STATUS, ignore.case = T) ~ "REVIEW_VOL",
    is.na(MDL_c) & 
      grepl("_mdl", .$RECORD_STATUS, ignore.case = T) &
      !grepl("_VOL", .$RECORD_STATUS, ignore.case = T) ~ as.character(NA),
    is.na(MDL_c) & 
      grepl("_mdl", .$RECORD_STATUS, ignore.case = T) &
      grepl("_VOL", .$RECORD_STATUS, ignore.case = T) ~ "REVIEW_VOL",
    !is.na(RECORD_STATUS) ~ RECORD_STATUS,
    TRUE ~ as.character(NA))
)
```


***
+ Update records w/ "REVIEW_VOL" to "REJECT_noVOL", since these have been reviewed now 4 times (at least)
  + **Except !!** for records w/ Sample.Date < Jan 2013 (_roughly_)

```{r}
CHL1016_08 %<>% mutate(
  RECORD_STATUS = case_when(
    RECORD_STATUS == "REVIEW_VOL" & x_SDate > as.Date("2013-01-01") &
      (x_Units.conc != "ug/L" | x_Units != "ug/L" | RL_Units != "ug/L") ~ "REJECT_noVOL",
    RECORD_STATUS == "REVIEW_VOL" & x_SDate < as.Date("2013-01-01") ~ as.character(NA),
    !is.na(RECORD_STATUS) ~ RECORD_STATUS,
    TRUE ~ as.character(NA)))
```


+ For records _"To import"_, what are `PARAM_status` and `RECORD_STATUS` ?

```{r}
CHL1016_08 %>% filter(!is.na(import_status)) %>%
  {addmargins(
    table(.$PROJ_grp, 
          paste(.$PARAM_status, .$RECORD_STATUS, sep="_"),
          useNA="ifany", deparse.level = 2,
          dnn=c("Project", "PARAM_REVIEW.status")))}
```

### 9.1 Annotate Records that need Result.Value _review_

1) `import_status` = "To_import"
2) `PARAM.X` != "PERI" (or MEthodID != "10300")
3) Also be careful of `MATRIX.X` = "BENTH", _since these records need further review, anyway_

```{r}
CHL1016_08 %<>% mutate(
  result_REVIEW = case_when(
    is.na(RECORD_STATUS) & is.na(PARAM_status) &
      !is.na(import_status) &
      x_Units == "mg" &
      !PARAM.X %in% c("PERI", "PHEO", "CHLB") &
      MethodID2 == "10200" & 
      MATRIX.X == "WC"  &
      (is.na(QC_type) | QC_type != "Blank") &
      !is.na(Filt.Vol) &
      !is.na(Non_Detect) &
      (between(x_SDate, as.Date("2012-10-01"), as.Date("2016-10-01"))) &
      LRL_c > 5 ~ "REVW:absorbnc",
    MATRIX.X == "BENTH" ~ "REVW:benthic",
    TRUE ~ as.character(NA))) %>%
  select(RECORD_STATUS:PARAM.X, result_REVIEW, everything())
# x_SDate >= as.Date("2012-10-01") &
         #x_SDate <= as.Date("2016-10-01")
```

+ Plus a couple manual corrections...

```{r}
CHL1016_08 %<>% mutate(
  LRL_c = case_when(
    PROJ_grp == "BOR" & LRL == 0.7 & x_Units == "mg" ~ 0.7,
    !is.na(LRL_c) ~ LRL_c,
    TRUE ~ as.numeric(NA)),
  x_Units = case_when(
    PROJ_grp == "BOR" & LRL == 0.7 & x_Units == "mg" ~ "ug/L",
    !is.na(x_Units) ~ x_Units,
    TRUE ~ as.character(NA))
)
```


+ Summary status

```{r}
CHL1016_08 %>% {addmargins(table(.$PROJ_grp, .$result_REVIEW,
                                 useNA="ifany", deparse.level = 2))}
```

```{r}
CHL1016_08 %>% {addmargins(table(.$PROJ_grp, .$Non_Detect,
                                 useNA="ifany", deparse.level = 2))}
```

#### FIG: Absorbance review records by project

```{r}
CHL1016_08 %>% filter(result_REVIEW == "REVW:absorbnc") %>%
  filter(!is.na(Filt.Vol) & PARAM.X != "PHEO" & MATRIX.X != "BENTH") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected")) %>%
  distinct(SKey2, PARAM.X, Non_Detect, .keep_all = T) %>%
  ggplot(., na.rm=T) + theme_bw() +
  geom_text(aes(x=factor(PROJ_grp), y=x_SDate, col=PROJ_grp), 
            na.rm=T, size=2.5, fontface="bold", label="U", 
            position=position_jitter(width=0.1, height=0.1), check_overlap = T) +
  scale_y_date(date_labels="%Y",date_breaks = "1 year",
               limits=c(as.Date("2013-01-01"), NA)) + 
  coord_flip() + 
  labs(x="Project Name", y="Sample Date", col="Project \nGroup",
       title="Records for Measurement Review")
```

```{r}
CHL1016_08 %>% filter(is.na(result_REVIEW) | result_REVIEW != "REVW:benthic") %>%
  {addmargins(table(.$result_REVIEW, .$Non_Detect,
                                 useNA="ifany", deparse.level = 2))}
```


```{r}
CHL1016_08 %>% 
  filter(is.na(RECORD_STATUS) & 
           is.na(PARAM_status) &
           !is.na(import_status) &
           !is.na(Filt.Vol) &
           !PARAM.X %in% c("PERI", "PHEO", "CHLB") &
           MATRIX.X == "WC" & 
           MethodID2 == "10200") %>%
  mutate(PARAM.X = recode(.$PARAM.X,
                          "CHLA.X" = "CHLA_total",
                          "CHLA.tot" = "CHLA_total",
                          "CHLA.aa" = "CHLA_corrected"),
         result_REVIEW = recode(.$result_REVIEW,
                                .default = "Review_Abs",
                                .missing="No Review Needed")) %>%
  filter(PARAM.X == "CHLA_corrected") %>%
  distinct(SKey2, PARAM.X, Non_Detect, .keep_all = T) %>%
  ggplot(., na.rm=T) + theme_bw() +
  geom_point(data=.data[[.data[["result_REVIEW"]] == "No Review Needed"]],
             aes(x=factor(PROJ_grp), y=x_SDate), shape=85, col="gray40", size=1.5,
             na.rm=T, position=position_jitter(width=0.09), alpha=0.5) +
  geom_text(data=.data[[.data[["result_REVIEW"]] == "review_Abs"]],
            aes(x=factor(PROJ_grp), y=x_SDate), label="o", col="red", size=3,
            fontface="bold", na.rm=T, 
            vjust=1.5) +
  scale_y_date(date_labels="%Y",date_breaks = "1 year",
               limits=c(as.Date("2013-01-01"), NA)) + 
  coord_flip() + 
  labs(x="Project Name", y="Sample Date", shape="Project \nGroup", col="Project \nGroup",
       title="Records for Measurement Review")
```

> **The grey "U"-shapes represent datapoints where the result was coded as "Non-Detect", while the red "o"-shapes identify recores where Absorbance data should be reviewed**


```{r}
CHL1016_08 %>% 
  filter(is.na(RECORD_STATUS)) %>%
  group_by(PROJ_grp) %>%
  summarize(Obs = n(),
            k_Obs = n_distinct(SKey2, na.rm=T),
            k_import = n_distinct(SKey2[!is.na(import_status)], na.rm=T),
            k_NonDet = n_distinct(SKey2[!is.na(import_status) & Non_Detect=="U"], na.rm=T),
            k_RevAbs = n_distinct(SKey2[!is.na(import_status) & Non_Detect=="U" &
                                          result_REVIEW == "REVW:absorbnc"], na.rm=T)) %>%
  mutate(
    p_import = case_when(
      k_import > 0 ~ sprintf("%.f%%", (k_import/k_Obs)*100),
      TRUE ~ as.character(NA)),
    p_NonDet = case_when(
      k_NonDet > 0 ~ sprintf("%.f%%", (k_NonDet/k_import)*100),
      TRUE ~ as.character(NA)),
    p_RevAbs = case_when(
      k_RevAbs > 0 ~ sprintf("%.f%%", (k_RevAbs/k_NonDet)*100),
      TRUE ~ as.character(NA))) %>%
  select(PROJ_grp, Obs, k_Obs, k_import, p_import, k_NonDet, p_NonDet,
         k_RevAbs, p_RevAbs, everything()) %>%
  htmlTable(., css.cell = rbind(rep("padding-left: 0.8em; padding-right: 0.8em;font-size: 0.75em;", times=ncol(.)+1), matrix("padding-left: 0.75em; padding-right: 0.75em; font-size: 0.75em;", ncol=ncol(.)+1, nrow=nrow(.))), total=F, caption="Record Completeness Counts by Project-Group", align="rl|cc|cc|cc|cc")
```


***
***

## NEW Notebook


## END
```{r}
# CHL1016_07 %>% select(contains("type", ignore.case = T)) %>% names(.)
# CHL1016_05 %>% {addmargins(table(.$PROJ_grp, .$RECORD_STATUS,
#                                  useNA="ifany", deparse.level = 2))}
# CHL1016_07 %>% distinct(RECORD_STATUS) %$% .$RECORD_STATUS
```

```{r}
# unique(CHL1016_08$RECORD_STATUS)
# unique(CHL1016_08$PARAM_status)
# unique(CHL1016_08$import_status)
# unique(CHL1016_08$QC_type)
# unique(CHL1016_08$PROJ_grp)
# unique(CHL1016_08$MethodID2)
# unique(CHL1016_08$PARAM.X)
# unique(CHL1016_08$MATRIX.X)
# unique(CHL1016_08$result_REVIEW)
# unique(CHL1016_08$Non_Detect)
```


``` {r CLOSEOUT}
lastwork.date <- format(Sys.Date(), "%y%m%d")
```


**Start work date ::**  `r startwork.date`  
**Last work date ::**  `r lastwork.date`  
**Current review date ::**  `r format(Sys.Date(), "%y%m%d")`

eof

***